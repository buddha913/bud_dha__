<!doctype html> 
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>X í¬ë¦¬ì—ì´í„° ë§ˆì¸ë“œì‰ì–´ ë¶„ì„ê¸° 5.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSV íŒŒì„œ -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- í”„ë¡œì íŠ¸ë³„ ì›í˜• ê·¸ë˜í”„ìš© -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- âœ… STEP 2ì—ì„œ ì´ ì•ˆì— CSS ì „ì²´ë¥¼ ë¶™ì—¬ ë„£ì–´ -->
  <style>
  html {
  scroll-behavior: smooth;
}

:root {
  --bg: #f3f7ff;
  --bg-soft: #f8fbff;
  --sidebar-bg: #ffffff;
  --card-bg: #ffffff;
  --card-soft: #f9fbff;
  --accent: #4f46e5;
  --accent-soft: #e0e7ff;
  --accent-2: #06b6d4;
  --accent-3: #22c55e;
  --text-main: #0f172a;
  --text-muted: #6b7280;
  --border-soft: rgba(148,163,184,.35);

  --grade-s: #f59e0b;
  --grade-a: #38bdf8;
  --grade-b: #22c55e;
  --grade-c: #a855f7;
  --grade-d: #9ca3af;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:
    radial-gradient(circle at 0% 0%, #e0f2fe, transparent 55%),
    radial-gradient(circle at 100% 0%, #ffe4f5, transparent 55%),
    linear-gradient(180deg,#eef4ff,#f9fafb);
  color:var(--text-main);
  min-height:100vh;
}

.layout{
  display:flex;
  min-height:100vh;
}

/* ========== SIDEBAR ========== */
.sidebar{
  width:230px;
  background:var(--sidebar-bg);
  backdrop-filter: blur(18px) saturate(160%);
  color:#111827;
  padding:20px 18px;
  display:flex;
  flex-direction:column;
  gap:24px;
  box-shadow: 10px 0 35px rgba(148,163,184,.45);
  position:relative;
  transition:width .2s ease;
  overflow:hidden;
  border-right:1px solid rgba(209,213,219,.9);
}

.sidebar-toggle{
  position:absolute;
  top:14px;
  right:12px;
  width:26px;
  height:26px;
  border-radius:999px;
  border:none;
  background:linear-gradient(135deg,#4f46e5,#06b6d4);
  color:#f9fafb;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  cursor:pointer;
  box-shadow:0 10px 24px rgba(79,70,229,.65);
  z-index:10;
}

.side-profile{
  display:flex;
  gap:12px;
  align-items:center;
  margin-top:18px;
}
.side-avatar{
  width:44px;height:44px;
  border-radius:999px;
  border:2px solid rgba(248,250,252,.9);
  overflow:hidden;
  box-shadow:0 8px 18px rgba(148,163,184,.7);
}
.side-avatar img{width:100%;height:100%;object-fit:cover}
.side-name{font-size:15px;font-weight:700;}
.side-handle{
  font-size:12px;color:#6b7280;
  text-decoration:none;
}

.side-nav{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-top:12px;
}
.side-nav-item{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:12px;
  font-size:13px;
  color:#4b5563;
  cursor:pointer;
  text-decoration:none;
  transition:background .15s ease, transform .1s ease, box-shadow .15s ease;
}
.side-nav-item:hover{
  background:rgba(191,219,254,.6);
  transform:translateX(2px);
  box-shadow:0 6px 16px rgba(148,163,184,.4);
}
.side-nav-item span.icon{
  width:20px;height:20px;
  border-radius:9px;
  background:linear-gradient(135deg,#e0f2fe,#e5e7eb);
  display:flex;align-items:center;justify-content:center;
  font-size:12px;
  flex-shrink:0;
}
.side-label{
  white-space:nowrap;
}
.side-nav-item.active{
  background:linear-gradient(135deg,#4f46e5,#06b6d4);
  color:#f9fafb;
  box-shadow:0 10px 24px rgba(79,70,229,.7);
}
.side-nav-item.active span.icon{
  background:rgba(15,23,42,.9);
  color:#e5e7eb;
}

.side-footer{
  margin-top:auto;
  font-size:11px;
  color:#9ca3af;
}
.side-badge{
  margin-top:6px;
  padding:8px 10px;
  border-radius:14px;
  background:radial-gradient(circle at 0% 0%,#4f46e5,#06b6d4);
  font-size:12px;
  color:#f9fafb;
  text-align:left;
  box-shadow:0 14px 28px rgba(15,23,42,.65);
}

/* ========== SIDEBAR COLLAPSE ========== */
.layout.collapsed .sidebar{
  width:70px;
}
.layout.collapsed .side-name,
.layout.collapsed .side-handle,
.layout.collapsed .side-label,
.layout.collapsed .side-footer{
  display:none;
}
.layout.collapsed .side-profile{
  justify-content:center;
}
.layout.collapsed .sidebar-toggle{
  transform:rotate(180deg);
}

/* ========== MAIN AREA ========== */
.main{
  flex:1;
  padding:20px 24px 32px;
  max-width:calc(100vw - 230px);
  overflow-x:hidden;
  transition:max-width .2s ease;
}
.layout.collapsed .main{
  max-width:calc(100vw - 70px);
}

.top-nav{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
  flex-wrap:wrap;
  gap:8px;
}
.top-title{
  font-size:20px;
  font-weight:800;
}
.top-sub{
  font-size:12px;
  color:var(--text-muted);
}
.top-cta{
  display:flex;
  gap:8px;
  align-items:center;
}
.top-link{
  font-size:12px;
  padding:7px 12px;
  border-radius:999px;
  border:1px solid #c7d2fe;
  background:var(--card-soft);
  color:var(--accent);
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  gap:6px;
}

/* HERO */
.hero-card{
  background:
    radial-gradient(circle at 0% 0%, #c7d2fe, transparent 45%),
    radial-gradient(circle at 100% 0%, #a5f3fc, transparent 45%),
    linear-gradient(135deg,#f9fafb,#eef2ff);
  border-radius:24px;
  padding:18px 18px 16px;
  border:1px solid rgba(191,219,254,.9);
  display:flex;
  flex-direction:column;
  gap:10px;
  box-shadow:0 22px 45px rgba(148,163,184,.45);
}
.hero-top-row{
  display:flex;
  justify-content:space-between;
  gap:12px;
  align-items:flex-start;
  flex-wrap:wrap;
}
.hero-main-title{
  font-size:17px;
  font-weight:800;
  color:#111827;
}
.hero-desc{
  font-size:12px;
  color:#4b5563;
  margin-top:4px;
  line-height:1.4;
}
.hero-pill{
  font-size:11px;
  padding:5px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.95);
  border:1px solid rgba(148,163,184,.5);
  display:inline-flex;
  align-items:center;
  gap:6px;
  margin-top:6px;
}
.hero-dot{
  width:8px;height:8px;border-radius:999px;
  background:#22c55e;
  box-shadow:0 0 0 5px rgba(34,197,94,.2);
}

.hero-upload-row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  margin-top:4px;
}
.file-input-wrap{position:relative;display:inline-block;overflow:hidden}
.file-input-wrap input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer}
.file-input-fake{
  padding:8px 14px;border-radius:999px;border:1px solid rgba(148,163,184,.7);
  font-size:12px;display:inline-flex;align-items:center;gap:8px;
  background:rgba(255,255,255,.95);cursor:pointer;white-space:nowrap;
  color:#111827;
}
.file-hint{font-size:11px;color:#4b5563}

.range-tabs{
  margin-top:10px;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
.range-tab{
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  border:1px solid rgba(148,163,184,.7);
  background:rgba(255,255,255,.9);
  color:#4b5563;
  cursor:pointer;
  transition:background .15s ease, transform .1s ease;
}
.range-tab:hover{
  transform:translateY(-1px);
}
.range-tab.active{
  background:linear-gradient(135deg,#4f46e5,#06b6d4);
  border-color:transparent;
  color:#f9fafb;
}

.badge{
  display:inline-flex;gap:6px;padding:4px 9px;border-radius:999px;
  border:1px solid rgba(148,163,184,.6);font-size:11px;color:#4b5563;
  background:rgba(255,255,255,.85);margin-top:2px;
}
.badge-dot{width:7px;height:7px;border-radius:999px;background:#a5b4fc}

.error{color:#ef4444;font-size:12px;margin-top:4px}

/* GRID (ëŒ€ì‹œë³´ë“œ) */
.grid-1{
  margin-top:18px;
  display:grid;
  grid-template-columns:2.2fr 1.4fr;
  gap:16px;
  align-items:flex-start;
}

.column-main{
  display:flex;
  flex-direction:column;
  gap:16px;
}
.column-side{
  display:flex;
  flex-direction:column;
  gap:16px;
}

.card{
  border-radius:18px;
  background:var(--card-bg);
  border:1px solid rgba(203,213,225,.8);
  padding:14px 14px 16px;
  box-shadow:0 10px 25px rgba(148,163,184,.25);
}
.card-soft{
  background:var(--card-soft);
}

.summary-grid{
  display:grid;
  grid-template-columns:repeat(4,minmax(0,1fr));
  gap:10px;
  margin-top:10px;
}

@media (max-width:1100px){
  .grid-1{
    grid-template-columns:1fr;
  }
}

@media (max-width:960px){
  .layout{flex-direction:column;}
  .sidebar{
    width:100%;
    flex-direction:row;
    align-items:center;
    justify-content:space-between;
  }
  .layout.collapsed .sidebar{width:100%;}
  .main{
    max-width:100%;
    padding:16px;
  }
  .summary-grid{
    grid-template-columns:repeat(2,minmax(0,1fr));
  }
}
@media (max-width:640px){
  .summary-grid{
    grid-template-columns:1fr;
  }
}

.summary-card{
  border-radius:14px;padding:10px 10px;font-size:11px;
  border:1px solid rgba(226,232,240,0.9);
  background:
    radial-gradient(circle at top left,#eef2ff,transparent 60%),
    #ffffff;
}
.summary-label{color:var(--text-muted);margin-bottom:4px}
.summary-value{font-size:16px;font-weight:700}
.summary-sub{font-size:10px;color:var(--text-muted);margin-top:1px}

.section-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  margin-bottom:10px;
  gap:8px;
}
.section-title{
  font-size:14px;
  font-weight:700;
  display:flex;
  gap:6px;
  align-items:center;
}
.section-sub{
  font-size:11px;
  color:var(--text-muted);
}

.grade-legend{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  font-size:10px;
  color:var(--text-muted);
}
.grade-dot{width:8px;height:8px;border-radius:999px}
.grade-dot.s{background:var(--grade-s)}
.grade-dot.a{background:var(--grade-a)}
.grade-dot.b{background:var(--grade-b)}
.grade-dot.c{background:var(--grade-c)}
.grade-dot.d{background:var(--grade-d)}

.grade-tabs{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  margin-bottom:10px;
}
.grade-tab{
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  border:1px solid rgba(209,213,219,.9);
  background:#ffffff;
  color:var(--text-muted);
  cursor:pointer;
  display:flex;
  gap:6px;
  align-items:center;
  transition:background .15s ease, transform .1s ease;
}
.grade-tab:hover{
  transform:translateY(-1px);
}
.grade-tab-dot{width:8px;height:8px;border-radius:999px}
.grade-tab.active{
  background:linear-gradient(135deg,#4f46e5,#06b6d4);
  color:#f9fafb;
  border-color:transparent;
}

.table-wrap{
  width:100%;overflow:auto;border-radius:14px;
  border:1px solid rgba(226,232,240,.9);
  background:#ffffff;
}
table{width:100%;border-collapse:collapse;min-width:680px;font-size:11px}
th,td{padding:8px;border-bottom:1px solid rgba(226,232,240,1);vertical-align:top}
th{
  background:#f8fafc;
  color:#6b7280;
  text-transform:uppercase;
  font-size:10px;
  position:sticky;top:0;z-index:1;
}
tr:last-child td{border-bottom:none}
tbody tr:hover td{background:#f9fafb}

.grade-badge{
  display:inline-flex;min-width:24px;padding:3px 7px;border-radius:999px;
  font-size:11px;font-weight:700;justify-content:center;
}
.grade-badge.s{background:rgba(251,191,36,.12);border:1px solid rgba(251,191,36,.8);color:var(--grade-s)}
.grade-badge.a{background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.8);color:var(--grade-a)}
.grade-badge.b{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.8);color:var(--grade-b)}
.grade-badge.c{background:rgba(168,85,247,.12);border:1px solid rgba(168,85,247,.8);color:var(--grade-c)}
.grade-badge.d{background:rgba(148,163,184,.16);border:1px solid rgba(148,163,184,1);color:var(--grade-d)}

.stat-chip{
  display:inline-flex;gap:3px;font-size:10px;color:var(--text-muted);
  padding:2px 6px;border-radius:999px;border:1px solid rgba(209,213,219,1);
  background:#f9fafb;
}
.stat-chip strong{color:#111827}
.link-pill{
  padding:3px 7px;border-radius:999px;font-size:10px;
  border:1px solid rgba(59,130,246,.9);
  background:rgba(239,246,255,1);color:#1d4ed8;text-decoration:none;
  white-space:nowrap;
}

.leader-input-row{
  margin-bottom:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;
}
.leader-input{
  flex:1;min-width:200px;
  border-radius:999px;border:1px solid rgba(209,213,219,1);
  background:#ffffff;color:#111827;
  padding:8px 14px;font-size:12px;
}
.leader-btn{
  border-radius:999px;border:none;
  background:linear-gradient(135deg,#4f46e5,#06b6d4);
  color:white;font-size:12px;padding:8px 16px;
  cursor:pointer;font-weight:600;
  box-shadow:0 10px 22px rgba(79,70,229,.45);
}
.leader-btn:disabled{opacity:.5;cursor:default}
.leader-note{font-size:11px;color:var(--text-muted);margin-top:2px}
.empty{font-size:12px;color:var(--text-muted);padding:8px 4px;text-align:center}

.text-main{font-size:11px;}
.text-meta{font-size:10px;color:var(--text-muted);margin-top:2px;}
.grade-chip{font-size:11px;color:var(--text-muted);}

.sort-select{
  border-radius:999px;
  border:1px solid rgba(209,213,219,1);
  background:#ffffff;
  color:#374151;
  font-size:11px;
  padding:4px 8px;
}

/* í”„ë¡œì íŠ¸ ë·° ì¶”ê°€ ìŠ¤íƒ€ì¼ */
.project-chart-wrap{
  width:100%;
  max-width:420px;
  margin:0 auto 12px;
}
.project-detail-controls{
  margin-top:14px;
  margin-bottom:8px;
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
  font-size:12px;
}
.project-select{
  border-radius:999px;
  border:1px solid rgba(209,213,219,1);
  background:#ffffff;
  padding:6px 10px;
  font-size:12px;
}

/* ì½”ì¹˜ ë´‡ ì¹´ë“œ */
.bot-card{
  background:
    radial-gradient(circle at 0% 0%, #e0f2fe, transparent 55%),
    radial-gradient(circle at 100% 0%, #ddd6fe, transparent 55%),
    #ffffff;
  position:relative;
  overflow:hidden;
}
.bot-chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 9px;
  border-radius:999px;
  font-size:11px;
  background:rgba(15,23,42,.05);
  border:1px solid rgba(148,163,184,.5);
  margin-bottom:6px;
}
.bot-output{
  font-size:11px;
  color:#111827;
  line-height:1.5;
  white-space:pre-line;
}
.bot-hint{
  font-size:10px;
  color:var(--text-muted);
  margin-top:6px;
}
  </style>
</head>

<body>
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <button id="sidebar-toggle" class="sidebar-toggle">âŸ¨</button>

    <div>
      <div class="side-profile">
        <div class="side-avatar">
          <img src="https://unavatar.io/twitter/bud_dha__" alt="avatar">
        </div>
        <div>
          <div class="side-name">ğŸ§˜â€â™‚ï¸ ë¶“ë‹¤</div>
          <a href="https://twitter.com/bud_dha__" target="_blank" class="side-handle">@bud_dha__ â†—</a>
        </div>
      </div>

      <div class="side-nav">
        <div class="side-nav-item active" data-view="dashboard">
          <span class="icon">ğŸ“Š</span><span class="side-label">Dashboard</span>
        </div>
        <div class="side-nav-item" data-view="leaderboard">
          <span class="icon">ğŸ†</span><span class="side-label">ë¦¬ë”ë³´ë“œ</span>
        </div>
        <div class="side-nav-item" data-view="projects">
          <span class="icon">ğŸ“š</span><span class="side-label">í”„ë¡œì íŠ¸ë³„ ë§ˆì¸ë“œì‰ì–´</span>
        </div>
        <a class="side-nav-item" href="https://buddha913.github.io/crypto-fullcourse/" target="_blank">
          <span class="icon">ğŸ“˜</span><span class="side-label">í¬ë¦½í†  í’€ì½”ìŠ¤</span>
        </a>
      </div>
    </div>

    <div class="side-footer">
      InfoFi Creator Console (Beta)
      <div class="side-badge">
        ì˜¤ëŠ˜ë„ í•œ ë²ˆ<br>ë§ˆì‰ í„°íŠ¸ë ¤ë³¼ê¹Œ? ğŸ’¥
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- â–¼â–¼ Dashboard í™”ë©´ â–¼â–¼ -->
    <div id="view-dashboard">
      <div class="top-nav">
        <div>
          <div class="top-title">X í¬ë¦¬ì—ì´í„° ë§ˆì¸ë“œì‰ì–´ ë¶„ì„ê¸°</div>
          <div class="top-sub">ì• ë„ë¦¬í‹±ìŠ¤ CSVë¡œ ë‚´ ê³„ì •ì˜ ì§„ì§œ ì„íŒ©íŠ¸ë¥¼ ë³´ëŠ” ëŒ€ì‹œë³´ë“œ</div>
        </div>
        <div class="top-cta">
          <a class="top-link" href="https://analytics.twitter.com/user" target="_blank">
            X ì• ë„ë¦¬í‹±ìŠ¤ ì—´ê¸° â†—
          </a>
        </div>
      </div>

      <!-- HERO -->
      <section class="hero-card">
        <div class="hero-top-row">
          <div>
            <div class="hero-main-title">ë§ˆì¸ë“œì‰ì–´ ìŠ¤ì½”ì–´ Â· S~D ë“±ê¸‰ Â· ë¦¬ë”ë³´ë“œê¹Œì§€ í•œ ë²ˆì—</div>
            <div class="hero-desc">
              X ì• ë„ë¦¬í‹±ìŠ¤ì—ì„œ CSVë¥¼ ë‚´ë ¤ë°›ê³  ì´ê³³ì— ì—…ë¡œë“œí•˜ë©´,<br>
              ì›ê¸€ ê¸°ì¤€ìœ¼ë¡œ ë§ˆì¸ë“œì‰ì–´ ì ìˆ˜ì™€ ìƒìœ„ ê¸€, ë¦¬ë”ë³´ë“œê¹Œì§€ í•œ ë²ˆì— ë¶„ì„í•  ìˆ˜ ìˆì–´.
            </div>
            <div class="hero-pill"><span class="hero-dot"></span> CSV í•œ ë²ˆ â†’ ê³„ì • ë¶„ì„ ë</div>
          </div>
        </div>

        <div class="hero-upload-row">
          <div class="file-input-wrap">
            <div class="file-input-fake">ğŸ“ CSV íŒŒì¼ ì„ íƒí•˜ê¸°</div>
            <input type="file" id="csvInput" accept=".csv"/>
          </div>
          <span class="file-hint">account_analytics_content_YYYY-MM-DD_YYYY-MM-DD.csv ê·¸ëŒ€ë¡œ ì—…ë¡œë“œ</span>
        </div>

        <div class="badge"><span class="badge-dot"></span>í•œêµ­ì–´/ì˜ì–´ CSV ìë™ ì¸ì‹ Â· ë‹µê¸€ ì œì™¸ í›„ ì›ê¸€ë§Œ ë¶„ì„</div>

        <div id="range-tabs" class="range-tabs" style="display:none">
          <button class="range-tab active" data-range="ALL">ì „ì²´ ê¸°ê°„</button>
          <button class="range-tab" data-range="7">ìµœê·¼ 7ì¼</button>
          <button class="range-tab" data-range="30">ìµœê·¼ 30ì¼</button>
          <button class="range-tab" data-range="90">ìµœê·¼ 90ì¼</button>
        </div>

        <div id="summary" class="summary-grid" style="display:none"></div>
        <div id="error" class="error"></div>
      </section>

      <!-- ë©”ì¸ ê·¸ë¦¬ë“œ: ì™¼ìª½(í‘œ), ì˜¤ë¥¸ìª½(ë´‡/ìš”ì•½) -->
      <div class="grid-1">
        <div class="column-main">
          <section class="card">
            <div class="section-header">
              <div class="section-title">
                ğŸ’¥ ë§ˆì¸ë“œì‰ì–´ í­ë°œ Top 10 <span id="top10-count"></span>
              </div>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <div class="grade-chip">ì ìˆ˜ ê¸°ì¤€ Â· <strong>ë§ˆì¸ë“œì‰ì–´ ìŠ¤ì½”ì–´</strong></div>
                <select id="sort-key" class="sort-select">
                  <option value="score">ì •ë ¬: ìŠ¤ì½”ì–´</option>
                  <option value="impressions">ì •ë ¬: ë…¸ì¶œìˆ˜</option>
                  <option value="engagements">ì •ë ¬: ì°¸ì—¬ìˆ˜</option>
                  <option value="bookmarks">ì •ë ¬: ë¶ë§ˆí¬</option>
                  <option value="newFollows">ì •ë ¬: ì‹ ê·œ íŒ”ë¡œìš°</option>
                </select>
              </div>
            </div>
            <div class="table-wrap" id="top10-table-wrap"></div>
          </section>

          <section class="card">
            <div class="section-header">
              <div class="section-title">ğŸš ë“±ê¸‰ë³„ ìƒìœ„ ê²Œì‹œê¸€ <span>(S~D)</span></div>
              <div class="grade-legend">
                <span><span class="grade-dot s"></span>S ìƒìœ„ 5%</span>
                <span><span class="grade-dot a"></span>A ìƒìœ„ 20%</span>
                <span><span class="grade-dot b"></span>B ìƒìœ„ 40%</span>
                <span><span class="grade-dot c"></span>C ìƒìœ„ 60%</span>
                <span><span class="grade-dot d"></span>D ê·¸ ì™¸</span>
              </div>
            </div>

            <div class="grade-tabs">
              <button class="grade-tab active" data-grade="ALL"><span class="grade-tab-dot" style="background:linear-gradient(90deg,var(--grade-s),var(--grade-a),var(--grade-b))"></span>ì „ì²´</button>
              <button class="grade-tab" data-grade="S"><span class="grade-tab-dot" style="background:var(--grade-s)"></span>S ë“±ê¸‰</button>
              <button class="grade-tab" data-grade="A"><span class="grade-tab-dot" style="background:var(--grade-a)"></span>A ë“±ê¸‰</button>
              <button class="grade-tab" data-grade="B"><span class="grade-tab-dot" style="background:var(--grade-b)"></span>B ë“±ê¸‰</button>
              <button class="grade-tab" data-grade="C"><span class="grade-tab-dot" style="background:var(--grade-c)"></span>C ë“±ê¸‰</button>
              <button class="grade-tab" data-grade="D"><span class="grade-tab-dot" style="background:var(--grade-d)"></span>D ë“±ê¸‰</button>
            </div>

            <div class="table-wrap" id="grade-table-wrap"></div>
          </section>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì½”ì¹˜ ë´‡ -->
        <div class="column-side">
          <section class="card bot-card">
            <div class="section-header">
              <div class="section-title">ğŸ¤– ë§ˆì¸ë“œì‰ì–´ ì½”ì¹˜ ë´‡ <span style="font-size:11px;color:var(--text-muted);">(Beta)</span></div>
            </div>
            <div class="bot-chip">
              <span>ğŸ“Œ</span><span>í˜„ì¬ ì„ íƒí•œ ê¸°ê°„ ê¸°ì¤€ í•œ ì¤„ ìš”ì•½ + í”¼ë“œë°±</span>
            </div>
            <div id="coach-output" class="bot-output">
              ì•„ì§ CSVë¥¼ ì˜¬ë¦¬ì§€ ì•Šì•˜ì–´.<br>
              ìƒë‹¨ì—ì„œ ì• ë„ë¦¬í‹±ìŠ¤ CSVë¥¼ ì—…ë¡œë“œí•˜ê³  ê¸°ê°„ íƒ­(ì „ì²´/7/30/90ì¼)ì„ ë°”ê¾¸ë©´<br>
              ì´ êµ¬ê°„ì˜ ë§ˆì¸ë“œì‰ì–´ ìƒíƒœë¥¼ ì½”ì¹˜ ë´‡ì´ ìë™ìœ¼ë¡œ ìš”ì•½í•´ ì¤„ ê±°ì•¼.
            </div>
            <div class="bot-hint">
              * ì„œë²„/LLM í˜¸ì¶œ ì—†ì´, ë‚´ ì• ë„ë¦¬í‹±ìŠ¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê·œì¹™ì ìœ¼ë¡œ ìš”ì•½í•´ ì£¼ëŠ” ì˜¤í”„ë¼ì¸ ì½”ì¹˜ì•¼.
            </div>
          </section>
        </div>
      </div>
    </div>
    <!-- â–²â–² Dashboard ë â–²â–² -->


    <!-- â–¼â–¼ ë¦¬ë”ë³´ë“œ í™”ë©´ â–¼â–¼ -->
    <div id="view-leaderboard" style="display:none;">
      <div class="top-nav">
        <div>
          <div class="top-title">í¬ë¦¬ì—ì´í„° ë§ˆì¸ë“œì‰ì–´ ë¦¬ë”ë³´ë“œ</div>
          <div class="top-sub">ë‚´ ìˆœìœ„ Â· íŠ¸ë¦¼ë“œ í‰ê·  Â· ëŒ€í‘œ íŠ¸ìœ—ì„ í•œ ëˆˆì— ë³´ëŠ” ë­í‚¹ ë³´ë“œ</div>
        </div>
      </div>

      <section id="leaderboard-section" class="card" style="margin-top:8px;">
        <div class="section-header">
          <div class="section-title">ğŸ† í¬ë¦¬ì—ì´í„° ë§ˆì¸ë“œì‰ì–´ ë¦¬ë”ë³´ë“œ (Beta)</div>
        </div>

        <div class="leader-input-row">
          <input id="leader-handle" class="leader-input" placeholder="X í•¸ë“¤ ì…ë ¥ (ì˜ˆ: @bud_dha__)" />
          <button id="leader-save-btn" class="leader-btn">í˜„ì¬ ë¶„ì„ ê²°ê³¼ ì €ì¥</button>
        </div>
        <div class="leader-note">â€» ìµœì†Œ ì›ê¸€ ìˆ˜ 20ê°œ ì´ìƒì¼ ë•Œ ë¦¬ë”ë³´ë“œ ì ìˆ˜ê°€ ë” ì •í™•í•©ë‹ˆë‹¤.</div>

        <div id="my-rank-wrap" style="margin-top:10px"></div>
        <div class="table-wrap" id="leaderboard-wrap" style="margin-top:10px"></div>
      </section>
    </div>
    <!-- â–²â–² ë¦¬ë”ë³´ë“œ í™”ë©´ ë â–²â–² -->

    <!-- â–¼â–¼ í”„ë¡œì íŠ¸ë³„ ë§ˆì¸ë“œì‰ì–´ í™”ë©´ â–¼â–¼ -->
    <div id="view-projects" style="display:none;">
      <div class="top-nav">
        <div>
          <div class="top-title">í”„ë¡œì íŠ¸ë³„ ë§ˆì¸ë“œì‰ì–´</div>
          <div class="top-sub">íŠ¸ìœ— ë³¸ë¬¸ í‚¤ì›Œë“œ ê¸°ì¤€ìœ¼ë¡œ í”„ë¡œì íŠ¸ë³„ ì„íŒ©íŠ¸ì™€ ê²Œì‹œê¸€/ë“±ê¸‰ì„ ë¶„ì„í•©ë‹ˆë‹¤.</div>
        </div>
      </div>

      <section class="card card-soft">
        <div class="section-header">
          <div class="section-title">ğŸ“š í”„ë¡œì íŠ¸ ìš”ì•½ + ì›í˜• ê·¸ë˜í”„</div>
          <div class="section-sub">ì½”ë“œ ìƒë‹¨ <code>PROJECTS</code> ë°°ì—´ì˜ í‚¤ì›Œë“œë¥¼ ë„¤ê°€ íŠ¸ëŠ” í”„ë¡œì íŠ¸ì— ë§ê²Œ ë°”ê¿”ì¤˜.</div>
        </div>

        <div class="project-chart-wrap">
          <canvas id="project-pie" height="160"></canvas>
        </div>

        <div class="table-wrap" id="project-summary-wrap">
          <div class="empty">ë¨¼ì € Dashboardì—ì„œ CSVë¥¼ ì—…ë¡œë“œí•˜ê³  ë¶„ì„ì„ í•œ ë²ˆ ëŒë ¤ì¤˜.</div>
        </div>

        <div class="project-detail-controls">
          <span>ğŸ” í”„ë¡œì íŠ¸ë³„ ê²Œì‹œê¸€ ë³´ê¸°</span>
          <select id="project-select" class="project-select">
            <option value="">CSV ì—…ë¡œë“œ í›„ ìë™ í™œì„±í™”ë©ë‹ˆë‹¤.</option>
          </select>
        </div>
        <div class="table-wrap" id="project-detail-wrap">
          <div class="empty">í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ í”„ë¡œì íŠ¸ì˜ ê²Œì‹œê¸€ê³¼ ë“±ê¸‰ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
      </section>
    </div>
    <!-- â–²â–² í”„ë¡œì íŠ¸ í™”ë©´ ë â–²â–² -->

  </main>
</div>

<!-- âœ… STEP 3ì—ì„œ ì´ ì•ˆì— JS ì „ì²´ë¥¼ ë¶™ì—¬ ë„£ì–´ -->
<script>
/* ========= ì„¤ì • ========= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw0yJIOdUoeRNwMn9fys-5ePI6UX6wkqBVhWNLrZ-gomO1sGNgTUJbhO0Kfj0n2QgdC/exec";
const MIN_POSTS_FOR_LEADERBOARD = 20;
const TRIM_RATIO = 0.1;

/* í”„ë¡œì íŠ¸ í‚¤ì›Œë“œ (ì›í•˜ë©´ ì—¬ê¸° ìˆ˜ì •) */
/* í”„ë¡œì íŠ¸ í‚¤ì›Œë“œ (ì´ë¯¸ì§€ì— ë‚˜ì˜¨ í”„ë¡œì íŠ¸ + ì£¼ìš” ì•¼í•‘ í”„ë¡œì íŠ¸) */
const PROJECTS = [
  // --- L0 / L1 ---
  { id: "aptos",       label: "Aptos",                  category: "L0/L1", keywords: ["aptos"] },
  { id: "beldex",      label: "Beldex",                 category: "L0/L1", keywords: ["beldex"] },
  { id: "berachain",   label: "Berachain",              category: "L0/L1", keywords: ["berachain"] },
  { id: "camp",        label: "Camp Network",           category: "L0/L1", keywords: ["camp network","campnet"] },
  { id: "ethereum",    label: "Ethereum",               category: "L0/L1", keywords: ["ethereum","eth "] },
  { id: "fogo",        label: "Fogo",                   category: "L0/L1", keywords: ["fogo"] },
  { id: "injective",   label: "Injective",              category: "L0/L1", keywords: ["injective","inj "] },
  { id: "irys",        label: "Irys",                   category: "L0/L1", keywords: ["irys"] },
  { id: "kaia",        label: "Kaia",                   category: "L0/L1", keywords: ["kaia"] },
  { id: "mantra",      label: "MANTRA",                 category: "L0/L1", keywords: ["mantra"] },
  { id: "mavryk",      label: "Mavryk",                 category: "L0/L1", keywords: ["mavryk"] },
  { id: "mitosis",     label: "Mitosis",                category: "L0/L1", keywords: ["mitosis"] },
  { id: "monad",       label: "Monad",                  category: "L0/L1", keywords: ["monad"] },
  { id: "movement",    label: "Movement",               category: "L0/L1", keywords: ["movement"] },
  { id: "near",        label: "Near",                   category: "L0/L1", keywords: ["near"] },
  { id: "peaq",        label: "PEAQ",                   category: "L0/L1", keywords: ["peaq"] },
  { id: "polkadot",    label: "Polkadot",               category: "L0/L1", keywords: ["polkadot","dot "] },
  { id: "sei",         label: "Sei",                    category: "L0/L1", keywords: ["sei "] },
  { id: "somnia",      label: "Somnia",                 category: "L0/L1", keywords: ["somnia"] },
  { id: "sonic",       label: "Sonic (L1)",             category: "L0/L1", keywords: ["sonic chain","sonic l1","sonic mainnet"] },
  { id: "story",       label: "Story",                  category: "L0/L1", keywords: ["story protocol","story chain"] },
  { id: "xion",        label: "XION",                   category: "L0/L1", keywords: ["xion"] },

  // --- L2 ---
  { id: "arbitrum",    label: "Arbitrum",               category: "L2",    keywords: ["arbitrum","arb "] },
  { id: "katana",      label: "Katana",                 category: "L2",    keywords: ["katana"] },
  { id: "mantle",      label: "Mantle",                 category: "L2",    keywords: ["mantle"] },
  { id: "megaeth",     label: "MegaETH",                category: "L2",    keywords: ["megaeth"] },
  { id: "polygon",     label: "Polygon",                category: "L2",    keywords: ["polygon","matic"] },
  { id: "soon",        label: "SOON",                   category: "L2",    keywords: ["soon network","soon chain"] },

  // --- DeFi / Infra ---
  { id: "falcon",      label: "Falcon Finance",         category: "DeFi",  keywords: ["falcon finance","falconfi"] },
  { id: "frax",        label: "Frax",                   category: "DeFi",  keywords: ["frax"] },
  { id: "huma",        label: "Huma",                   category: "DeFi",  keywords: ["huma"] },
  { id: "moremarkets", label: "MoreMarkets",            category: "DeFi",  keywords: ["moremarkets","more markets"] },
  { id: "multipli",    label: "Multipli",               category: "DeFi",  keywords: ["multipli"] },
  { id: "noble",       label: "Noble",                  category: "DeFi",  keywords: ["noble chain","noble network"] },
  { id: "orderly",     label: "Orderly",                category: "DeFi",  keywords: ["orderly","orderly network","orderly omni"] },
  { id: "pyth",        label: "Pyth",                   category: "DeFi",  keywords: ["pyth oracle","pyth network"] },
  { id: "soul",        label: "Soul Protocol",          category: "DeFi",  keywords: ["soul protocol"] },
  { id: "stbl",        label: "STBL",                   category: "DeFi",  keywords: ["stbl","usst","yld","stablecoin 2.0"] },
  { id: "turtle",      label: "Turtle Club",            category: "DeFi",  keywords: ["turtle club"] },
  { id: "walrus",      label: "Walrus",                 category: "DeFi",  keywords: ["walrus"] },

  // --- AI Agents / Agent Infra ---
  { id: "creatorbid",  label: "CreatorBid",             category: "AI Agents", keywords: ["creatorbid"] },
  { id: "infinit",     label: "INFINIT",                category: "AI Agents", keywords: ["infinit"] },
  { id: "newton",      label: "Newton",                 category: "AI Agents", keywords: ["newton ai"] },
  { id: "surf",        label: "Surf",                   category: "AI Agents", keywords: ["surf ai","surf agent"] },
  { id: "symphony",    label: "Symphony",               category: "AI Agents", keywords: ["symphony","symphony finance","symphony router"] },
  { id: "talus",       label: "Talus",                  category: "AI Agents", keywords: ["talus"] },
  { id: "theoriq",     label: "Theoriq",                category: "AI Agents", keywords: ["theoriq"] },
  { id: "virtuals",    label: "Virtuals Protocol",      category: "AI Agents", keywords: ["virtuals","virtuals protocol"] },
  { id: "warden",      label: "Warden Protocol",        category: "AI Agents", keywords: ["warden protocol"] },
  { id: "wayfinder",   label: "Wayfinder",              category: "AI Agents", keywords: ["wayfinder"] },

  // --- Culture / NFT ---
  { id: "anime",       label: "ANIME",                  category: "Culture", keywords: ["anime token","anime protocol"] },
  { id: "boop",        label: "Boop",                   category: "Culture", keywords: ["boop"] },
  { id: "doodles",     label: "Doodles",                category: "Culture", keywords: ["doodles"] },
  { id: "memex",       label: "MemeX",                  category: "Culture", keywords: ["memex"] },
  { id: "moonbirds",   label: "Moonbirds",              category: "Culture", keywords: ["moonbirds"] },
  { id: "pengu",       label: "PENGU",                  category: "Culture", keywords: ["pengu"] },

  // --- BTCFi ---
  { id: "corn",        label: "Corn",                   category: "BTCFi",  keywords: ["corn"] },
  { id: "goat",        label: "GOAT Network",           category: "BTCFi",  keywords: ["goat network"] },
  { id: "lombard",     label: "Lombard",                category: "BTCFi",  keywords: ["lombard"] },
  { id: "portalbtc",   label: "Portal to BTC",          category: "BTCFi",  keywords: ["portal to btc","portal btc"] },
  { id: "satlayer",    label: "SatLayer",               category: "BTCFi",  keywords: ["satlayer"] },

  // --- Robotics ---
  { id: "openmind",    label: "Openmind",               category: "Robotics", keywords: ["openmind"] },

  // --- ZK ---
  { id: "boundless",   label: "Boundless",              category: "ZK", keywords: ["boundless"] },
  { id: "brevis",      label: "Brevis",                 category: "ZK", keywords: ["brevis"] },
  { id: "cysic",       label: "Cysic",                  category: "ZK", keywords: ["cysic"] },
  { id: "miden",       label: "Miden",                  category: "ZK", keywords: ["miden"] },
  { id: "starknet",    label: "Starknet",               category: "ZK", keywords: ["starknet"] },
  { id: "succinct",    label: "Succinct",               category: "ZK", keywords: ["succinct"] },
  { id: "zcash",       label: "Zcash",                  category: "ZK", keywords: ["zcash"] },
  { id: "zkpass",      label: "zkPass",                 category: "ZK", keywords: ["zkpass"] },

  // --- Others ---
  { id: "anoma",       label: "Anoma",                  category: "Others", keywords: ["anoma"] },
  { id: "bless",       label: "Bless",                  category: "Others", keywords: ["bless protocol"] },
  { id: "bybittradfi", label: "Bybit TradFi",           category: "Others", keywords: ["bybit tradfi"] },
  { id: "humanity",    label: "Humanity Protocol",      category: "Others", keywords: ["humanity protocol"] },
  { id: "integra",     label: "Integra",                category: "Others", keywords: ["integra"] },
  { id: "multibank",   label: "Multibank",              category: "Others", keywords: ["multibank"] },
  { id: "thrive",      label: "Thrive Protocol",        category: "Others", keywords: ["thrive protocol"] },

  // --- Exchange / Perp ---
  { id: "apex",        label: "ApeX",                   category: "Exchange", keywords: ["apex pro","apex dex"] },
  { id: "bluefin",     label: "Bluefin",                category: "Exchange", keywords: ["bluefin"] },
  { id: "dydx",        label: "dYdX",                   category: "Exchange", keywords: ["dydx"] },
  { id: "flipster",    label: "Flipster",               category: "Exchange", keywords: ["flipster"] },
  { id: "mememax",     label: "MemeMax",                category: "Exchange", keywords: ["mememax","mememax_fi","@mememax_fi","memax"] },
  { id: "momentum",    label: "Momentum",               category: "Exchange", keywords: ["momentum"] },
  { id: "paradex",     label: "PARADEX",                category: "Exchange", keywords: ["paradex"] },

  // --- AI / InfoFi ---
  { id: "kaito",       label: "Kaito / Yapper",         category: "AI", keywords: ["kaito","kaito ai","yapper","yap points","infofi"] },
  { id: "og",          label: "OG",                     category: "AI", keywords: ["og protocol"] },
  { id: "allora",      label: "Allora",                 category: "AI", keywords: ["allora"] },
  { id: "billions",    label: "Billions Network",       category: "AI", keywords: ["billions network"] },
  { id: "edgen",       label: "Edgen",                  category: "AI", keywords: ["edgen"] },
  { id: "everlynai",   label: "EverlynAI",              category: "AI", keywords: ["everlynai"] },
  { id: "iq",          label: "IQ",                     category: "AI", keywords: ["iq ai","iq token"] },
  { id: "kindred",     label: "Kindred",                category: "AI", keywords: ["kindred"] },
  { id: "mira",        label: "Mira Network",           category: "AI", keywords: ["mira network"] },
  { id: "novastro",    label: "Novastro",               category: "AI", keywords: ["novastro"] },
  { id: "noya",        label: "Noya.ai",                category: "AI", keywords: ["noya.ai","noya ai"] },
  { id: "openledger",  label: "OpenLedger",             category: "AI", keywords: ["openledger"] },
  { id: "pipworld",    label: "PiP World",              category: "AI", keywords: ["pip world","pipworld"] },
  { id: "playai",      label: "PlayAI",                 category: "AI", keywords: ["playai","play ai"] },
  { id: "sapien",      label: "Sapien",                 category: "AI", keywords: ["sapien"] },
  { id: "sentient",    label: "Sentient",               category: "AI", keywords: ["sentient"] },
  { id: "uxlink",      label: "UXLINK",                 category: "AI", keywords: ["uxlink"] },

  // --- Consumer / Apps ---
  { id: "tria",        label: "Tria",                   category: "Consumer", keywords: ["tria","use tria","@useTria"] },
  { id: "anichess",    label: "Anichess",               category: "Consumer", keywords: ["anichess"] },
  { id: "bitdealer",   label: "Bitdealer",              category: "Consumer", keywords: ["bitdealer"] },
  { id: "defiapp",     label: "Defi App",               category: "Consumer", keywords: ["defi app"] },
  { id: "hana",        label: "Hana",                   category: "Consumer", keywords: ["hana app"] },
  { id: "infinex",     label: "Infinex",                category: "Consumer", keywords: ["infinex"] },
  { id: "lumiterra",   label: "Lumiterra",              category: "Consumer", keywords: ["lumiterra"] },
  { id: "maplestory",  label: "MapleStory Universe",    category: "Consumer", keywords: ["maplestory universe","msu"] },
  { id: "metawin",     label: "Metawin",                category: "Consumer", keywords: ["metawin"] },
  { id: "parti",       label: "Parti",                  category: "Consumer", keywords: ["parti"] },
  { id: "puffpaw",     label: "Puffpaw",                category: "Consumer", keywords: ["puffpaw"] },
  { id: "rainbow",     label: "Rainbow",                category: "Consumer", keywords: ["rainbow wallet","rainbow app"] },
  { id: "sidekick",    label: "Sidekick",               category: "Consumer", keywords: ["sidekick"] },
  { id: "sixr",        label: "SIXR Cricket",           category: "Consumer", keywords: ["sixr cricket","sixr"] },
  { id: "sophon",      label: "Sophon",                 category: "Consumer", keywords: ["sophon"] },
  { id: "vultisig",    label: "Vultisig",               category: "Consumer", keywords: ["vultisig"] },
  { id: "yeet",        label: "YEET",                   category: "Consumer", keywords: ["yeet"] },

  // --- Interop ---
  { id: "caldera",     label: "Caldera",                category: "Interop", keywords: ["caldera"] },
  { id: "initia",      label: "Initia",                 category: "Interop", keywords: ["initia"] },
  { id: "skate",       label: "Skate",                  category: "Interop", keywords: ["skate"] },
  { id: "union",       label: "Union",                  category: "Interop", keywords: ["union"] },

  // --- RWA ---
  { id: "kaio",        label: "KAIO",                   category: "RWA", keywords: ["kaio","kaio network"] },
  { id: "theo",        label: "Theo Network",           category: "RWA", keywords: ["theo","theo network","thbill","tultra"] },

  // --- Snapper / Campaign style(ë§ˆì¸ë“œì‰ì–´ìš©) ---
  { id: "superform",   label: "Superform",              category: "Campaign", keywords: ["superform","superformxyz","@superformxyz"] },
  { id: "glint",       label: "Glint Analytics",        category: "Campaign", keywords: ["glint analytics","@glintanalytics"] },
  { id: "solv",        label: "Solv Protocol",          category: "Campaign", keywords: ["solv protocol","@solvprotocol"] },
  { id: "pacifica",    label: "Pacifica",               category: "Campaign", keywords: ["pacifica_fi","@pacifica_fi","pacifica fi"] },
  { id: "layerbank",   label: "LayerBank",              category: "Campaign", keywords: ["layerbank","layerbankfi","@layerbankfi"] },
  { id: "rayls",       label: "Rayls",                  category: "Campaign", keywords: ["rayls","@RaylsLabs","raylslabs"] },
  { id: "velora",      label: "Velora",                 category: "Campaign", keywords: ["velora","veloradex","@veloradex"] },
  { id: "antix",       label: "Antix",                  category: "Campaign", keywords: ["antix","@antix_in"] },
  { id: "almanak",     label: "Almanak",                category: "Campaign", keywords: ["almanak","@Almanak"] },
  { id: "bob",         label: "BOB",                    category: "Campaign", keywords: ["bob","build on bitcoin","@build_on_bob"] },
  { id: "ten",         label: "TEN Protocol",           category: "Campaign", keywords: ["ten protocol","@tenprotocol","ten app"] },
  { id: "vooi",        label: "Vooi",                   category: "Campaign", keywords: ["vooi","@vooi_io","vooi io"] },

  // --- ë„ˆ ì „ìš©(ì´ë¯¸ CSVì—ì„œ ìì£¼ ì“°ëŠ” ê²ƒë“¤) ---
  { id: "river",       label: "River / satUSD",         category: "Stable", keywords: ["river","satusd","sat usd","river4fun","river4 fun","@riverhq"] },
  { id: "cookie",      label: "Cookie.fun",             category: "InfoFi", keywords: ["cookie.fun","cookie fun","cookie leaderboard","@cookie_fun"] },
  { id: "bnkr",        label: "BNKR / BANKR",           category: "Social", keywords: ["bnkr","bankr","bankr leaderboard","@bnkr_network"] }
];


let ANALYSIS = null;
let ALL_BASE = [];
let CURRENT_LIST = [];
let buckets = { S:[], A:[], B:[], C:[], D:[] };
let CURRENT_RANGE = "ALL";
let CURRENT_GRADE = "ALL";
let SORT_KEY = "score";

/* í”„ë¡œì íŠ¸ í†µê³„/ì°¨íŠ¸ìš© */
let PROJECT_STATS = [];
let projectChart = null;

/* ========== CSV í—¤ë” ë§¤í•‘/ìˆ«ì ========== */
function autoMap(row) {
  const map = {
    "ê²Œì‹œë¬¼ ë³¸ë¬¸": "text", "Post text": "text", "Tweet text": "text",
    "ë‚ ì§œ": "date", "Date": "date",
    "ê²Œì‹œë¬¼ ë§í¬": "link", "Tweet permalink": "link","URL":"link","Link":"link",
    "ê²Œì‹œë¬¼ ID":"id","Tweet ID":"id",
    "ë…¸ì¶œìˆ˜":"impressions","Impressions":"impressions",
    "ì°¸ì—¬ìˆ˜":"engagements","Engagements":"engagements",
    "ë§ˆìŒì— ë“¤ì–´ìš”":"likes","Likes":"likes",
    "ë¶ë§ˆí¬":"bookmarks","Bookmarks":"bookmarks",
    "ì¬ê²Œì‹œ":"retweets","Retweets":"retweets","Reposts":"retweets",
    "ë‹µê¸€":"replies","Replies":"replies",
    "ê³µìœ  ìˆ˜":"shares","Shares":"shares",
    "ìƒˆë¡œìš´ íŒ”ë¡œìš°":"newFollows","New follows":"newFollows",
    "í”„ë¡œí•„ ì¡°íšŒìˆ˜":"profileClicks","Profile clicks":"profileClicks",
    "URL í´ë¦­ìˆ˜":"urlClicks","URL clicks":"urlClicks",
    "ê³ ìœ  ë§í¬ í´ë¦­ìˆ˜":"uniqueClicks","Unique link clicks":"uniqueClicks",
  };
  const result = {};
  for (const key in row) {
    const clean = key.trim();
    if (map[clean]) result[map[clean]] = row[key];
  }

  // ë‚ ì§œ & ë§í¬ & ë³¸ë¬¸ì„ ì¢€ ë” ìœ ì—°í•˜ê²Œ ì°¾ê¸°
  if (!result.date) {
    for (const key in row) {
      const l = key.trim().toLowerCase();
      if (l.includes("ë‚ ì§œ") || l === "date" || l.startsWith("date ")) {
        result.date = row[key];
        break;
      }
    }
  }
  if (!result.link) {
    for (const key in row) {
      const l = key.trim().toLowerCase();
      if (l.includes("ë§í¬") || l.includes("permalink") || l === "url" || l.includes("url")) {
        result.link = row[key];
        break;
      }
    }
  }
  if (!result.text) {
    for (const key in row) {
      const l = key.trim().toLowerCase();
      if (l.includes("text") || l.includes("ë³¸ë¬¸")) {
        result.text = row[key];
        break;
      }
    }
  }
  return result;
}
function num(v){
  if(!v) return 0;
  v = String(v).replace(/,/g,"").trim();
  const n = parseFloat(v);
  return isNaN(n)?0:n;
}

/* ========== ë‚ ì§œ/ê¸°ê°„ ì²˜ë¦¬ (í•œêµ­ì‹ ë‚ ì§œ í¬í•¨) ========== */
function parseDateValue(v){
  if(!v) return null;
  let s = String(v).trim();
  const m = s.match(/(\d{4})[^\d]?(\d{1,2})[^\d]?(\d{1,2})/);
  if(!m) return null;
  const year = parseInt(m[1],10);
  const month = parseInt(m[2],10)-1;
  const day = parseInt(m[3],10);
  const d = new Date(year, month, day);
  return isNaN(d.getTime()) ? null : d;
}

function applyDateFilter(list, range){
  if(range === "ALL") return list.slice();
  const days = Number(range);
  if(!days || !list.length) return list.slice();
  const dates = list.map(p=>p.dateObj).filter(Boolean);
  if(!dates.length) {
    return list.slice();
  }
  const latestTime = Math.max.apply(null, dates.map(d=>d.getTime()));
  const latest = new Date(latestTime);
  const ms = 24*60*60*1000;
  const threshold = new Date(latest.getTime() - (days-1)*ms);
  return list.filter(p => !p.dateObj || p.dateObj >= threshold);
}

/* ========== ìŠ¤ì½”ì–´/ë“±ê¸‰ ========== */
function computeScore(p){
  const impres = p.impressions || 0;
  const raw =
      p.engagements +
      p.bookmarks * 3 +
      p.newFollows * 10 +
      p.profileClicks * 0.7 +
      p.urlClicks * 0.8 +
      p.uniqueClicks * 1.2 +
      p.likes * 1.2 +
      p.retweets * 2 +
      p.replies * 1.5 +
      p.shares * 1.8;
  return raw / Math.log10(impres + 10);
}
function assignGrades(list){
  list.sort((a,b)=>b.score-a.score);
  const N = list.length || 1;
  list.forEach((p,i)=>{
    const pct = N>1 ? 1 - i/(N-1) : 1;
    p.percentile = Math.round(pct*100);
    p.grade =
      pct>=0.95?"S":
      pct>=0.80?"A":
      pct>=0.60?"B":
      pct>=0.40?"C":"D";
  });
}
function computeTrimmedAverage(list, ratio){
  if(!list.length) return 0;
  const scores = list.map(p=>p.score).sort((a,b)=>a-b);
  const n = scores.length;
  let k = Math.floor(n*ratio);
  if(k*2>=n) k = 0;
  const trimmed = scores.slice(k, n-k);
  const sum = trimmed.reduce((s,v)=>s+v,0);
  return sum / trimmed.length;
}
function sortForView(list){
  const key = SORT_KEY || "score";
  list.sort((a,b)=>{
    let va, vb;
    switch(key){
      case "impressions": va = a.impressions; vb = b.impressions; break;
      case "engagements": va = a.engagements; vb = b.engagements; break;
      case "bookmarks":  va = a.bookmarks;  vb = b.bookmarks;  break;
      case "newFollows": va = a.newFollows; vb = b.newFollows; break;
      case "score":
      default:
        va = a.score; vb = b.score; break;
    }
    if(va < vb) return 1;
    if(va > vb) return -1;
    return 0;
  });
  return list;
}

/* ========== í”„ë¡œì íŠ¸ íƒœê¹…/ì§‘ê³„ ========== */
function tagProjectsForPost(p){
  const text = (p.text || "").toLowerCase();
  const tags = [];
  PROJECTS.forEach(proj=>{
    const hit = proj.keywords.some(kw => text.includes(kw.toLowerCase()));
    if(hit) tags.push(proj.id);
  });
  p.projects = tags;
}

function computeProjectStats(list){
  const stats = {};
  PROJECTS.forEach(proj=>{
    stats[proj.id] = {
      id: proj.id,
      label: proj.label,
      count: 0,
      avgScore: 0,
      trimmedAvg: 0,
      bestScore: 0,
      bestDate: "",
      bestLink: "",
      posts: []
    };
  });

  list.forEach(post=>{
    (post.projects || []).forEach(pid=>{
      const s = stats[pid];
      if(!s) return;
      s.count++;
      s.posts.push(post);
      if(!s.bestScore || post.score > s.bestScore){
        s.bestScore = post.score;
        s.bestDate = post.date;
        s.bestLink = post.link;
      }
    });
  });

  const result = [];
  Object.values(stats).forEach(s=>{
    if(!s.posts.length) return;
    const total = s.posts.length;
    s.avgScore = s.posts.reduce((sum,p)=>sum+p.score,0)/total;
    s.trimmedAvg = computeTrimmedAverage(s.posts, TRIM_RATIO);
    result.push(s);
  });
  return result;
}

/* í”„ë¡œì íŠ¸ ìš”ì•½ í…Œì´ë¸” */
function renderProjectSummary(list){
  const wrap = document.getElementById("project-summary-wrap");
  if(!wrap) return;
  if(!list.length){
    wrap.innerHTML = "<div class='empty'>í”„ë¡œì íŠ¸ í‚¤ì›Œë“œì— ë§¤ì¹­ëœ ê¸€ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</div>";
    return;
  }
  list.sort((a,b)=>(b.trimmedAvg||0)-(a.trimmedAvg||0));
  const rows = list.map((s,idx)=>`
    <tr>
      <td>#${idx+1}</td>
      <td>${s.label}</td>
      <td>${s.count}</td>
      <td>${s.avgScore ? s.avgScore.toFixed(1) : "-"}</td>
      <td>${s.trimmedAvg ? s.trimmedAvg.toFixed(1) : "-"}</td>
      <td>${s.bestLink ? `<a href="${s.bestLink}" class="link-pill" target="_blank">ëŒ€í‘œ íŠ¸ìœ— â†—</a>` : ""}</td>
    </tr>
  `).join("");
  wrap.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>ìˆœìœ„</th>
          <th>í”„ë¡œì íŠ¸</th>
          <th>ê²Œì‹œê¸€ ìˆ˜</th>
          <th>í‰ê·  ìŠ¤ì½”ì–´</th>
          <th>íŠ¸ë¦¼ë“œ í‰ê· </th>
          <th>ëŒ€í‘œ íŠ¸ìœ—</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

/* í”„ë¡œì íŠ¸ë³„ ìƒì„¸ ì…€ë ‰íŠ¸ & í…Œì´ë¸” */
function buildProjectSelect(list){
  const select = document.getElementById("project-select");
  const detailWrap = document.getElementById("project-detail-wrap");
  if(!select || !detailWrap) return;

  if(!list.length){
    select.innerHTML = `<option value="">ë§¤ì¹­ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</option>`;
    detailWrap.innerHTML = `<div class="empty">í”„ë¡œì íŠ¸ í‚¤ì›Œë“œì— ë§¤ì¹­ëœ ê¸€ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }

  select.innerHTML = list.map(p=>`<option value="${p.id}">${p.label} (${p.count})</option>`).join("");
  select.onchange = () => {
    renderProjectDetail(select.value);
  };
  renderProjectDetail(list[0].id);
}

function renderProjectDetail(projectId){
  const wrap = document.getElementById("project-detail-wrap");
  if(!wrap) return;
  const proj = PROJECT_STATS.find(p=>p.id===projectId);
  if(!proj || !proj.posts.length){
    wrap.innerHTML = `<div class="empty">ì„ íƒí•œ í”„ë¡œì íŠ¸ì— í•´ë‹¹í•˜ëŠ” ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }
  const posts = proj.posts.slice().sort((a,b)=>b.score-a.score);
  const rows = posts.map((p,idx)=>`
    <tr>
      <td>#${idx+1}</td>
      <td><div class="grade-badge ${p.grade.toLowerCase()}">${p.grade}</div></td>
      <td>
        <div class="text-main">${p.text}</div>
        <div class="text-meta">${p.date} Â· ìŠ¤ì½”ì–´ <strong>${p.score.toFixed(1)}</strong></div>
      </td>
      <td>
        <div class="stat-chip">ì°¸ì—¬ <strong>${p.engagements}</strong></div>
        <div class="stat-chip">ë…¸ì¶œ <strong>${p.impressions}</strong></div>
      </td>
      <td>
        <div class="stat-chip">íŒ”ë¡œìš° <strong>${p.newFollows}</strong></div>
        <div class="stat-chip">ë¶ë§ˆí¬ <strong>${p.bookmarks}</strong></div>
      </td>
      <td>${p.link ? `<a href="${p.link}" class="link-pill" target="_blank">íŠ¸ìœ— ë³´ê¸° â†—</a>` : ""}</td>
    </tr>
  `).join("");

  wrap.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>ë“±ê¸‰</th>
          <th>ë³¸ë¬¸</th>
          <th>ì°¸ì—¬/ë…¸ì¶œ</th>
          <th>íŒ”ë¡œìš°/ë¶ë§ˆí¬</th>
          <th>ë§í¬</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

/* í”„ë¡œì íŠ¸ ë„ë„› ì°¨íŠ¸ */
function renderProjectPieChart(list){
  const canvas = document.getElementById("project-pie");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");

  if(projectChart){
    projectChart.destroy();
    projectChart = null;
  }
  if(!list.length) return;

  const labels = list.map(p=>p.label);
  const data = list.map(p=>p.count);

  projectChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: [
          "rgba(59,130,246,0.9)",
          "rgba(45,212,191,0.9)",
          "rgba(251,191,36,0.9)",
          "rgba(244,114,182,0.9)"
        ]
      }]
    },
    options: {
      plugins: {
        legend: { position: "bottom" }
      },
      cutout: "60%"
    }
  });
}

/* ========== Top10 / ë“±ê¸‰ë³„ ë Œë”ë§ ========== */
function renderTop10(posts){
  const wrap=document.getElementById("top10-table-wrap");
  const countSpan = document.getElementById("top10-count");
  if(!posts.length){
    wrap.innerHTML="<div class='empty'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    if(countSpan) countSpan.textContent = "";
    return;
  }
  const base = sortForView(posts.slice());
  const top = base.slice(0,10);
  if(countSpan) countSpan.textContent = `(${top.length} / ${posts.length})`;
  const rows=top.map((p,i)=>`
    <tr>
      <td>#${i+1}</td>
      <td><div class="grade-badge ${p.grade.toLowerCase()}">${p.grade}</div></td>
      <td>
        <div class="text-main">${p.text}</div>
        <div class="text-meta">${p.date} Â· ìŠ¤ì½”ì–´ <strong>${p.score.toFixed(1)}</strong></div>
      </td>
      <td>
        <div class="stat-chip">ì°¸ì—¬ <strong>${p.engagements}</strong></div>
        <div class="stat-chip">ë…¸ì¶œ <strong>${p.impressions}</strong></div>
      </td>
      <td>
        <div class="stat-chip">íŒ”ë¡œìš° <strong>${p.newFollows}</strong></div>
        <div class="stat-chip">ë¶ë§ˆí¬ <strong>${p.bookmarks}</strong></div>
      </td>
      <td>${p.link ? `<a href="${p.link}" class="link-pill" target="_blank">íŠ¸ìœ— ë³´ê¸° â†—</a>` : ""}</td>
    </tr>`).join("");
  wrap.innerHTML=`
    <table>
      <thead><tr>
        <th>#</th><th>ë“±ê¸‰</th><th>ë³¸ë¬¸</th><th>ì°¸ì—¬/ë…¸ì¶œ</th><th>íŒ”ë¡œìš°/ë¶ë§ˆí¬</th><th>ë§í¬</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}
function renderGrade(list){
  const wrap=document.getElementById("grade-table-wrap");
  if(!list.length){
    wrap.innerHTML="<div class='empty'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    return;
  }
  const base = sortForView(list.slice());
  const rows=base.map((p,i)=>`
    <tr>
      <td>#${i+1}</td>
      <td><div class="grade-badge ${p.grade.toLowerCase()}">${p.grade}</div></td>
      <td>
        <div class="text-main">${p.text}</div>
        <div class="text-meta">${p.date} Â· ìŠ¤ì½”ì–´ <strong>${p.score.toFixed(1)}</strong></div>
      </td>
      <td>
        <div class="stat-chip">ì°¸ì—¬ <strong>${p.engagements}</strong></div>
        <div class="stat-chip">ë…¸ì¶œ <strong>${p.impressions}</strong></div>
      </td>
      <td>
        <div class="stat-chip">íŒ”ë¡œìš° <strong>${p.newFollows}</strong></div>
        <div class="stat-chip">ë¶ë§ˆí¬ <strong>${p.bookmarks}</strong></div>
      </td>
      <td>${p.link ? `<a href="${p.link}" class="link-pill" target="_blank">íŠ¸ìœ— ë³´ê¸° â†—</a>` : ""}</td>
    </tr>`).join("");
  wrap.innerHTML=`
    <table>
      <thead><tr>
        <th>#</th><th>ë“±ê¸‰</th><th>ë³¸ë¬¸</th><th>ì°¸ì—¬/ë…¸ì¶œ</th><th>íŒ”ë¡œìš°/ë¶ë§ˆí¬</th><th>ë§í¬</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

/* ========== ì½”ì¹˜ ë´‡ ì¶œë ¥ ========== */
function updateCoach(){
  const el = document.getElementById("coach-output");
  if(!el) return;

  if(!ALL_BASE.length){
    el.textContent =
      "ì•„ì§ CSVë¥¼ ì˜¬ë¦¬ì§€ ì•Šì•˜ì–´.\nìƒë‹¨ì—ì„œ ì• ë„ë¦¬í‹±ìŠ¤ CSVë¥¼ ì—…ë¡œë“œí•˜ë©´\nì´ êµ¬ê°„ì˜ ë§ˆì¸ë“œì‰ì–´ ìƒíƒœë¥¼ ì½”ì¹˜ ë´‡ì´ ìš”ì•½í•´ ì¤„ ê±°ì•¼.";
    return;
  }
  if(!CURRENT_LIST.length || !ANALYSIS){
    el.textContent = "ì„ íƒí•œ ê¸°ê°„ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ì–´ì„œ ë¶„ì„í•  ìˆ˜ ì—†ì–´.";
    return;
  }

  const gradeCounts = { S:0, A:0, B:0, C:0, D:0 };
  CURRENT_LIST.forEach(p=>{
    if(gradeCounts[p.grade] !== undefined){
      gradeCounts[p.grade]++;
    }
  });

  const tAvg = ANALYSIS.trimmedAvg || 0;
  let overallGrade, mood;
  if(tAvg >= 80){
    overallGrade = "S";
    mood = "ì´ë²ˆ êµ¬ê°„ì€ ì‚¬ì‹¤ìƒ í­ë°œ êµ¬ê°„ì´ì•¼. ì§€ê¸ˆ í˜ì´ìŠ¤ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë©´ì„œ, í„°ì¡Œë˜ íŒ¨í„´ì„ ë°˜ë³µí•˜ë©´ ë¼.";
  }else if(tAvg >= 60){
    overallGrade = "A";
    mood = "ìƒìœ„ê¶Œì—ì„œ ì˜ ë²„í‹°ê³  ìˆì–´. ì¡°ê¸ˆë§Œ ë” ì •êµí•˜ê²Œ ì‹¤í—˜í•˜ë©´ ì–¸ì œë“  Së¡œ ì˜¬ë¼ê°ˆ ìˆ˜ ìˆëŠ” ìœ„ì¹˜ì•¼.";
  }else if(tAvg >= 45){
    overallGrade = "B";
    mood = "ë¬´ë‚œí•˜ê²Œ ìš°ìƒí–¥ ì¤€ë¹„ ì¤‘ì¸ êµ¬ê°„ì´ì•¼. ëª‡ ê°œ ê°•í•œ ì‹œê·¸ë„ì„ ë” ë§Œë“¤ë©´ í•œ ë‹¨ê³„ ìœ„ë¡œ ì˜¬ë¼ê°ˆ ìˆ˜ ìˆì–´.";
  }else if(tAvg >= 30){
    overallGrade = "C";
    mood = "ì‹¤í—˜ì€ ë§ì´ í–ˆì§€ë§Œ ì•„ì§ ë¹µ í„°ì§€ëŠ” íŒ¨í„´ì´ ë¶€ì¡±í•œ êµ¬ê°„ì´ì•¼. ì˜ í„°ì§„ ê¸€ ê¸°ì¤€ìœ¼ë¡œ ê³µí†µ íŒ¨í„´ì„ ë½‘ì•„ë³´ì.";
  }else{
    overallGrade = "D";
    mood = "ë°ì´í„°ê°€ ìŒ“ì´ëŠ” ë‹¨ê³„ë¼ì„œ, ì§€ê¸ˆì€ â€˜í…ŒìŠ¤íŠ¸ ê¸°ê°„â€™ì´ë¼ ë³´ë©´ ë¼. ë‹¤ì–‘í•œ í˜•ì‹ì„ ë¶€ë‹´ ì—†ì´ ë˜ì§€ëŠ” ê²Œ ì¢‹ì•„.";
  }

  const bestPost = CURRENT_LIST.slice().sort((a,b)=>b.score-a.score)[0];

  let projectLine = "ì•„ì§ í”„ë¡œì íŠ¸ í‚¤ì›Œë“œì— ë§¤ì¹­ëœ ê¸€ì´ ì—†ì–´ì„œ í”„ë¡œì íŠ¸ë³„ í‰ê°€ëŠ” ìƒëµí• ê²Œ.";
  if(PROJECT_STATS && PROJECT_STATS.length){
    const bestProj = PROJECT_STATS.slice().sort((a,b)=> (b.trimmedAvg||0)-(a.trimmedAvg||0))[0];
    projectLine = `í”„ë¡œì íŠ¸ ì¤‘ì—ì„œëŠ” ã€Œ${bestProj.label}ã€ê°€ ê°€ì¥ ê°•í•˜ê²Œ ë‚˜ì™€. ì´ êµ¬ê°„ì—ì„œ í‰ê·  ìŠ¤ì½”ì–´ëŠ” ëŒ€ëµ ${bestProj.trimmedAvg.toFixed(1)}ì ì´ì•¼.`;
  }

  const text =
`â— ì´ë²ˆ ê¸°ê°„ í•œ ì¤„ ìš”ì•½
- ì „ì²´ íŠ¸ë¦¼ë“œ í‰ê· : ì•½ ${tAvg.toFixed(1)}ì  â†’ ì²´ê° ë“±ê¸‰ìœ¼ë¡œëŠ” ${overallGrade} êµ¬ê°„ì´ì•¼.
- ë“±ê¸‰ ë¶„í¬: S ${gradeCounts.S} / A ${gradeCounts.A} / B ${gradeCounts.B} / C ${gradeCounts.C} / D ${gradeCounts.D}

â— ì½”ì¹˜ ì½”ë©˜íŠ¸
- ${mood}

â— ê°€ì¥ ì˜ í„°ì§„ ê¸€
- ë‚ ì§œ: ${bestPost.date || "-"}
- ìŠ¤ì½”ì–´: ${bestPost.score.toFixed(1)}
${bestPost.link ? "- ë§í¬: " + bestPost.link : ""}

â— í”„ë¡œì íŠ¸ ê´€ì  í•œ ì¤„ í‰
- ${projectLine}

â€» íŒ: ìƒìœ„ S/A ê¸€ë“¤ë§Œ ëª¨ì•„ì„œ â€œê¸¸ì´, í†¤, ë°ˆ ì‚¬ìš© ì—¬ë¶€, ì‹œê°„ëŒ€, í•´ì‹œíƒœê·¸, ì´ë„ˆì„œí´ íƒœê·¸ ì—¬ë¶€â€ë¥¼ ë¹„êµí•´ ë³´ë©´,
ì§€ê¸ˆ ê³„ì •ë§Œì˜ ë§ˆì‰ íŒ¨í„´ì„ ë” ë¹¨ë¦¬ ì°¾ì„ ìˆ˜ ìˆì–´.`;

  el.textContent = text;
}

/* ========== ì „ì²´ ë·° ì—…ë°ì´íŠ¸ (ê¸°ê°„ í•„í„° ì ìš©) ========== */
function updateView(){
  if(!ALL_BASE.length) return;
  const summaryEl = document.getElementById("summary");
  const errorEl = document.getElementById("error");
  const filtered = applyDateFilter(ALL_BASE, CURRENT_RANGE);
  CURRENT_LIST = filtered;

  if(!filtered.length){
    ANALYSIS = null;
    summaryEl.innerHTML = "";
    summaryEl.style.display = "none";
    errorEl.textContent = "ì„ íƒí•œ ê¸°ê°„ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
    document.getElementById("top10-table-wrap").innerHTML = "<div class='empty'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    document.getElementById("grade-table-wrap").innerHTML = "<div class='empty'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    PROJECT_STATS = [];
    renderProjectSummary([]);
    buildProjectSelect([]);
    renderProjectPieChart([]);
    const countSpan = document.getElementById("top10-count");
    if(countSpan) countSpan.textContent = "";
    updateCoach();
    return;
  }

  errorEl.textContent = "";
  assignGrades(filtered);

  buckets = { S:[], A:[], B:[], C:[], D:[] };
  filtered.forEach(p=>{
    const g = p.grade;
    if(buckets[g] && buckets[g].length < 10){
      buckets[g].push(p);
    }
  });

  const total = filtered.length;
  const avgScore = filtered.reduce((s,p)=>s+p.score,0)/total;
  const trimmedAvg = computeTrimmedAverage(filtered, TRIM_RATIO);
  const best = filtered[0];

  ANALYSIS = {
    trimmedAvg,
    avgScore,
    bestScore: best.score,
    bestDate: best.date,
    bestLink: best.link,
    totalPosts: total
  };

  summaryEl.innerHTML=`
    <div class="summary-card"><div class="summary-label">ì›ê¸€ ê°œìˆ˜</div>
      <div class="summary-value">${total}</div><div class="summary-sub">ë‹µê¸€ ì œì™¸ Â· ê¸°ê°„ í•„í„° ì ìš©</div></div>
    <div class="summary-card"><div class="summary-label">í‰ê·  ìŠ¤ì½”ì–´</div>
      <div class="summary-value">${avgScore.toFixed(1)}</div>
      <div class="summary-sub">í˜„ì¬ ì„ íƒëœ ê¸°ê°„ì˜ ì „ì²´ ì›ê¸€ ê¸°ì¤€</div></div>
    <div class="summary-card"><div class="summary-label">íŠ¸ë¦¼ë“œ í‰ê· </div>
      <div class="summary-value">${trimmedAvg.toFixed(1)}</div>
      <div class="summary-sub">ìƒÂ·í•˜ìœ„ 10% ì œê±° í›„ í‰ê· </div></div>
    <div class="summary-card"><div class="summary-label">ê°€ì¥ í„°ì§„ ê¸€</div>
      <div class="summary-value">${best.score.toFixed(1)}</div>
      <div class="summary-sub">${best.date || ""}</div></div>`;
  summaryEl.style.display="grid";

  renderTop10(filtered);
  if(CURRENT_GRADE === "ALL"){
    renderGrade(filtered.slice(0,30));
  }else{
    renderGrade(buckets[CURRENT_GRADE] || []);
  }

  PROJECT_STATS = computeProjectStats(filtered);
  renderProjectSummary(PROJECT_STATS);
  buildProjectSelect(PROJECT_STATS);
  renderProjectPieChart(PROJECT_STATS);

  updateCoach();
}

/* ========== CSV ì—…ë¡œë“œ ========== */
document.getElementById("csvInput").addEventListener("change", e=>{
  const file=e.target.files[0]; if(!file) return;
  Papa.parse(file,{
    header:true,skipEmptyLines:true,
    complete:res=>{
      ALL_BASE=[];
      res.data.forEach(row=>{
        const r=autoMap(row);
        const t=(r.text||"").trim();
        if(!t || t.startsWith("@")) return;
        const dateObj = parseDateValue(r.date);
        const p={
          text:t,
          date:r.date || "",
          dateObj,
          link:r.link,
          impressions:num(r.impressions),
          engagements:num(r.engagements),
          likes:num(r.likes),
          bookmarks:num(r.bookmarks),
          newFollows:num(r.newFollows),
          replies:num(r.replies),
          retweets:num(r.retweets),
          shares:num(r.shares),
          profileClicks:num(r.profileClicks),
          urlClicks:num(r.urlClicks),
          uniqueClicks:num(r.uniqueClicks),
        };
        p.score=computeScore(p);
        tagProjectsForPost(p);
        ALL_BASE.push(p);
      });

      if(!ALL_BASE.length){
        document.getElementById("error").textContent="CSVì—ì„œ ë¶„ì„ ê°€ëŠ¥í•œ ì›ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.";
      }else{
        document.getElementById("error").textContent="";
        CURRENT_RANGE = "ALL";
        CURRENT_GRADE = "ALL";
        const rangeTabs = document.getElementById("range-tabs");
        if(rangeTabs) rangeTabs.style.display = "flex";
        updateView();
      }
    }
  });
});

/* ========== ë¦¬ë”ë³´ë“œ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ========== */
async function saveToLeaderboard(){
  if(!ANALYSIS){
    alert("ë¨¼ì € CSVë¥¼ ì—…ë¡œë“œí•´ì„œ ë¶„ì„ì„ ëŒë ¤ì¤˜.");
    return;
  }
  const handleInput = document.getElementById("leader-handle");
  const handle = (handleInput.value || "").trim();
  if(!handle){
    alert("X í•¸ë“¤ì„ ì…ë ¥í•´ì¤˜. (ì˜ˆ: @bud_dha__)");
    handleInput.focus();
    return;
  }
  if(ANALYSIS.totalPosts < MIN_POSTS_FOR_LEADERBOARD){
    if(!confirm(`ì›ê¸€ì´ ${ANALYSIS.totalPosts}ê°œì…ë‹ˆë‹¤. ìµœì†Œ ${MIN_POSTS_FOR_LEADERBOARD}ê°œ ì´ìƒì¼ ë•Œ ì¶”ì²œí•´.\nê·¸ë˜ë„ ì €ì¥í• ë˜?`)) return;
  }

  const bestPost = CURRENT_LIST.slice().sort((a,b)=>b.score-a.score)[0];

  const payload = {
    handle,
    trimmedAvg: ANALYSIS.trimmedAvg,
    avgScore: ANALYSIS.avgScore,
    bestScore: ANALYSIS.bestScore,
    bestDate: ANALYSIS.bestDate,
    bestLink: ANALYSIS.bestLink,
    bestText: bestPost?.text || "",
    bestGrade: bestPost?.grade || "",
    totalPosts: ANALYSIS.totalPosts
  };

  try{
    await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    alert("ë¦¬ë”ë³´ë“œì— ê¸°ë¡ ì €ì¥ ì™„ë£Œ! ğŸ”¥");
    loadLeaderboard(handle);
  }catch(err){
    console.error(err);
    alert("ë¦¬ë”ë³´ë“œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆë‹¤.");
  }
}
async function loadLeaderboard(handle){
  const tableWrap = document.getElementById("leaderboard-wrap");
  const myRankWrap = document.getElementById("my-rank-wrap");
  if(!tableWrap) return;
  try{
    const url = handle
      ? `${SCRIPT_URL}?handle=${encodeURIComponent(handle)}`
      : SCRIPT_URL;
    const res  = await fetch(url);
    const data = await res.json();
    const list   = Array.isArray(data) ? data : (data.top || []);
    const myRank = !Array.isArray(data) ? data.myRank : null;
    if(myRankWrap) myRankWrap.innerHTML = "";

    if(!list || !list.length){
      tableWrap.innerHTML = "<div class='empty'>ì•„ì§ ë¦¬ë”ë³´ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
      return;
    }
    if(myRank && myRankWrap){
      const trimmedAvg = Number(myRank.trimmedAvg || 0).toFixed(1);
      const avgScore   = Number(myRank.avgScore   || 0).toFixed(1);
      const totalPosts = myRank.totalPosts || 0;
      myRankWrap.innerHTML = `
        <div style="padding:10px 12px;margin-bottom:8px;border-radius:14px;border:1px solid rgba(209,213,219,1);background:#f9fafb;font-size:12px;">
          <div style="font-size:13px;font-weight:700;margin-bottom:4px;">ë‚´ í˜„ì¬ ìˆœìœ„</div>
          <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
            <span style="font-weight:700;color:#f97316;">#${myRank.rank}ìœ„</span>
            <span>Â· íŠ¸ë¦¼ë“œ í‰ê·  <strong>${trimmedAvg}</strong></span>
            <span>Â· í‰ê·  ìŠ¤ì½”ì–´ <strong>${avgScore}</strong></span>
            <span>Â· ì›ê¸€ ìˆ˜ <strong>${totalPosts}</strong></span>
          </div>
        </div>
      `;
    }

    const rows = list.map((item, idx) => {
      const handle      = item.handle || "";
      const handleClean = handle.replace("@","").trim();
      const trimmedAvg  = Number(item.trimmedAvg || 0).toFixed(1);
      const avgScore    = Number(item.avgScore   || 0).toFixed(1);
      const totalPosts  = item.totalPosts || 0;
      const bestLink    = item.bestLink || (handleClean ? `https://twitter.com/${handleClean}` : "#");
      return `
        <tr>
          <td>#${idx+1}</td>
          <td>
            <a href="${bestLink}" target="_blank" style="display:inline-flex;align-items:center;gap:6px;text-decoration:none;color:#111827">
              <img src="https://unavatar.io/twitter/${handleClean}" style="width:20px;height:20px;border-radius:999px;border:1px solid rgba(209,213,219,1)"/>
              <span>${handle}</span>
            </a>
          </td>
          <td>${trimmedAvg}</td>
          <td>${avgScore}</td>
          <td>${totalPosts}</td>
          <td>${item.bestLink ? `<a href="${item.bestLink}" class="link-pill" target="_blank">ëŒ€í‘œ íŠ¸ìœ— ë³´ê¸° â†—</a>` : ""}</td>
        </tr>`;
    }).join("");
    tableWrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>ìˆœìœ„</th>
            <th>í•¸ë“¤</th>
            <th>íŠ¸ë¦¼ë“œ í‰ê· </th>
            <th>í‰ê·  ìŠ¤ì½”ì–´</th>
            <th>ì›ê¸€ ìˆ˜</th>
            <th>ëŒ€í‘œ íŠ¸ìœ—</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;
  }catch(err){
    console.error(err);
    tableWrap.innerHTML = "<div class='empty'>ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆë‹¤.</div>";
  }
}

/* ========== íƒ­ & ì´ë²¤íŠ¸ ========== */
document.querySelectorAll(".grade-tab").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".grade-tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const g=btn.dataset.grade;
    CURRENT_GRADE = g;
    if(g==="ALL") renderGrade(CURRENT_LIST.slice(0,30));
    else renderGrade(buckets[g] || []);
  });
});

document.querySelectorAll(".range-tab").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".range-tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    CURRENT_RANGE = btn.dataset.range || "ALL";
    updateView();
  });
});

const sortSelect = document.getElementById("sort-key");
if(sortSelect){
  sortSelect.addEventListener("change", e=>{
    SORT_KEY = e.target.value || "score";
    if(!CURRENT_LIST.length) return;
    renderTop10(CURRENT_LIST);
    if(CURRENT_GRADE === "ALL") renderGrade(CURRENT_LIST.slice(0,30));
    else renderGrade(buckets[CURRENT_GRADE] || []);
  });
}

document.getElementById("leader-save-btn").addEventListener("click", saveToLeaderboard);
loadLeaderboard();

/* ========== ì‚¬ì´ë“œë°” ë·° í† ê¸€ ========== */
const viewNavItems = document.querySelectorAll(".side-nav-item[data-view]");
const viewDashboard = document.getElementById("view-dashboard");
const viewLeaderboard = document.getElementById("view-leaderboard");
const viewProjects = document.getElementById("view-projects");

viewNavItems.forEach(item => {
  item.addEventListener("click", () => {
    const view = item.dataset.view;

    viewNavItems.forEach(i => i.classList.remove("active"));
    item.classList.add("active");

    if (view === "leaderboard") {
      viewDashboard.style.display = "none";
      viewLeaderboard.style.display = "block";
      viewProjects.style.display = "none";
      loadLeaderboard();
    } else if (view === "projects") {
      viewDashboard.style.display = "none";
      viewLeaderboard.style.display = "none";
      viewProjects.style.display = "block";
    } else {
      viewDashboard.style.display = "block";
      viewLeaderboard.style.display = "none";
      viewProjects.style.display = "none";
    }
  });
});

/* ì‚¬ì´ë“œë°” ì ‘ê¸° / í¼ì¹˜ê¸° */
const layout = document.querySelector(".layout");
const sidebarToggle = document.getElementById("sidebar-toggle");
sidebarToggle.addEventListener("click", () => {
  layout.classList.toggle("collapsed");
});
</script>
</body>
</html>
