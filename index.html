<!doctype html> 
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>X MUDDHA1.0.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- CSV íŒŒì„œ -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- í”„ë¡œì íŠ¸ë³„ ì›í˜• ê·¸ë˜í”„ìš© -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3.3.0/dist/chartjs-chart-financial.umd.min.js"></script>

  <!-- âœ… STEP 2 -->
  <style>
  html {
  scroll-behavior: smooth;
}

:root {
  --bg: #f3f7ff;
  --bg-soft: #f8fbff;
  --sidebar-bg: #ffffff;
  --card-bg: #ffffff;
  --card-soft: #f9fbff;
  --accent: #4f46e5;
  --accent-soft: #e0e7ff;
  --accent-2: #06b6d4;
  --accent-3: #22c55e;
  --text-main: #0f172a;
  --text-muted: #6b7280;
  --border-soft: rgba(148,163,184,.35);

  --grade-s: #f59e0b;
  --grade-a: #38bdf8;
  --grade-b: #22c55e;
  --grade-c: #a855f7;
  --grade-d: #9ca3af;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:
    radial-gradient(circle at 0% 0%, #e0f2fe, transparent 55%),
    radial-gradient(circle at 100% 0%, #ffe4f5, transparent 55%),
    linear-gradient(180deg,#eef4ff,#f9fafb);
  color:var(--text-main);
  min-height:100vh;
}

.layout{
  display:flex;
  min-height:100vh;
}

/* ========== SIDEBAR ========== */
.sidebar{
  width:230px;
  background:var(--sidebar-bg);
  backdrop-filter: blur(18px) saturate(160%);
  color:#111827;
  padding:20px 18px;
  display:flex;
  flex-direction:column;
  gap:24px;
  box-shadow: 10px 0 35px rgba(148,163,184,.45);
  position:relative;
  z-index:10;
  transition:width .2s ease;
  overflow:hidden;
  border-right:1px solid rgba(209,213,219,.9);
}

.sidebar-toggle{
  position:absolute;
  top:0;
  right:-6px;
  width:12px;
  height:100%;
  border:none;
  background:transparent;
  padding:0;
  cursor:pointer;
  z-index:20;
}
.sidebar-toggle::before{
  content:"âŸ¨";
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:24px;
  height:24px;
  border-radius:999px;
  background:linear-gradient(135deg,#4f46e5,#06b6d4);
  color:#f9fafb;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  box-shadow:0 10px 24px rgba(79,70,229,.65);
  opacity:0;
  transition:opacity .15s ease;
}
.sidebar-toggle:hover::before{
  opacity:1;
}

.side-profile{
  display:flex;
  gap:12px;
  align-items:center;
  margin-top:18px;
}
.side-login-btn{
  margin-top:6px;
  padding:4px 8px;
  font-size:11px;
  border-radius:999px;
  border:1px solid rgba(148,163,184,.6);
  background:rgba(248,250,252,.9);
  cursor:pointer;
}
.side-login-btn:hover{
  background:#e5edff;
}
.side-avatar{
  width:44px;height:44px;
  border-radius:999px;
  border:2px solid rgba(248,250,252,.9);
  overflow:hidden;
  box-shadow:0 8px 18px rgba(148,163,184,.7);
}
.side-avatar img{width:100%;height:100%;object-fit:cover}
.side-name{font-size:15px;font-weight:700;}
.side-handle{
  font-size:12px;color:#6b7280;
  text-decoration:none;
}

.side-nav{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-top:12px;
}
.side-nav-item{
  display:flex;
  align-items:center;
  gap:8px;
  padding:8px 10px;
  border-radius:12px;
  font-size:13px;
  color:#4b5563;
  cursor:pointer;
  text-decoration:none;
  transition:background .15s ease, transform .1s ease, box-shadow .15s ease;
}
.side-nav-item:hover{
  background:rgba(191,219,254,.6);
  transform:translateX(2px);
  box-shadow:0 6px 16px rgba(148,163,184,.4);
}
.side-nav-item span.icon{
  width:20px;height:20px;
  border-radius:9px;
  background:linear-gradient(135deg,#e0f2fe,#e5e7eb);
  display:flex;align-items:center;justify-content:center;
  font-size:12px;
  flex-shrink:0;
}
.side-label{
  white-space:nowrap;
}
.side-nav-item.active{
  background:linear-gradient(135deg,#4f46e5,#06b6d4);
  color:#f9fafb;
  box-shadow:0 10px 24px rgba(79,70,229,.7);
}
.side-nav-item.active span.icon{
  background:rgba(15,23,42,.9);
  color:#e5e7eb;
}

.side-footer{
  margin-top:auto;
  font-size:11px;
  color:#9ca3af;
}
.side-badge{
  margin-top:6px;
  padding:8px 10px;
  border-radius:14px;
  background:radial-gradient(circle at 0% 0%,#4f46e5,#06b6d4);
  font-size:12px;
  color:#f9fafb;
  text-align:left;
  box-shadow:0 14px 28px rgba(15,23,42,.65);
}

/* ========== SIDEBAR COLLAPSE ========== */
.layout.collapsed .sidebar{
  width:70px;
}
.layout.collapsed .side-name,
.layout.collapsed .side-handle,
.layout.collapsed .side-label,
.layout.collapsed .side-footer{
  display:none;
}
.layout.collapsed .side-profile{
  justify-content:center;
}
.layout.collapsed .sidebar-toggle::before{
  content:"âŸ©";
}

/* ========== MAIN AREA ========== */
.main{
  flex:1;
  padding:20px 24px 32px;
  max-width:calc(100vw - 230px);
  overflow-x:hidden;
  transition:max-width .2s ease;
}
.layout.collapsed .main{
  max-width:calc(100vw - 70px);
}

.top-nav{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:16px;
  flex-wrap:wrap;
  gap:8px;
}
.top-title{
  font-size:20px;
  font-weight:800;
}
.top-sub{
  font-size:12px;
  color:var(--text-muted);
}
.top-cta{
  display:flex;
  gap:8px;
  align-items:center;
}
.lang-toggle{
  display:flex;
  gap:4px;
  align-items:center;
  font-size:11px;
}

.lang-btn{
  border-radius:999px;
  border:1px solid rgba(209,213,219,1);
  background:#ffffff;
  padding:4px 8px;
  font-size:11px;
  cursor:pointer;
}

.lang-btn.active{
  background:linear-gradient(135deg,#4f46e5,#06b6d4);
  color:#f9fafb;
  border-color:transparent;
}

.top-link{
  font-size:12px;
  padding:7px 12px;
  border-radius:999px;
  border:1px solid #c7d2fe;
  background:var(--card-soft);
  color:var(--accent);
  text-decoration:none;
  display:inline-flex;
  align-items:center;
  gap:6px;
}

/* HERO */
.hero-card{
  background:
    radial-gradient(circle at 0% 0%, #c7d2fe, transparent 45%),
    radial-gradient(circle at 100% 0%, #a5f3fc, transparent 45%),
    linear-gradient(135deg,#f9fafb,#eef2ff);
  border-radius:24px;
  padding:18px 18px 16px;
  border:1px solid rgba(191,219,254,.9);
  display:flex;
  flex-direction:column;
  gap:10px;
  box-shadow:0 22px 45px rgba(148,163,184,.45);
}
.hero-top-row{
  display:flex;
  justify-content:space-between;
  gap:12px;
  align-items:flex-start;
  flex-wrap:wrap;
}
.hero-main-title{
  font-size:17px;
  font-weight:800;
  color:#111827;
}
.hero-desc{
  font-size:12px;
  color:#4b5563;
  margin-top:4px;
  line-height:1.4;
}
.hero-pill{
  font-size:11px;
  padding:5px 10px;
  border-radius:999px;
  background:rgba(255,255,255,.95);
  border:1px solid rgba(148,163,184,.5);
  display:inline-flex;
  align-items:center;
  gap:6px;
  margin-top:6px;
}
.hero-dot{
  width:8px;height:8px;border-radius:999px;
  background:#22c55e;
  box-shadow:0 0 0 5px rgba(34,197,94,.2);
}

.hero-upload-row{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  align-items:center;
  margin-top:4px;
}
.file-input-wrap{position:relative;display:inline-block;overflow:hidden}
.file-input-wrap input[type="file"]{position:absolute;inset:0;opacity:0;cursor:pointer}
.file-input-fake{
  padding:8px 14px;border-radius:999px;border:1px solid rgba(148,163,184,.7);
  font-size:12px;display:inline-flex;align-items:center;gap:8px;
  background:rgba(255,255,255,.95);cursor:pointer;white-space:nowrap;
  color:#111827;
}
.file-hint{font-size:11px;color:#4b5563}

.range-tabs{
  margin-top:10px;
  display:flex;
  gap:6px;
  flex-wrap:wrap;
}
.range-tab{
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  border:1px solid rgba(148,163,184,.7);
  background:rgba(255,255,255,.9);
  color:#4b5563;
  cursor:pointer;
  transition:background .15s ease, transform .1s ease;
}
.range-tab:hover{
  transform:translateY(-1px);
}
.range-tab.active{
  background:linear-gradient(135deg,#4f46e5,#06b6d4);
  border-color:transparent;
  color:#f9fafb;
}

.badge{
  display:inline-flex;gap:6px;padding:4px 9px;border-radius:999px;
  border:1px solid rgba(148,163,184,.6);font-size:11px;color:#4b5563;
  background:rgba(255,255,255,.85);margin-top:2px;
}
.badge-dot{width:7px;height:7px;border-radius:999px;background:#a5b4fc}

.error{color:#ef4444;font-size:12px;margin-top:4px}

/* GRID (ëŒ€ì‹œë³´ë“œ) */
.grid-1{
  margin-top:18px;
  display:grid;
  grid-template-columns:2.2fr 1.4fr;
  gap:16px;
  align-items:flex-start;
}

.column-main{
  display:flex;
  flex-direction:column;
  gap:16px;
}
.column-side{
  display:flex;
  flex-direction:column;
  gap:16px;
}

.card{
  border-radius:18px;
  background:var(--card-bg);
  border:1px solid rgba(203,213,225,.8);
  padding:14px 14px 16px;
  box-shadow:0 10px 25px rgba(148,163,184,.25);
}
.card-soft{
  background:var(--card-soft);
}

.summary-grid{
  display:grid;
  grid-template-columns:repeat(4,minmax(0,1fr));
  gap:10px;
  margin-top:10px;
}

@media (max-width:1100px){
  .grid-1{
    grid-template-columns:1fr;
  }
}

@media (max-width:960px){
  .layout{
    flex-direction:column;
  }
  .sidebar{
    width:100%;
    flex-direction:row;
    align-items:center;
    justify-content:space-between;
  }
  .layout.collapsed .sidebar{
    width:100%;
  }
  .main{
    max-width:100%;
    padding:16px;
  }
}  /* ğŸ‘ˆ ì—¬ê¸°ì—ì„œ mediaë¥¼ ê¼­ ë‹«ì•„ì¤˜! */

/* Dashboard 3Ã—3 ë©”ì¸ ê·¸ë¦¬ë“œ */
.dash-grid{
  margin-top:16px;
  display:grid;
  grid-template-columns:repeat(3,minmax(0,1fr));
  gap:12px;
}

.dash-cell{
  background:var(--card-bg);
  border-radius:20px;
  padding:12px 14px 14px;
  box-shadow:0 14px 40px rgba(15,23,42,0.28);
  border:1px solid rgba(148,163,184,0.35);
  display:flex;
  flex-direction:column;
  min-height:120px;
}

.dash-cell-header{
  display:flex;
  flex-direction:column;
  gap:2px;
  margin-bottom:6px;
}

.dash-cell-title{
  font-size:13px;
  font-weight:700;
}

.dash-cell-sub{
  font-size:11px;
  color:var(--text-muted);
}

.dash-chart-wrap{
  margin-top:4px;
  height:90px;
}

.dash-chart-wrap canvas{
  width:100%;
  height:100%;
}

.dash-price{
  margin-top:6px;
  font-size:12px;
  color:var(--text-main);
}

.dash-news-list{
  list-style:none;
  padding:0;
  margin:4px 0 0;
  display:flex;
  flex-direction:column;
  gap:4px;
  font-size:12px;
}

.dash-news-list li{
  overflow:hidden;
  text-overflow:ellipsis;
  white-space:nowrap;
}

.dash-news-placeholder{
  color:var(--text-muted);
}

.dash-projects-wrap{
  margin-top:4px;
  font-size:12px;
  display:flex;
  flex-direction:column;
  gap:4px;
}

.dash-project-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:6px;
}

.dash-project-name{
  font-weight:600;
}

.dash-project-rank{
  font-size:11px;
  color:var(--text-muted);
}

.dash-extra-body{
  margin-top:6px;
  font-size:12px;
}

/* ì‘ì€ í™”ë©´ì—ì„œ 1ì—´ ë˜ëŠ” 2ì—´ë¡œ ë³€ê²½ */
@media (max-width: 1080px){
  .dash-grid{
    grid-template-columns:repeat(2,minmax(0,1fr));
  }
  #dash-leader{
    grid-column:span 2;
  }
}
@media (max-width: 720px){
  .dash-grid{
    grid-template-columns:1fr;
  }
  #dash-leader{
    grid-column:span 1;
  }
}
/* ì„±ì¥ ê·¸ë˜í”„ ì¹´ë“œ */
.growth-card{
  margin-top:16px;
}

.growth-card-title{
  font-size:14px;
  font-weight:700;
  margin-bottom:4px;
}

.growth-card-sub{
  font-size:11px;
  color:var(--text-muted);
}

.growth-chart-wrap{
  margin-top:10px;
}

/* ìš”ì•½ ì¹´ë“œ (ì›ê¸€ ê°œìˆ˜ / í‰ê·  ìŠ¤ì½”ì–´ / íŠ¸ë¦¼ë“œ í‰ê·  / ê°€ì¥ í„°ì§„ ê¸€) */
.summary-grid{
  margin-top:14px;
  display:grid;
  grid-template-columns:repeat(4,minmax(0,1fr));
  gap:12px;
}

/* ìš”ì•½ ì¹´ë“œ (ì›ê¸€ ê°œìˆ˜ / í‰ê·  ìŠ¤ì½”ì–´ / íŠ¸ë¦¼ë“œ í‰ê·  / ê°€ì¥ í„°ì§„ ê¸€) */
.summary-grid{
  margin-top:14px;
  display:grid;
  grid-template-columns:repeat(4,minmax(0,1fr));
  gap:12px;
}

.summary-card{
  position:relative;
  overflow:hidden;
  border-radius:18px;
  padding:14px 16px;
  display:flex;
  align-items:center;
  gap:12px;
  color:#f9fafb;
  box-shadow:0 16px 40px rgba(15,23,42,.25);
  border:1px solid rgba(148,163,184,.45);
}

/* ì¹´ë“œë³„ ê·¸ë¼ë””ì–¸íŠ¸ ìƒ‰ */
.summary-card--posts{
  background:linear-gradient(135deg,#6366f1,#3b82f6);
}
.summary-card--avg{
  background:linear-gradient(135deg,#0ea5e9,#22c55e);
}
.summary-card--trimmed{
  background:linear-gradient(135deg,#ec4899,#8b5cf6);
}
.summary-card--best{
  background:linear-gradient(135deg,#14b8a6,#38bdf8);
}

/* ì™¼ìª½ ë™ê·¸ë€ ë§ */
.summary-ring{
  width:46px;
  height:46px;
  border-radius:999px;
  border:3px solid rgba(248,250,252,.75);
  display:flex;
  align-items:center;
  justify-content:center;
  background:rgba(15,23,42,.18);
  backdrop-filter:blur(6px);
  flex-shrink:0;
}
.summary-ring span{
  font-size:18px;
}

.summary-text{
  display:flex;
  flex-direction:column;
  gap:2px;
}

.summary-label{
  font-size:11px;
  opacity:0.9;
}
.summary-value{
  font-size:18px;
  font-weight:800;
}
.summary-sub{
  font-size:10px;
  opacity:0.9;
}


.section-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  margin-bottom:10px;
  gap:8px;
}
.section-title{
  font-size:14px;
  font-weight:700;
  display:flex;
  gap:6px;
  align-items:center;
}
.section-sub{
  font-size:11px;
  color:var(--text-muted);
}

.grade-legend{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  font-size:10px;
  color:var(--text-muted);
}
.grade-dot{width:8px;height:8px;border-radius:999px}
.grade-dot.s{background:var(--grade-s)}
.grade-dot.a{background:var(--grade-a)}
.grade-dot.b{background:var(--grade-b)}
.grade-dot.c{background:var(--grade-c)}
.grade-dot.d{background:var(--grade-d)}

.grade-tabs{
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  margin-bottom:10px;
}
.grade-tab{
  padding:4px 10px;
  border-radius:999px;
  font-size:11px;
  border:1px solid rgba(209,213,219,.9);
  background:#ffffff;
  color:var(--text-muted);
  cursor:pointer;
  display:flex;
  gap:6px;
  align-items:center;
  transition:background .15s ease, transform .1s ease;
}
.grade-tab:hover{
  transform:translateY(-1px);
}
.grade-tab-dot{width:8px;height:8px;border-radius:999px}
.grade-tab.active{
  background:linear-gradient(135deg,#4f46e5,#06b6d4);
  color:#f9fafb;
  border-color:transparent;
}

.table-wrap{
  width:100%;overflow:auto;border-radius:14px;
  border:1px solid rgba(226,232,240,.9);
  background:#ffffff;
}
table{width:100%;border-collapse:collapse;min-width:680px;font-size:11px}
th,td{padding:8px;border-bottom:1px solid rgba(226,232,240,1);vertical-align:top}
th{
  background:#f8fafc;
  color:#6b7280;
  text-transform:uppercase;
  font-size:10px;
  position:sticky;top:0;z-index:1;
}
tr:last-child td{border-bottom:none}
tbody tr:hover td{background:#f9fafb}

.grade-badge{
  display:inline-flex;min-width:24px;padding:3px 7px;border-radius:999px;
  font-size:11px;font-weight:700;justify-content:center;
}
.grade-badge.s{background:rgba(251,191,36,.12);border:1px solid rgba(251,191,36,.8);color:var(--grade-s)}
.grade-badge.a{background:rgba(56,189,248,.12);border:1px solid rgba(56,189,248,.8);color:var(--grade-a)}
.grade-badge.b{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.8);color:var(--grade-b)}
.grade-badge.c{background:rgba(168,85,247,.12);border:1px solid rgba(168,85,247,.8);color:var(--grade-c)}
.grade-badge.d{background:rgba(148,163,184,.16);border:1px solid rgba(148,163,184,1);color:var(--grade-d)}

.stat-chip{
  display:inline-flex;gap:3px;font-size:10px;color:var(--text-muted);
  padding:2px 6px;border-radius:999px;border:1px solid rgba(209,213,219,1);
  background:#f9fafb;
}
.stat-chip strong{color:#111827}
.link-pill{
  padding:3px 7px;border-radius:999px;font-size:10px;
  border:1px solid rgba(59,130,246,.9);
  background:rgba(239,246,255,1);color:#1d4ed8;text-decoration:none;
  white-space:nowrap;
}

.leader-input-row{
  margin-bottom:10px;display:flex;gap:8px;flex-wrap:wrap;align-items:center;
}
.leader-input{
  flex:1;min-width:200px;
  border-radius:999px;border:1px solid rgba(209,213,219,1);
  background:#ffffff;color:#111827;
  padding:8px 14px;font-size:12px;
}
.leader-btn{
  border-radius:999px;border:none;
  background:linear-gradient(135deg,#4f46e5,#06b6d4);
  color:white;font-size:12px;padding:8px 16px;
  cursor:pointer;font-weight:600;
  box-shadow:0 10px 22px rgba(79,70,229,.45);
}
.leader-btn:disabled{opacity:.5;cursor:default}
.leader-note{font-size:11px;color:var(--text-muted);margin-top:2px}
.empty{font-size:12px;color:var(--text-muted);padding:8px 4px;text-align:center}

.text-main{font-size:11px;word-break:break-word;}
.text-meta{font-size:10px;color:var(--text-muted);margin-top:2px;}
.grade-chip{font-size:11px;color:var(--text-muted);}

.sort-select{
  border-radius:999px;
  border:1px solid rgba(209,213,219,1);
  background:#ffffff;
  color:#374151;
  font-size:11px;
  padding:4px 8px;
}

/* í”„ë¡œì íŠ¸ ë·° ì¶”ê°€ ìŠ¤íƒ€ì¼ */
.project-charts-row{
  overflow:hidden;
  display:flex;
  flex-wrap:wrap;
  gap:12px;
  justify-content:center;
}
.project-chart-single{
  flex:1;
  min-width:220px;
  max-width:320px;
}
.project-charts-row canvas{
  width:100% !important;
  height:160px;
}
.project-chart-title{
  font-size:13px;
  font-weight:600;
  color:var(--text-main);
  text-align:center;
  margin-bottom:8px;
}
.project-chart-wrap,
.project-grade-chart-wrap{
  width:100%;
  max-width:420px;
  margin:0 auto 12px;
}
.project-detail-controls{
  margin-top:14px;
  margin-bottom:8px;
  display:flex;
  gap:8px;
  align-items:center;
  flex-wrap:wrap;
  font-size:12px;
}
.project-select{
  border-radius:999px;
  border:1px solid rgba(209,213,219,1);
  background:#ffffff;
  padding:6px 10px;
  font-size:12px;
}

/* ì½”ì¹˜ ë´‡ ì¹´ë“œ */
.bot-card{
  background:
    radial-gradient(circle at 0% 0%, #e0f2fe, transparent 55%),
    radial-gradient(circle at 100% 0%, #ddd6fe, transparent 55%),
    #ffffff;
  position:relative;
  overflow:hidden;
}
.bot-chip{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 9px;
  border-radius:999px;
  font-size:11px;
  background:rgba(15,23,42,.05);
  border:1px solid rgba(148,163,184,.5);
  margin-bottom:6px;
}
.bot-output{
  font-size:11px;
  color:#111827;
  line-height:1.5;
  white-space:pre-line;
}
.bot-hint{
  font-size:10px;
  color:var(--text-muted);
  margin-top:6px;
}
  

/* ===== YAP ì‹ í˜¸ ì¹´ë“œ ===== */
.yap-card .yap-main{
  display:flex;
  flex-direction:column;
  gap:10px;
}
.yap-level{
  font-size:18px;
  font-weight:700;
  margin-top:2px;
}
.yap-sub{
  font-size:11px;
  color:var(--text-muted);
  margin-top:4px;
}
.yap-metrics{
  display:flex;
  flex-wrap:wrap;
  gap:10px;
  margin-top:6px;
}
.yap-metric{
  flex:1 1 70px;
  font-size:11px;
}
.yap-metric-label{
  color:var(--text-muted);
  margin-bottom:2px;
}
.yap-metric-value{
  font-weight:600;
  font-size:13px;
}
/* YAP ê°€ì¤‘ì¹˜ í† ê¸€ */
.yap-boost-toggles{
  margin-top:6px;
  display:flex;
  flex-direction:column;
  gap:3px;
}
.yap-toggle{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:10px;
  color:var(--text-muted);
  cursor:pointer;
}
.yap-toggle input{
  width:14px;
  height:14px;
}
/* ===== ì•¼í•‘ í”Œë˜ë„ˆ ì „ìš© ë ˆì´ì•„ì›ƒ ===== */
.yap-layout{
  display:grid;
  grid-template-columns:minmax(0,1.2fr) minmax(0,1.3fr);
  gap:16px;
  margin-top:8px;
}
@media (max-width:1024px){
  .yap-layout{
    grid-template-columns:1fr;
  }
}
.yap-form-grid{
  display:grid;
  grid-template-columns:repeat(2,minmax(0,1fr));
  gap:8px;
}
.yap-form-grid-1{
  display:grid;
  grid-template-columns:1fr;
  gap:8px;
}
.yap-label{
  font-size:11px;
  font-weight:600;
  margin-bottom:2px;
}
.yap-input,
.yap-select{
  width:100%;
  padding:7px 9px;
  border-radius:10px;
  border:1px solid rgba(209,213,219,1);
  background:#ffffff;
  font-size:12px;
}
.yap-input::placeholder{
  color:#9ca3af;
}
.yap-add-btn{
  margin-top:8px;
  width:100%;
  border:none;
  border-radius:999px;
  padding:8px 0;
  font-size:13px;
  font-weight:600;
  cursor:pointer;
  background:linear-gradient(135deg,#4f46e5,#06b6d4);
  color:#f9fafb;
  box-shadow:0 10px 24px rgba(79,70,229,.45);
}
.yap-list-empty{
  font-size:12px;
  color:var(--text-muted);
}
.yap-item{
  display:grid;
  grid-template-columns:auto minmax(0,1fr) auto;
  gap:8px;
  align-items:flex-start;
  padding:8px 9px;
  border-radius:12px;
  border:1px solid rgba(226,232,240,1);
  background:#f9fafb;
  margin-bottom:6px;
  font-size:11px;
}
.yap-item.done{
  opacity:.6;
  text-decoration:line-through;
}
.yap-tags{
  margin-top:2px;
  display:flex;
  flex-wrap:wrap;
  gap:4px;
}
.yap-tag{
  padding:2px 6px;
  border-radius:999px;
  border:1px solid rgba(209,213,219,1);
  background:#ffffff;
}
.yap-delete{
  border:none;
  background:transparent;
  color:#9ca3af;
  cursor:pointer;
  font-size:12px;
}

/* ===== InfoFi ë¦¬ë”ë³´ë“œ  ===== */
.infofi-hero{
  margin-top:8px;
  margin-bottom:12px;
}
.infofi-hero-title{
  font-size:14px;
  font-weight:700;
  margin-bottom:4px;
}
.infofi-hero-sub{
  font-size:11px;
  color:var(--text-muted);
  line-height:1.5;
}
.infofi-search-row{
  margin-top:10px;
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  align-items:center;
}
.infofi-search-input{
  flex:1;
  min-width:220px;
  border-radius:999px;
  border:1px solid rgba(209,213,219,1);
  background:#ffffff;
  padding:9px 14px;
  font-size:12px;
}
.infofi-search-btn{
  border-radius:999px;
  border:none;
  padding:9px 16px;
  font-size:12px;
  font-weight:600;
  cursor:pointer;
  background:linear-gradient(135deg,#4f46e5,#06b6d4);
  color:#f9fafb;
  box-shadow:0 10px 22px rgba(79,70,229,.45);
}
.infofi-handle-label{
  margin-top:8px;
  font-size:12px;
  color:var(--text-muted);
}
.infofi-handle-label b{
  color:#111827;
}
.infofi-hint{
  margin-top:6px;
  font-size:11px;
  color:var(--text-muted);
}
.infofi-projects-grid{
  display:flex;
  flex-direction:column;
  gap:12px;
}
.infofi-project-card{
  border-radius:16px;
  border:1px solid rgba(226,232,240,1);
  background:#f9fafb;
  padding:10px 12px 12px;
}
.infofi-project-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:6px;
  gap:8px;
}
.infofi-header-left{
  display:flex;
  align-items:center;
  gap:10px;
}
.infofi-logo{
  width:32px;
  height:32px;
  border-radius:50%;
  overflow:hidden;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:14px;
  font-weight:700;
  background:#e0f2fe;
  color:#0369a1;
  flex-shrink:0;
}
.infofi-logo img{
  width:100%;
  height:100%;
  object-fit:cover;
  display:block;
}

.infofi-project-main{
  display:flex;
  flex-direction:column;
  gap:2px;
}
.infofi-project-name{
  font-size:13px;
  font-weight:700;
}
.infofi-project-meta{
  font-size:11px;
  color:var(--text-muted);
}
.infofi-badge{
  font-size:10px;
  padding:3px 7px;
  border-radius:999px;
  border:1px solid rgba(191,219,254,1);
  background:#eff6ff;
  color:#1d4ed8;
}
.infofi-table-wrap{
  margin-top:6px;
}
.infofi-table{
  width:100%;
  border-collapse:collapse;
  font-size:11px;
}
.infofi-table th,
.infofi-table td{
  padding:6px 6px;
  border-bottom:1px solid rgba(226,232,240,1);
}
.infofi-table th{
  background:#f8fafc;
  color:var(--text-muted);
  text-align:left;
  font-size:10px;
}
.infofi-table tr:last-child td{
  border-bottom:none;
}
.infofi-empty{
  font-size:12px;
  color:var(--text-muted);
  text-align:center;
  padding:8px 4px;
}
@media (max-width:768px){
  .infofi-project-card{
    padding:10px 10px 12px;
  }
}

/* ===== ë‹¤í¬ ëª¨ë“œ ===== */
html.dark-theme{
  --bg:#020617;
  --bg-soft:#020617;
  --sidebar-bg:#020617;
  --card-bg:#020617;
  --card-soft:#020617;
  --text-main:#e5e7eb;
  --text-muted:#9ca3af;
  --border-soft:rgba(30,64,175,.7);
}
html.dark-theme body{
  background:#020617;
}
html.dark-theme .sidebar{
  border-right-color:rgba(30,64,175,.8);
  box-shadow:10px 0 35px rgba(15,23,42,.9);
}
html.dark-theme .card,
html.dark-theme .dash-cell{
  box-shadow:0 18px 45px rgba(15,23,42,.85);
}
html.dark-theme .top-sub,
html.dark-theme .section-sub{
  color:var(--text-muted);
}

/* ë‹¤í¬ ëª¨ë“œ í† ê¸€ */
.side-theme{
  margin-top:8px;
}
.theme-toggle-label{
  display:inline-flex;
  align-items:center;
  gap:6px;
  font-size:11px;
  color:var(--text-muted);
  cursor:pointer;
}
.theme-toggle-label input{
  width:32px;
  height:16px;
  border-radius:999px;
  appearance:none;
  -webkit-appearance:none;
  background:rgba(148,163,184,.6);
  position:relative;
  outline:none;
  cursor:pointer;
}
.theme-toggle-label input::before{
  content:"";
  position:absolute;
  top:2px;
  left:2px;
  width:12px;
  height:12px;
  border-radius:999px;
  background:#f9fafb;
  transition:transform .18s ease;
}
.theme-toggle-label input:checked{
  background:linear-gradient(135deg,#4f46e5,#06b6d4);
}
.theme-toggle-label input:checked::before{
  transform:translateX(14px);
}
.theme-toggle-text{
  opacity:.9;
}

/* YAP íˆíŠ¸ë§µ */
.yap-heatmap-card{
  margin-top:12px;
}
.yap-heatmap{
  margin-top:6px;
  display:flex;
  flex-wrap:wrap;
  gap:4px;
  min-height:22px;
}
.yap-heatbox{
  width:18px;
  height:18px;
  border-radius:4px;
  border:1px solid rgba(148,163,184,.45);
  box-shadow:0 2px 4px rgba(148,163,184,.35);
}
.yap-heatbox.level-1{background:#e0f2fe;}
.yap-heatbox.level-2{background:#bfdbfe;}
.yap-heatbox.level-3{background:#a5b4fc;}
.yap-heatbox.level-4{background:#f9a8d4;}
.yap-heatbox.level-5{background:#fb7185;}
.yap-heatmap-legend{
  display:flex;
  align-items:center;
  gap:6px;
  font-size:10px;
  color:var(--text-muted);
  margin-top:4px;
}
.yap-heatmap-legend-bar{
  display:inline-flex;
  gap:2px;
}
.yap-heatmap-legend-bar span{
  width:14px;
  height:10px;
  border-radius:4px;
}
.yap-heatmap-legend-bar .lvl-1{background:#e0f2fe;}
.yap-heatmap-legend-bar .lvl-2{background:#bfdbfe;}
.yap-heatmap-legend-bar .lvl-3{background:#a5b4fc;}
.yap-heatmap-legend-bar .lvl-4{background:#f9a8d4;}
.yap-heatmap-legend-bar .lvl-5{background:#fb7185;}


/* ê¸€ì“°ê¸° í† ê¸€ */
.community-toggle{
  display:flex;
  flex-direction:column;
  gap:4px;
  margin-bottom:8px;
}
.community-toggle-btn{
  align-self:flex-start;
  border-radius:999px;
  border:1px solid rgba(209,213,219,1);
  padding:6px 14px;
  font-size:12px;
  background:#f9fafb;
  cursor:pointer;
}
/* InfoFi ì¶œì²˜ */
.infofi-source-note{
  margin-top:6px;
  font-size:11px;
  color:var(--text-muted);
}
.infofi-source-note a{
  color:var(--accent);
  text-decoration:underline;
}

/* ===== ì»¤ë®¤ë‹ˆí‹° íƒ­ ===== */
.community-layout{
  margin-top:8px;
  max-width:880px;
  margin-left:auto;
  margin-right:auto;
}
@media (max-width: 900px){
  .community-layout{
    grid-template-columns:1fr;
  }
}
.community-form{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.community-form-label{
  font-size:11px;
  font-weight:600;
  color:var(--text-main);
}
.community-textarea{
  width:100%;
  min-height:80px;
  padding:8px 10px;
  border-radius:12px;
  border:1px solid rgba(209,213,219,1);
  resize:vertical;
  font-size:12px;
}
.community-input{
  width:100%;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid rgba(209,213,219,1);
  font-size:12px;
}
.community-submit{
  align-self:flex-end;
  margin-top:4px;
  border:none;
  border-radius:999px;
  padding:8px 16px;
  font-size:12px;
  font-weight:600;
  cursor:pointer;
  background:linear-gradient(135deg,#4f46e5,#06b6d4);
  color:#f9fafb;
  box-shadow:0 10px 22px rgba(79,70,229,.45);
}
.community-hint{
  font-size:11px;
  color:var(--text-muted);
}
.community-list{
  display:flex;
  flex-direction:column;
  gap:8px;
}
.community-empty{
  font-size:12px;
  color:var(--text-muted);
}
.community-post{
  border-radius:14px;
  border:1px solid rgba(226,232,240,1);
  background:#f9fafb;
  padding:8px 10px;
  font-size:12px;
}
.community-meta{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:11px;
  color:var(--text-muted);
  margin-bottom:4px;
}
.community-body{
  font-size:12px;
  white-space:pre-wrap;
  word-break:break-word;
}
.community-link{
  display:inline-flex;
  align-items:center;
  gap:4px;
  margin-top:4px;
  font-size:11px;
  color:#1d4ed8;
  text-decoration:none;
}
.community-actions{
  margin-top:6px;
  display:flex;
  gap:8px;
  align-items:center;
  font-size:11px;
  color:var(--text-muted);
}
.community-action-btn{
  border:none;
  background:transparent;
  cursor:pointer;
  font-size:11px;
  display:inline-flex;
  align-items:center;
  gap:3px;
  color:var(--text-muted);
}
.community-replies{
  margin-top:6px;
  padding-left:10px;
  border-left:2px solid rgba(209,213,219,0.8);
  display:flex;
  flex-direction:column;
  gap:6px;
}
.community-reply{
  font-size:11px;
}
.community-reply-meta{
  font-size:10px;
  color:var(--text-muted);
  margin-bottom:2px;
}
</style>
</head>

<body>
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <button id="sidebar-toggle" class="sidebar-toggle">âŸ¨</button>

    <div>
      <div class="side-profile">
        <div class="side-avatar">
          <img id="side-avatar-img" src="https://unavatar.io/twitter/bud_dha__" alt="avatar">
        </div>
        <div>
          <div class="side-name" id="side-username">ê²ŒìŠ¤íŠ¸</div>
          <a id="side-handle-link" href="https://twitter.com" target="_blank" class="side-handle">@ìµëª…</a>
          <button type="button" class="side-login-btn" id="nickname-btn">ë‹‰ë„¤ì„ ì„¤ì •</button>
        </div>
      </div>

      <div class="side-nav">
        <div class="side-nav-item active" data-view="dashboard">
          <span class="icon">ğŸ“Š</span><span class="side-label" id="nav-dashboard-label">Dashboard</span>
        </div>
        <div class="side-nav-item" data-view="csv">
          <span class="icon">ğŸ§®</span><span class="side-label" id="nav-csv-label">CSVë¡œ ë¶„ì„</span>
        </div>
        <div class="side-nav-item" data-view="leaderboard">
          <span class="icon">ğŸ†</span><span class="side-label" id="nav-leaderboard-label">ë¦¬ë”ë³´ë“œ</span>
        </div>
        <div class="side-nav-item" data-view="infofi">
          <span class="icon">ğŸ“¡</span><span class="side-label" id="nav-infofi-label">Kaito ë¦¬ë”ë³´ë“œ</span>
        </div>
        <div class="side-nav-item" data-view="history">
          <span class="icon">ğŸ—‚</span><span class="side-label" id="nav-history-label">ë‚´ íˆìŠ¤í† ë¦¬</span>
        </div>
        <div class="side-nav-item" data-view="projects">
          <span class="icon">ğŸ“š</span><span class="side-label" id="nav-projects-label">í”„ë¡œì íŠ¸ë³„ ë§ˆì¸ë“œì‰ì–´</span>
        </div>
        <div class="side-nav-item" data-view="yapping">
          <span class="icon">ğŸ“</span><span class="side-label" id="nav-yapping-label">ì•¼í•‘ í”Œë˜ë„ˆ</span>
        </div>
        <div class="side-nav-item" data-view="community">
          <span class="icon">ğŸ’¬</span><span class="side-label" id="nav-community-label">ì»¤ë®¤ë‹ˆí‹°</span>
        </div>
        <a class="side-nav-item" href="https://buddha913.github.io/crypto-fullcourse/" target="_blank">
          <span class="icon">ğŸ“˜</span><span class="side-label" id="nav-course-label">í¬ë¦½í†  í’€ì½”ìŠ¤</span>
        </a>
      </div>
    </div>

    <div class="side-footer">
      InfoFi Creator Console (Beta)
      <div class="side-badge">
        ì˜¤ëŠ˜ë„ í•œ ë²ˆ<br>ë§ˆì‰ í„°íŠ¸ë ¤ë³¼ê¹Œ? ğŸ’¥
      </div>
      <div class="side-theme">
        <label class="theme-toggle-label">
          <input type="checkbox" id="theme-toggle">
          <span class="theme-toggle-text">Dark</span>
        </label>
      </div>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="main">

    <!-- â–¼â–¼ Dashboard í™”ë©´ â–¼â–¼ -->
    
    <div id="view-dashboard">
      <div class="top-nav">
        <div>
          <div class="top-title">X í¬ë¦¬ì—ì´í„° ë§ˆì¸ë“œì‰ì–´ ë¶„ì„ê¸°</div>
          <div class="top-sub">BTC Â· ETH Â· í™˜ìœ¨ Â· ì˜¤ëŠ˜ì˜ ì´ìŠˆ Â· ìš°ë¦¬ ì‚¬ì´íŠ¸ ë¦¬ë”ë³´ë“œë¥¼ í•œ ë²ˆì— ë³´ëŠ” í™ˆ ëŒ€ì‹œë³´ë“œ</div>
        </div>
        <div class="top-cta">
          <div class="lang-toggle">
            <button class="lang-btn active" data-lang="ko">í•œêµ­ì–´</button>
            <button class="lang-btn" data-lang="en">EN</button>
          </div>
          <a class="analytics-link" href="https://analytics.twitter.com" target="_blank">X ì• ë„ë¦¬í‹±ìŠ¤ ì—´ê¸° â†—</a>
        </div>
      </div>

      <!-- ë©”ì¸ ê·¸ë¦¬ë“œ: BTC/ETH/ì´ìŠˆ Â· í™˜ìœ¨ Â· ë¦¬ë”ë³´ë“œ -->
      <div class="dash-grid">
        <!-- 1í–‰: BTC / ETH / ì˜¤ëŠ˜ì˜ ì´ìŠˆ -->
        <section class="dash-cell dash-asset" id="dash-btc">
          <div class="dash-cell-header">
            <div class="dash-cell-title">BTC</div>
            <div class="dash-cell-sub">ì‹¤ì‹œê°„ ê°€ê²© ê·¸ë˜í”„ (USD)</div>
          </div>
          <div class="dash-chart-wrap">
            <canvas id="btc-chart" height="90"></canvas>
          </div>
          <div class="dash-price" id="btc-price-text">ë¡œë“œ ì¤‘...</div>
        </section>

        <section class="dash-cell dash-asset" id="dash-eth">
          <div class="dash-cell-header">
            <div class="dash-cell-title">ETH</div>
            <div class="dash-cell-sub">ì‹¤ì‹œê°„ ê°€ê²© ê·¸ë˜í”„ (USD)</div>
          </div>
          <div class="dash-chart-wrap">
            <canvas id="eth-chart" height="90"></canvas>
          </div>
          <div class="dash-price" id="eth-price-text">ë¡œë“œ ì¤‘...</div>
        </section>

        <!-- 2í–‰: ì›í™” / ë‹¬ëŸ¬ / í”„ë¡œì íŠ¸ -->

        <section class="dash-cell dash-projects" id="dash-projects">
          <div class="dash-cell-header">
            <div class="dash-cell-title">ğŸ”¥ ì„œë²„ ê¸°ë°˜ í”„ë¡œì íŠ¸ Top5 (Beta)</div>
            <div class="dash-cell-sub" id="csv-server-top5-sub">CSVë¥¼ ì—…ë¡œë“œí•˜ë©´ ì„œë²„ ê¸°ì¤€ ìƒìœ„ 5ê°œ í”„ë¡œì íŠ¸ë¥¼ ì—¬ê¸°ì— ë³´ì—¬ì¤„ê²Œ.</div>
          </div>
          <div class="dash-projects-wrap" id="csv-server-top5-body">
            <div class="empty">ì•„ì§ ì„œë²„ ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
          </div>
        </section>

        <!-- 3í–‰: MUDDHA ë¦¬ë”ë³´ë“œ TOP 10 / ê³µë°±Â·ì¶”ì²œ -->
        <section class="dash-cell dash-leader" id="dash-leader" style="grid-column:span 3;">
          <div class="dash-cell-header">
            <div class="dash-cell-title">MUDDHA ë¦¬ë”ë³´ë“œ TOP 10</div>
            <div class="dash-cell-sub">CSV ê¸°ë°˜ ë§ˆì¸ë“œì‰ì–´ ë¦¬ë”ë³´ë“œ ìƒìœ„ 10ëª…</div>
          </div>
          <div class="table-wrap" id="dashboard-leaderboard-wrap">
            <div class="empty">ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
          </div>
        </section>
      </div>
    </div>

    <!-- â–²â–² Dashboard ë â–²â–² -->

    <!-- â–¼â–¼ CSV ë¶„ì„ í™”ë©´ â–¼â–¼ -->
<div id="view-csv">
      <div class="top-nav">
        <div>
          <div class="top-title">X í¬ë¦¬ì—ì´í„° ë§ˆì¸ë“œì‰ì–´ ë¶„ì„ê¸°</div>
          <div class="top-sub">ì• ë„ë¦¬í‹±ìŠ¤ CSVë¡œ ë‚´ ê³„ì •ì˜ ì§„ì§œ ì„íŒ©íŠ¸ë¥¼ ë³´ëŠ” ëŒ€ì‹œë³´ë“œ</div>
        </div>
        <div class="top-cta">
          <div class="lang-toggle">
            <button class="lang-btn" data-lang="ko">í•œêµ­ì–´</button>
            <button class="lang-btn" data-lang="en">EN</button>
          </div>
          <a class="top-link" href="https://analytics.twitter.com/user" target="_blank">
            X ì• ë„ë¦¬í‹±ìŠ¤ ì—´ê¸° â†—
          </a>
        </div>
      </div>

      <!-- HERO -->
      <section class="hero-card">
        <div class="hero-top-row">
          <div>
            <div class="hero-main-title">ë§ˆì¸ë“œì‰ì–´ ìŠ¤ì½”ì–´ Â· S~D ë“±ê¸‰ Â· ë¦¬ë”ë³´ë“œê¹Œì§€ í•œ ë²ˆì—</div>
            <div class="hero-desc">
              X ì• ë„ë¦¬í‹±ìŠ¤ì—ì„œ CSVë¥¼ ë‚´ë ¤ë°›ê³  ì´ê³³ì— ì—…ë¡œë“œí•˜ë©´,<br>
              ì›ê¸€ ê¸°ì¤€ìœ¼ë¡œ ë§ˆì¸ë“œì‰ì–´ ì ìˆ˜ì™€ ìƒìœ„ ê¸€, ë¦¬ë”ë³´ë“œê¹Œì§€ í•œ ë²ˆì— ë¶„ì„í•  ìˆ˜ ìˆì–´.
            </div>
            <div class="hero-pill"><span class="hero-dot"></span> CSV í•œ ë²ˆ â†’ ê³„ì • ë¶„ì„ ë</div>
          </div>
        </div>

        <div class="hero-upload-row">
          <div class="file-input-wrap">
            <div class="file-input-fake">ğŸ“ CSV íŒŒì¼ ì„ íƒí•˜ê¸°</div>
            <input type="file" id="csvInput" accept=".csv"/>
          </div>
          <span class="file-hint">account_analytics_content_YYYY-MM-DD_YYYY-MM-DD.csv ê·¸ëŒ€ë¡œ ì—…ë¡œë“œ</span>
          <button type="button" id="btn-last-csv" class="range-tab">ë§ˆì§€ë§‰ CSVë¡œ ì¡°íšŒí•˜ê¸°</button>
          <div id="last-snapshot-info" style="font-size:11px;color:#9ca3af;margin-top:4px;"></div>
        </div>

        <div class="badge"><span class="badge-dot"></span>í•œêµ­ì–´/ì˜ì–´ CSV ìë™ ì¸ì‹ Â· ë‹µê¸€ ì œì™¸ í›„ ì›ê¸€ë§Œ ë¶„ì„</div>

        <div id="range-tabs" class="range-tabs" style="display:none">
          <button class="range-tab active" data-range="ALL">ì „ì²´ ê¸°ê°„</button>
          <button class="range-tab" data-range="7">ìµœê·¼ 7ì¼</button>
          <button class="range-tab" data-range="30">ìµœê·¼ 30ì¼</button>
        </div>

        <div id="summary" class="summary-grid" style="display:none"></div>
        <div id="error" class="error"></div>
      </section>

      <!-- ë©”ì¸ ê·¸ë¦¬ë“œ: ì™¼ìª½(í‘œ), ì˜¤ë¥¸ìª½(ë´‡/ìš”ì•½) -->
      <div class="grid-1">
        <div class="column-main">
<!-- ğŸ“ˆ ê³„ì • ì„±ì¥ ê·¸ë˜í”„ ì¹´ë“œ -->
    <section class="card growth-card">
      <div class="growth-card-title" id="growth-title">ğŸ“ˆ ê³„ì • ì„±ì¥ ê·¸ë˜í”„</div>
      <div class="growth-card-sub" id="growth-sub">
        ìµœê·¼ ê¸°ê°„ ë™ì•ˆ ì›ê¸€ ê°œìˆ˜ / í‰ê·  ìŠ¤ì½”ì–´ ì¶”ì´ë¥¼ ê·¸ë˜í”„ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.
      </div>
      <div class="growth-chart-wrap">
        <!-- ë‚˜ì¤‘ì— JSì—ì„œ ì±„ìš¸ ìº”ë²„ìŠ¤ -->
        <canvas id="growth-chart" height="140"></canvas>
      </div>
    </section>
    <section class="card yap-heatmap-card">
      <div class="section-header">
        <div class="section-title">ğŸ“¡ YAP íˆíŠ¸ë§µ</div>
        <div class="section-sub">ë‚ ì§œë³„ íŠ¸ë¦¼ë“œ/í‰ê·  ìŠ¤ì½”ì–´ì™€ ì›ê¸€ ìˆ˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¶”ì •í•œ YAP ìƒìŠ¹ ì‹ í˜¸ ê°•ë„ì…ë‹ˆë‹¤.</div>
      </div>
      <div class="yap-heatmap-legend">
        <span>ë‚®ìŒ</span>
        <div class="yap-heatmap-legend-bar">
          <span class="lvl-1"></span>
          <span class="lvl-2"></span>
          <span class="lvl-3"></span>
          <span class="lvl-4"></span>
          <span class="lvl-5"></span>
        </div>
        <span>ë†’ìŒ</span>
      </div>
      <div id="yap-heatmap" class="yap-heatmap">
        <div class="empty">CSVë¥¼ ì—…ë¡œë“œí•˜ê³  ê¸°ê°„ì„ ì„ íƒí•˜ë©´ ë‚ ì§œë³„ YAP ì‹ í˜¸ë¥¼ ìƒ‰ìœ¼ë¡œ ë³´ì—¬ì¤„ê²Œ.</div>
      </div>
    </section>
          <section class="card">
            <div class="section-header">
              <div class="section-title" id="top10-title">
                ğŸ’¥ ë§ˆì¸ë“œì‰ì–´ í­ë°œ Top 10 <span id="top10-count"></span>
              </div>
              <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <div class="grade-chip">ì ìˆ˜ ê¸°ì¤€ Â· <strong>ë§ˆì¸ë“œì‰ì–´ ìŠ¤ì½”ì–´</strong></div>
                <select id="sort-key" class="sort-select">
                  <option value="score">ì •ë ¬: ìŠ¤ì½”ì–´</option>
                  <option value="impressions">ì •ë ¬: ë…¸ì¶œìˆ˜</option>
                  <option value="engagements">ì •ë ¬: ì°¸ì—¬ìˆ˜</option>
                  <option value="bookmarks">ì •ë ¬: ë¶ë§ˆí¬</option>
                  <option value="newFollows">ì •ë ¬: ì‹ ê·œ íŒ”ë¡œìš°</option>
                </select>
              </div>
            </div>
            <div class="table-wrap" id="top10-table-wrap"></div>
          </section>

          <section class="card">
            <div class="section-header">
              <div class="section-title" id="grade-section-title">ğŸš ë“±ê¸‰ë³„ ìƒìœ„ ê²Œì‹œê¸€ <span>(S~D)</span></div>
              <div class="grade-legend">
                <span><span class="grade-dot s"></span>S ìƒìœ„ 5%</span>
                <span><span class="grade-dot a"></span>A ìƒìœ„ 20%</span>
                <span><span class="grade-dot b"></span>B ìƒìœ„ 40%</span>
                <span><span class="grade-dot c"></span>C ìƒìœ„ 60%</span>
                <span><span class="grade-dot d"></span>D ê·¸ ì™¸</span>
              </div>
            </div>

            <div class="grade-tabs">
              <button class="grade-tab active" data-grade="ALL"><span class="grade-tab-dot" style="background:linear-gradient(90deg,var(--grade-s),var(--grade-a),var(--grade-b))"></span>ì „ì²´</button>
              <button class="grade-tab" data-grade="S"><span class="grade-tab-dot" style="background:var(--grade-s)"></span>S ë“±ê¸‰</button>
              <button class="grade-tab" data-grade="A"><span class="grade-tab-dot" style="background:var(--grade-a)"></span>A ë“±ê¸‰</button>
              <button class="grade-tab" data-grade="B"><span class="grade-tab-dot" style="background:var(--grade-b)"></span>B ë“±ê¸‰</button>
              <button class="grade-tab" data-grade="C"><span class="grade-tab-dot" style="background:var(--grade-c)"></span>C ë“±ê¸‰</button>
              <button class="grade-tab" data-grade="D"><span class="grade-tab-dot" style="background:var(--grade-d)"></span>D ë“±ê¸‰</button>
            </div>

            <div class="table-wrap" id="grade-table-wrap"></div>
          </section>
        </div>

        <!-- ì˜¤ë¥¸ìª½: ì½”ì¹˜ ë´‡ -->
        <div class="column-side">
          <section class="card bot-card">
            <div class="section-header">
              <div class="section-title" id="coach-title">ğŸ¤– ë§ˆì¸ë“œì‰ì–´ ì½”ì¹˜ ë´‡ <span style="font-size:11px;color:var(--text-muted);">(Beta)</span></div>
            </div>
            <div class="bot-chip">
              <span>ğŸ“Œ</span><span id="coach-chip-text">í˜„ì¬ ì„ íƒí•œ ê¸°ê°„ ê¸°ì¤€ Â· YAP ì‹ í˜¸ëŠ” ìµœê·¼ 7ì¼ ì •í™•ë„â†‘ í•œ ì¤„ ìš”ì•½ + í”¼ë“œë°±</span>
            </div>
            <div id="coach-output" class="bot-output">
              ì•„ì§ CSVë¥¼ ì˜¬ë¦¬ì§€ ì•Šì•˜ì–´.<br>
              ìƒë‹¨ì—ì„œ ì• ë„ë¦¬í‹±ìŠ¤ CSVë¥¼ ì—…ë¡œë“œí•˜ê³  ê¸°ê°„ íƒ­(ì „ì²´/7/30ì¼)ì„ ë°”ê¾¸ë©´<br>
              ì´ êµ¬ê°„ì˜ ë§ˆì¸ë“œì‰ì–´ ìƒíƒœë¥¼ ì½”ì¹˜ ë´‡ì´ ìë™ìœ¼ë¡œ ìš”ì•½í•´ ì¤„ ê±°ì•¼.
            </div>
            <div class="bot-hint">
              * ì„œë²„/LLM í˜¸ì¶œ ì—†ì´, ë‚´ ì• ë„ë¦¬í‹±ìŠ¤ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê·œì¹™ì ìœ¼ë¡œ ìš”ì•½í•´ ì£¼ëŠ” ì˜¤í”„ë¼ì¸ ì½”ì¹˜ì•¼.
            </div>
          </section>
          <section class="card yap-card" id="yap-card">
            <div class="section-header">
              <div class="section-title">ğŸ“¡ YAP ì‹ í˜¸ <span style="font-size:11px;color:var(--text-muted);">(Beta)</span></div>
            </div>
            <div class="yap-main">
              <div>
                <div class="yap-label" style="font-size:11px;color:var(--text-muted);">í˜„ì¬ ì„ íƒí•œ ê¸°ê°„ ê¸°ì¤€ Â· YAP ì‹ í˜¸ëŠ” ìµœê·¼ 7ì¼ ì •í™•ë„â†‘</div>
                <div class="yap-level" id="yap-level-text">-</div>
                <div class="yap-sub" id="yap-level-sub">
                  CSVë¥¼ ì—…ë¡œë“œí•˜ë©´ ìµœê·¼ íŒ¨í„´ì„ ê¸°ë°˜ìœ¼ë¡œ YAP ìƒìŠ¹ ì‹ í˜¸ë¥¼ ê°„ë‹¨íˆ ë³´ì—¬ì¤„ê²Œ.
                </div>
                <div class="yap-boost-toggles">
                  <label class="yap-toggle">
                    <input type="checkbox" id="yap-inner-toggle">
                    <span>ì´ë„ˆì„œí´ ê³„ì • (+30% ê°€ì¤‘ì¹˜)</span>
                  </label>
                  <label class="yap-toggle">
                    <input type="checkbox" id="yap-100-toggle">
                    <span>ìµœê·¼ YAP 100ì â†‘ ê²½í—˜ ìˆìŒ (+15% ê°€ì¤‘ì¹˜)</span>
                  </label>
                </div>
              </div>
              <div class="yap-metrics">
                <div class="yap-metric">
                  <div class="yap-metric-label">íŠ¸ë¦¼ë“œ ì ìˆ˜</div>
                  <div class="yap-metric-value" id="yap-trimmed">-</div>
                </div>
                <div class="yap-metric">
                  <div class="yap-metric-label">í‰ê·  ì ìˆ˜</div>
                  <div class="yap-metric-value" id="yap-avg">-</div>
                </div>
                <div class="yap-metric">
                  <div class="yap-metric-label">ì›ê¸€ ìˆ˜</div>
                  <div class="yap-metric-value" id="yap-posts">-</div>
                </div>
                <div class="yap-metric">
                  <div class="yap-metric-label">YAP ìƒìŠ¹ í™•ë¥ </div>
                  <div class="yap-metric-value" id="yap-prob">-</div>
                </div>
              </div>
            </div>
          </section>

        </div>
      </div>
    </div>

    <!-- â–²â–² CSV ë¶„ì„ í™”ë©´ ë â–²â–² -->



    <!-- â–¼â–¼ ë¦¬ë”ë³´ë“œ í™”ë©´ â–¼â–¼ -->
    <div id="view-leaderboard" style="display:none;">
      <div class="top-nav">
        <div>
          <div class="top-title">í¬ë¦¬ì—ì´í„° ë§ˆì¸ë“œì‰ì–´ ë¦¬ë”ë³´ë“œ</div>
          <div class="top-sub">ë‚´ ìˆœìœ„ Â· íŠ¸ë¦¼ë“œ í‰ê·  Â· ëŒ€í‘œ íŠ¸ìœ—ì„ í•œ ëˆˆì— ë³´ëŠ” ë­í‚¹ ë³´ë“œ</div>
        </div>
      </div>

      <section id="leaderboard-section" class="card" style="margin-top:8px;">
        <div class="section-header">
          <div class="section-title">ğŸ† í¬ë¦¬ì—ì´í„° ë§ˆì¸ë“œì‰ì–´ ë¦¬ë”ë³´ë“œ (Beta)</div>
        </div>

        <div class="leader-input-row">
          <input id="leader-handle" class="leader-input" placeholder="X í•¸ë“¤ ì…ë ¥ (ì˜ˆ: @bud_dha__)" />
          <button id="leader-save-btn" class="leader-btn">í˜„ì¬ ë¶„ì„ ê²°ê³¼ ì €ì¥</button>
        </div>
        <div class="leader-note" id="leader-note">â€» ìµœì†Œ ì›ê¸€ ìˆ˜ 20ê°œ ì´ìƒì¼ ë•Œ ë¦¬ë”ë³´ë“œ ì ìˆ˜ê°€ ë” ì •í™•í•©ë‹ˆë‹¤.</div>

        <div id="my-rank-wrap" style="margin-top:10px"></div>
        <div class="table-wrap" id="leaderboard-wrap" style="margin-top:10px"></div>
      </section>
    </div>
    <!-- â–²â–² ë¦¬ë”ë³´ë“œ í™”ë©´ ë â–²â–² -->


    <!-- â–¼â–¼ ë‚´ íˆìŠ¤í† ë¦¬ í™”ë©´ â–¼â–¼ -->
    <div id="view-history" style="display:none;">
      <div class="top-nav">
        <div>
          <div class="top-title">ë‚´ ë¶„ì„ íˆìŠ¤í† ë¦¬</div>
          <div class="top-sub">CSVë¥¼ ì—…ë¡œë“œí•  ë•Œë§ˆë‹¤ ì´ê³³ì— ìš”ì•½ ê¸°ë¡ì´ ìë™ìœ¼ë¡œ ìŒ“ì…ë‹ˆë‹¤.</div>
        </div>
      </div>

      <section class="card" style="margin-top:8px;">
        <div class="section-header">
          <div class="section-title">ğŸ“† ì—…ë¡œë“œ ê¸°ë¡</div>
          <div class="section-sub">ìµœê·¼ ì—…ë¡œë“œ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬ë©ë‹ˆë‹¤. (ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥)</div>
        </div>
        <div class="table-wrap" id="history-wrap">
          <div class="empty">ì•„ì§ ì €ì¥ëœ ë¶„ì„ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. CSVë¥¼ ì—…ë¡œë“œí•˜ë©´ ì—¬ê¸° ê¸°ë¡ì´ ìŒ“ì…ë‹ˆë‹¤.</div>
        </div>
      </section>
    </div>
    <!-- â–²â–² íˆìŠ¤í† ë¦¬ í™”ë©´ ë â–²â–² -->

    <!-- â–¼â–¼ í”„ë¡œì íŠ¸ë³„ ë§ˆì¸ë“œì‰ì–´ í™”ë©´ â–¼â–¼ -->
    <div id="view-projects" style="display:none;">
      <div class="top-nav">
        <div>
          <div class="top-title">í”„ë¡œì íŠ¸ë³„ ë§ˆì¸ë“œì‰ì–´</div>
          <div class="top-sub">íŠ¸ìœ— ë³¸ë¬¸ í‚¤ì›Œë“œ ê¸°ì¤€ìœ¼ë¡œ í”„ë¡œì íŠ¸ë³„ ì„íŒ©íŠ¸ì™€ ê²Œì‹œê¸€/ë“±ê¸‰ì„ ë¶„ì„í•©ë‹ˆë‹¤.</div>
        </div>
      </div>

      <section class="card card-soft">
        <div class="section-header">
          <div class="section-title" id="project-summary-title">ğŸ“š í”„ë¡œì íŠ¸ ìš”ì•½ + ì›í˜• ê·¸ë˜í”„</div>
          <div class="section-sub" id="project-summary-sub">ì½”ë“œ ìƒë‹¨ <code>PROJECTS</code> ë°°ì—´ì˜ í‚¤ì›Œë“œë¥¼ ë„¤ê°€ íŠ¸ëŠ” í”„ë¡œì íŠ¸ì— ë§ê²Œ ë°”ê¿”ì¤˜.</div>
        </div>

        <div class="project-charts-row">
          <div class="project-chart-single">
            <div class="project-chart-title" id="proj-chart-title-1">í”„ë¡œì íŠ¸ë³„ ê²Œì‹œê¸€ ë¹„ìœ¨</div>
            <canvas id="project-pie"></canvas>
          </div>
          <div class="project-chart-single">
            <div class="project-chart-title" id="proj-chart-title-2">ì„ íƒ ê¸°ê°„ ì „ì²´ S~D ë“±ê¸‰ ë¶„í¬</div>
            <canvas id="grade-distribution-pie"></canvas>
          </div>
          <div class="project-chart-single">
            <div class="project-chart-title" id="proj-chart-title-3">ì„ íƒ í”„ë¡œì íŠ¸ S~D ë“±ê¸‰ ë¶„í¬</div>
            <canvas id="project-grade-pie"></canvas>
          </div>
        </div>

        <div class="table-wrap" id="project-summary-wrap">
          <div class="empty">ë¨¼ì € Dashboardì—ì„œ CSVë¥¼ ì—…ë¡œë“œí•˜ê³  ë¶„ì„ì„ í•œ ë²ˆ ëŒë ¤ì¤˜.</div>
        </div>

        <div class="project-detail-controls">
          <span>ğŸ” í”„ë¡œì íŠ¸ë³„ ê²Œì‹œê¸€ ë³´ê¸°</span>
          <select id="project-select" class="project-select">
            <option value="">CSV ì—…ë¡œë“œ í›„ ìë™ í™œì„±í™”ë©ë‹ˆë‹¤.</option>
          </select>
        </div>
        <div class="table-wrap" id="project-detail-wrap">
          <div class="empty">í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ë©´ í•´ë‹¹ í”„ë¡œì íŠ¸ì˜ ê²Œì‹œê¸€ê³¼ ë“±ê¸‰ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
        </div>
      </section>
    </div>
    
    <!-- â–¼â–¼ ì•¼í•‘ í”Œë˜ë„ˆ í™”ë©´ â–¼â–¼ -->
    <div id="view-yapping" style="display:none;">
      <div class="top-nav">
        <div>
          <div class="top-title">ì•¼í•‘ & ë³´ìƒ í”Œë˜ë„ˆ</div>
          <div class="top-sub">
            ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ ê´€ë¦¬í•˜ë˜ <b>í•„ìˆ˜/ë³´ì¡° ì•¼í•‘ Â· ì£¼ê¸° Â· ê¸°ê°„ Â· ë³´ìƒ</b>ì„ ì´ í™”ë©´ì—ì„œ ì§ì ‘ ê´€ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            (ë¸Œë¼ìš°ì € <code>localStorage</code>ì— ì €ì¥)
          </div>
        </div>
      </div>

      <div class="yap-layout">
        <section class="card card-soft">
          <div class="section-header">
            <div class="section-title">ìƒˆ ì•¼í•‘ ê³„íš ì¶”ê°€</div>
            <div class="section-sub">ì—‘ì…€ í•œ ì¤„ = ì•„ë˜ í¼ í•œ ì¤„ì´ë¼ê³  ìƒê°í•˜ë©´ í¸í•´.</div>
          </div>

          <form id="yap-form">
            <div class="yap-form-grid">
              <div>
                <div class="yap-label">í•œêµ­ëª…</div>
                <input id="yap-kor" class="yap-input" placeholder="ì¹´ì´í† , ë¦¬ë²„, ë±…ì»¤ ..." />
              </div>
              <div>
                <div class="yap-label">í”„ë¡œì íŠ¸</div>
                <input id="yap-project" class="yap-input" placeholder="Kaito, River, Bankr ..." />
              </div>
              <div>
                <div class="yap-label">ê³„ì—´</div>
                <input id="yap-segment" class="yap-input" placeholder="ì¥ê¸° / ë‹¨ê¸° ë“±" />
              </div>
              <div>
                <div class="yap-label">ì•¼í•‘ íƒ€ì…</div>
                <select id="yap-type" class="yap-select">
                  <option value="í•„ìˆ˜">í•„ìˆ˜</option>
                  <option value="ë³´ì¡°">ë³´ì¡°</option>
                </select>
              </div>
            </div>

            <div class="yap-form-grid">
              <div>
                <div class="yap-label">ì•¼í•‘ ì£¼ê¸°</div>
                <input id="yap-frequency" class="yap-input" placeholder="ì¼2íšŒ / ì¼1íšŒ / ì£¼1íšŒ ..." />
              </div>
              <div>
                <div class="yap-label">ë³´ìƒ</div>
                <input id="yap-reward" class="yap-input" placeholder="$200, í¬ì¸íŠ¸, WL ë“±" />
              </div>
              <div>
                <div class="yap-label">ì‹œì‘ì¼</div>
                <input id="yap-start" type="date" class="yap-input" />
              </div>
              <div>
                <div class="yap-label">ì¢…ë£Œì¼</div>
                <input id="yap-end" type="date" class="yap-input" />
              </div>
            </div>

            <div class="yap-form-grid-1">
              <div>
                <div class="yap-label">ë©”ëª¨</div>
                <input id="yap-memo" class="yap-input" placeholder="ì˜ˆ: ì¼2íšŒ ìŠ¤ë ˆë“œ + ë””ìŠ¤ì½”ë“œ í›„ê¸°, ìµœì†Œ 2ê°œì›” ìœ ì§€" />
              </div>
            </div>

            <button class="yap-add-btn" type="submit">+ ì•¼í•‘ ê³„íš ì¶”ê°€</button>
          </form>
        </section>

        <section class="card card-soft">
          <div class="section-header">
            <div class="section-title">ë‚˜ì˜ ì•¼í•‘ ë¦¬ìŠ¤íŠ¸</div>
            <div class="section-sub">ì™¼ìª½ ì²´í¬ë°•ìŠ¤ëŠ” ì „ì²´ ì™„ë£Œ ì—¬ë¶€ ì²´í¬ ìš©ë„, ë©”ëª¨ê¹Œì§€ í•œ ëˆˆì— ì •ë¦¬.</div>
          </div>
          <div id="yap-list">
            <div class="yap-list-empty">ë“±ë¡ëœ ì•¼í•‘ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤. ì™¼ìª½ì—ì„œ ìƒˆ ê³„íšì„ ì¶”ê°€í•´ì¤˜.</div>
          </div>
        </section>
      </div>
    </div>
    <!-- â–²â–² ì•¼í•‘ í”Œë˜ë„ˆ í™”ë©´ ë â–²â–² -->

    <!-- â–¼â–¼ InfoFi ë¦¬ë”ë³´ë“œ í™”ë©´ â–¼â–¼ -->
    
    
    <!-- â–¼â–¼ ì»¤ë®¤ë‹ˆí‹° í™”ë©´ â–¼â–¼ -->
    <div id="view-community" style="display:none;">
      <div class="top-nav">
        <div>
          <div class="top-title">ì»¤ë®¤ë‹ˆí‹° (ë¡œì»¬ ì „ìš© ë² íƒ€)</div>
          <div class="top-sub">
            ë¸Œë¼ìš°ì €ì—ë§Œ ì €ì¥ë˜ëŠ” ì‘ì€ ì»¤ë®¤ë‹ˆí‹°ì•¼. ë‹‰ë„¤ì„ + ê¸€ + íŠ¸ìœ„í„° ë§í¬ë¥¼ ë‚¨ê¸°ê³ , ì„œë¡œ ëŒ“ê¸€ê³¼ ì¢‹ì•„ìš”ë¥¼ ë‚¨ê²¨ë³¼ ìˆ˜ ìˆì–´.
          </div>
        </div>
      </div>

      <div class="community-layout">
        <section class="card card-soft">
          <div class="section-header">
            <div class="section-title">ğŸ’¬ ìµœê·¼ ê¸€ & ê¸€ ì“°ê¸°</div>
            <div class="section-sub">
              ê°€ìš´ë°ì—ì„œ ë°”ë¡œ ê¸€ì„ ì½ê³ , í•„ìš”í•  ë•Œë§Œ ê¸€ ì“°ê¸° ì˜ì—­ì„ í¼ì¹  ìˆ˜ ìˆì–´.
            </div>
          </div>

          <div class="community-toggle">
            <button type="button" id="community-toggle-btn" class="community-toggle-btn">
              âœï¸ ìƒˆ ê¸€ ì“°ê¸° ì—´ê¸°
            </button>
            <div class="community-hint">
              Â· ì‚¬ì´ë“œë°” ë‹‰ë„¤ì„ ë²„íŠ¼ìœ¼ë¡œ ì´ë¦„ì„ ë¨¼ì € ì •í•´ë„ ì¢‹ì•„.<br>
              Â· ì´ ì»¤ë®¤ë‹ˆí‹°ì˜ ëª¨ë“  ë°ì´í„°ëŠ” ì´ ë¸Œë¼ìš°ì €ì˜ localStorageì—ë§Œ ì €ì¥ë¼.
            </div>
          </div>

          <form id="community-form" class="community-form" style="display:none;">
            <div>
              <div class="community-form-label">ë‚´ìš©</div>
              <textarea id="community-content" class="community-textarea" placeholder="ì˜¤ëŠ˜ì˜ ë§ˆì‰ / ì¸ì‚¬ì´íŠ¸ / ì¡ë‹´ ë“±ì„ ììœ ë¡­ê²Œ ë‚¨ê²¨ì¤˜."></textarea>
            </div>
            <div>
              <div class="community-form-label">íŠ¸ìœ„í„° ë§í¬ (ì„ íƒ)</div>
              <input id="community-twitter" class="community-input" placeholder="https://x.com/.... í˜•íƒœì˜ ë§í¬ë¥¼ ë¶™ì—¬ë„£ì–´ì¤˜." />
            </div>
            <button type="submit" class="community-submit">ê¸€ ì˜¬ë¦¬ê¸°</button>
          </form>

          <div id="community-list" class="community-list">
            <div class="community-empty">ì•„ì§ ë“±ë¡ëœ ê¸€ì´ ì—†ì–´. ì²« ê¸€ì„ ë‚¨ê²¨ë³¼ë˜?</div>
          </div>
        </section>
      </div>
    </div>
    <!-- â–²â–² ì»¤ë®¤ë‹ˆí‹° í™”ë©´ ë â–²â–² -->

<div id="view-infofi" style="display:none;">
      <div class="top-nav">
        <div>
          <div class="top-title">InfoFi ë¦¬ë”ë³´ë“œ</div>
          <div class="top-sub">
            Kaito / Cookie / ë“± InfoFi í”„ë¡œì íŠ¸ì˜ <b>í”„ë¡œì íŠ¸ë³„ ë¦¬ë”ë³´ë“œ ìˆœìœ„</b>
            <b></b>
          </div>
        </div>
      </div>

      <section class="card card-soft infofi-hero">
        <div class="infofi-hero-title">ğŸ” í•¸ë“¤ë¡œ ë‚´ InfoFi ìˆœìœ„ ì°¾ê¸°</div>
        <div class="infofi-hero-sub">
          ì˜ˆ: <code>@bud_dha__</code> ì²˜ëŸ¼ ì…ë ¥í•˜ë©´ë¨
        </div>

        <div class="infofi-search-row">
          <input id="infofi-handle-input" class="infofi-search-input" placeholder="@í•¸ë“¤ ì…ë ¥ (ì˜ˆ: @bud_dha__)" />
          <button type="button" class="infofi-search-btn" onclick="handleInfofiSearch()">ê²€ìƒ‰</button>
        </div>

        <div class="infofi-handle-label" id="infofi-handle-label"></div>
        <div class="infofi-hint">
          â€»  <code></code> ë”œë ˆì´ ìˆìŒ
        </div>
        <div class="infofi-source-note">
          ë°ì´í„° ì¶œì²˜: <a href="https://gomtu.xyz/kaito-leaderboard" target="_blank" rel="noopener">Gomtu Kaito Leaderboard</a>
        </div>
      </section>

      <section class="infofi-results card">
        <div id="infofi-result-wrap" class="infofi-projects-grid">
          <div class="empty">ë¨¼ì € ìœ„ì—ì„œ @í•¸ë“¤ì„ ì…ë ¥í•˜ê³  ê²€ìƒ‰ì„ ëˆŒëŸ¬ì¤˜.</div>
      </div>

      <!-- âœ… Kaito Leaderboard ê²°ê³¼ ì˜ì—­ (InfoFi ê²€ìƒ‰ê³¼ í†µí•©) -->
      
      <!-- âœ… Kaito Leaderboard ê²°ê³¼ (í…ìŠ¤íŠ¸ë§Œ í‘œì‹œ) -->
      <div
        id="kaito-result"
        style="margin-top:8px;font-size:13px;line-height:1.6;color:#e5e7eb;"
      ></div>


        </div>
      </section>
    </div>


    <!-- â–²â–² InfoFi ë¦¬ë”ë³´ë“œ í™”ë©´ ë â–²â–² -->

<!-- â–²â–² í”„ë¡œì íŠ¸ í™”ë©´ ë â–²â–² -->

  </main>
</div>




<script>
/* ========= ì„¤ì • ========= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw0yJIOdUoeRNwMn9fys-5ePI6UX6wkqBVhWNLrZ-gomO1sGNgTUJbhO0Kfj0n2QgdC/exec";
const MIN_POSTS_FOR_LEADERBOARD = 20;
const TRIM_RATIO = 0.1;
let CURRENT_LANG = "ko";


const THEME_KEY = "mindshare_theme_v1";
function applyThemeFromStorage(){
  try{
    const saved = localStorage.getItem(THEME_KEY) || "light";
    const root = document.documentElement;
    const toggle = document.getElementById("theme-toggle");
    if(saved === "dark"){
      root.classList.add("dark-theme");
      if(toggle) toggle.checked = true;
    }else{
      root.classList.remove("dark-theme");
      if(toggle) toggle.checked = false;
    }
  }catch(e){}
}
function initThemeToggle(){
  const toggle = document.getElementById("theme-toggle");
  if(!toggle) return;
  toggle.addEventListener("change", ()=>{
    const root = document.documentElement;
    try{
      if(toggle.checked){
        root.classList.add("dark-theme");
        localStorage.setItem(THEME_KEY,"dark");
      }else{
        root.classList.remove("dark-theme");
        localStorage.setItem(THEME_KEY,"light");
      }
    }catch(e){}
  });
}

const NICKNAME_KEY = "mindshare_nickname_v1";

function applyNicknameSidebar(){
  const nameSpan   = document.getElementById("side-username");
  const handleLink = document.getElementById("side-handle-link");
  const avatarImg  = document.getElementById("side-avatar-img");
  if (!nameSpan || !handleLink) return;

  const stored = (typeof localStorage !== "undefined")
    ? localStorage.getItem(NICKNAME_KEY)
    : null;

  if (!stored) {
    // ê¸°ë³¸ê°’: ê²ŒìŠ¤íŠ¸ ëª¨ë“œ
    nameSpan.textContent = "ê²ŒìŠ¤íŠ¸";
    handleLink.textContent = "@ìµëª…";
    handleLink.href = "javascript:void(0)";
    if (avatarImg) {
      avatarImg.src = "https://unavatar.io/twitter/guest";
    }
    return;
  }

  const nick = stored.trim().slice(0, 30) || "ê²ŒìŠ¤íŠ¸";
  nameSpan.textContent = nick;
  handleLink.textContent = "@" + nick;
  handleLink.href = "javascript:void(0)";
  if (avatarImg) {
    // ì™„ì „ ìµëª… ëŠë‚Œìœ¼ë¡œ, ë‹‰ë„¤ì„ ê¸°ë°˜ ì•„ë°”íƒ€
    avatarImg.src = "https://unavatar.io/twitter/" + encodeURIComponent(nick);
  }
}

function openNicknamePrompt(){
  let current = "";
  if (typeof localStorage !== "undefined") {
    current = localStorage.getItem(NICKNAME_KEY) || "";
  }
  const input = prompt("ì´ ë¸Œë¼ìš°ì €ì—ì„œ ì‚¬ìš©í•  ìµëª… ë‹‰ë„¤ì„ì„ ì •í•´ì¤˜ (ì˜ˆ: ë¶“ë‹¤-ì•¼í•‘ì¥ì¸)", current);
  if (!input) return;
  const nick = input.trim().slice(0, 30);
  if (!nick) return;
  if (typeof localStorage !== "undefined") {
    localStorage.setItem(NICKNAME_KEY, nick);
  }
  applyNicknameSidebar();
}

document.addEventListener("DOMContentLoaded", () => {
  applyNicknameSidebar();
  applyThemeFromStorage();
  initThemeToggle();
  const btn = document.getElementById("nickname-btn");
  if (btn) {
    btn.addEventListener("click", openNicknamePrompt);
  }

  // YAP ê°€ì¤‘ì¹˜ í† ê¸€ì´ ë°”ë€” ë•Œë§ˆë‹¤ ì¹´ë“œ/íˆíŠ¸ë§µ/ì„±ì¥ ê·¸ë˜í”„ ë‹¤ì‹œ ê·¸ë¦¬ê¸°
  const inner = document.getElementById("yap-inner-toggle");
  const top100 = document.getElementById("yap-100-toggle");
  const handleToggleChange = () => {
    if (!ANALYSIS || !CURRENT_LIST || !CURRENT_LIST.length) return;
    updateYapCard(ANALYSIS);
    renderYapHeatmap(CURRENT_LIST);
    renderGrowthChart(CURRENT_LIST);
  };
  [inner, top100].forEach(el => {
    if (el) el.addEventListener("change", handleToggleChange);
  });
});


/* ===== ì»¤ë®¤ë‹ˆí‹° ë¡œì»¬ ê²Œì‹œíŒ ===== */
const COMMUNITY_KEY = "mindshare_community_v1";

function getCurrentNicknameForCommunity(){
  try{
    const stored = (typeof localStorage !== "undefined")
      ? localStorage.getItem(NICKNAME_KEY)
      : null;
    const nick = stored && stored.trim() ? stored.trim().slice(0,30) : "ê²ŒìŠ¤íŠ¸";
    return nick;
  }catch(e){
    return "ê²ŒìŠ¤íŠ¸";
  }
}

function loadCommunityPosts(){
  try{
    const raw = localStorage.getItem(COMMUNITY_KEY);
    if (!raw) return [];
    const arr = JSON.parse(raw);
    if (!Array.isArray(arr)) return [];
    return arr;
  }catch(e){
    return [];
  }
}

function saveCommunityPosts(list){
  try{
    localStorage.setItem(COMMUNITY_KEY, JSON.stringify(list || []));
  }catch(e){}
}

function createCommunityPost({content, twitterUrl, parentId=null}){
  const now = Date.now();
  return {
    id: "c_" + now + "_" + Math.random().toString(36).slice(2,8),
    author: getCurrentNicknameForCommunity(),
    content: (content || "").trim(),
    twitterUrl: (twitterUrl || "").trim(),
    parentId: parentId,
    likes: 0,
    createdAt: now
  };
}

function renderCommunity(){
  const container = document.getElementById("community-list");
  if (!container) return;

  const posts = loadCommunityPosts();
  container.innerHTML = "";

  if (!posts.length){
    const empty = document.createElement("div");
    empty.className = "community-empty";
    empty.textContent = "ì•„ì§ ë“±ë¡ëœ ê¸€ì´ ì—†ì–´. ì²« ê¸€ì„ ë‚¨ê²¨ë³¼ë˜?";
    container.appendChild(empty);
    return;
  }

  // ìµœì‹  ìˆœ ì •ë ¬
  posts.sort((a,b) => (b.createdAt||0) - (a.createdAt||0));

  const topLevel = posts.filter(p => !p.parentId);
  const replies = posts.filter(p => p.parentId);

  topLevel.forEach(post => {
    const postEl = document.createElement("div");
    postEl.className = "community-post";

    const meta = document.createElement("div");
    meta.className = "community-meta";
    const authorSpan = document.createElement("span");
    authorSpan.textContent = post.author || "ê²ŒìŠ¤íŠ¸";
    const dateSpan = document.createElement("span");
    const d = new Date(post.createdAt || Date.now());
    const pad = n => (n<10?"0"+n:n);
    dateSpan.textContent = `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
    meta.appendChild(authorSpan);
    meta.appendChild(dateSpan);

    const body = document.createElement("div");
    body.className = "community-body";
    body.textContent = post.content || "";

    postEl.appendChild(meta);
    postEl.appendChild(body);

    if (post.twitterUrl){
      const link = document.createElement("a");
      link.className = "community-link";
      link.href = post.twitterUrl;
      link.target = "_blank";
      link.rel = "noopener";
      link.innerHTML = "íŠ¸ìœ„í„° ì—´ê¸° â†—";
      postEl.appendChild(link);
    }

    const actions = document.createElement("div");
    actions.className = "community-actions";

    const likeBtn = document.createElement("button");
    likeBtn.type = "button";
    likeBtn.className = "community-action-btn";
    const likesLabel = () => (post.likes || 0) ? `ì¢‹ì•„ìš” ${post.likes}` : "ì¢‹ì•„ìš”";
    likeBtn.textContent = likesLabel();
    likeBtn.addEventListener("click", () => {
      const all = loadCommunityPosts();
      const found = all.find(p => p.id === post.id);
      if (found){
        found.likes = (found.likes || 0) + 1;
        saveCommunityPosts(all);
        renderCommunity();
      }
    });

    const replyBtn = document.createElement("button");
    replyBtn.type = "button";
    replyBtn.className = "community-action-btn";
    replyBtn.textContent = "ë‹µê¸€ ë‹¬ê¸°";
    replyBtn.addEventListener("click", () => {
      const text = prompt("ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì¤˜:");
      if (!text || !text.trim()) return;
      const all = loadCommunityPosts();
      const reply = createCommunityPost({content:text, twitterUrl:"", parentId:post.id});
      all.push(reply);
      saveCommunityPosts(all);
      renderCommunity();
    });

    actions.appendChild(likeBtn);
    actions.appendChild(replyBtn);
    postEl.appendChild(actions);

    // í•˜ìœ„ ë‹µê¸€ ë Œë”ë§
    const children = replies.filter(r => r.parentId === post.id);
    if (children.length){
      const repliesWrap = document.createElement("div");
      repliesWrap.className = "community-replies";
      children
        .sort((a,b)=> (a.createdAt||0) - (b.createdAt||0))
        .forEach(rep => {
          const repEl = document.createElement("div");
          repEl.className = "community-reply";
          const repMeta = document.createElement("div");
          repMeta.className = "community-reply-meta";
          const d2 = new Date(rep.createdAt || Date.now());
          const pad2 = n => (n<10?"0"+n:n);
          repMeta.textContent = `${rep.author || "ê²ŒìŠ¤íŠ¸"} Â· ${d2.getFullYear()}.${pad2(d2.getMonth()+1)}.${pad2(d2.getDate())} ${pad2(d2.getHours())}:${pad2(d2.getMinutes())}`;
          const repBody = document.createElement("div");
          repBody.textContent = rep.content || "";
          repEl.appendChild(repMeta);
          repEl.appendChild(repBody);
          repliesWrap.appendChild(repEl);
        });
      postEl.appendChild(repliesWrap);
    }

    container.appendChild(postEl);
  });
}


function initCommunity(){
  const form = document.getElementById("community-form");
  const contentEl = document.getElementById("community-content");
  const twitterEl = document.getElementById("community-twitter");
  const toggleBtn = document.getElementById("community-toggle-btn");
  if (!form || !contentEl) return;

  // í† ê¸€ ë²„íŠ¼: ê¸€ì“°ê¸° ì˜ì—­ ì—´ê³ /ë‹«ê¸°
  if (toggleBtn){
    toggleBtn.addEventListener("click", () => {
      const isHidden = form.style.display === "none" || !form.style.display;
      if (isHidden){
        form.style.display = "flex";
        toggleBtn.textContent = "â¬‡ ê¸€ì“°ê¸° ì ‘ê¸°";
      }else{
        form.style.display = "none";
        toggleBtn.textContent = "âœï¸ ìƒˆ ê¸€ ì“°ê¸° ì—´ê¸°";
      }
    });
  }

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const content = contentEl.value || "";
    const twitterUrl = twitterEl ? twitterEl.value || "" : "";
    if (!content.trim()){
      alert("ë‚´ìš©ì„ ì…ë ¥í•´ì¤˜!");
      return;
    }
    const posts = loadCommunityPosts();
    const newPost = createCommunityPost({content, twitterUrl});
    posts.push(newPost);
    saveCommunityPosts(posts);
    contentEl.value = "";
    if (twitterEl) twitterEl.value = "";

    // ê¸€ ì‘ì„± í›„ ìë™ ì ‘ê¸°
    if (toggleBtn){
      form.style.display = "none";
      toggleBtn.textContent = "âœï¸ ìƒˆ ê¸€ ì“°ê¸° ì—´ê¸°";
    }

    renderCommunity();
  });

  // ìµœì´ˆ ë¡œë”© ì‹œ í•œ ë²ˆ ë Œë”
  renderCommunity();
}
/* í”„ë¡œì íŠ¸ í‚¤ì›Œë“œ (ì›í•˜ë©´ ì—¬ê¸° ìˆ˜ì •) */
/* í”„ë¡œì íŠ¸ í‚¤ì›Œë“œ (ì´ë¯¸ì§€ì— ë‚˜ì˜¨ í”„ë¡œì íŠ¸ + ì£¼ìš” ì•¼í•‘ í”„ë¡œì íŠ¸) */
const PROJECTS = [
  // --- L0 / L1 ---
  { id: "aptos",       label: "Aptos",                  category: "L0/L1", keywords: ["aptos"] },
  { id: "beldex",      label: "Beldex",                 category: "L0/L1", keywords: ["beldex"] },
  { id: "berachain",   label: "Berachain",              category: "L0/L1", keywords: ["berachain"] },
  { id: "camp",        label: "Camp Network",           category: "L0/L1", keywords: ["camp network","campnet"] },
  { id: "ethereum",    label: "Ethereum",               category: "L0/L1", keywords: ["ethereum","eth "] },
  { id: "fogo",        label: "Fogo",                   category: "L0/L1", keywords: ["fogo"] },
  { id: "injective",   label: "Injective",              category: "L0/L1", keywords: ["injective","inj "] },
  { id: "irys",        label: "Irys",                   category: "L0/L1", keywords: ["irys"] },
  { id: "kaia",        label: "Kaia",                   category: "L0/L1", keywords: ["kaia"] },
  { id: "mantra",      label: "MANTRA",                 category: "L0/L1", keywords: ["mantra"] },
  { id: "mavryk",      label: "Mavryk",                 category: "L0/L1", keywords: ["mavryk"] },
  { id: "mitosis",     label: "Mitosis",                category: "L0/L1", keywords: ["mitosis"] },
  { id: "monad",       label: "Monad",                  category: "L0/L1", keywords: ["monad"] },
  { id: "movement",    label: "Movement",               category: "L0/L1", keywords: ["movement"] },
  { id: "near",        label: "Near",                   category: "L0/L1", keywords: ["near"] },
  { id: "peaq",        label: "PEAQ",                   category: "L0/L1", keywords: ["peaq"] },
  { id: "polkadot",    label: "Polkadot",               category: "L0/L1", keywords: ["polkadot","dot "] },
  { id: "sei",         label: "Sei",                    category: "L0/L1", keywords: ["sei "] },
  { id: "somnia",      label: "Somnia",                 category: "L0/L1", keywords: ["somnia"] },
  { id: "sonic",       label: "Sonic (L1)",             category: "L0/L1", keywords: ["sonic chain","sonic l1","sonic mainnet"] },
  { id: "story",       label: "Story",                  category: "L0/L1", keywords: ["story protocol","story chain"] },
  { id: "xion",        label: "XION",                   category: "L0/L1", keywords: ["xion"] },

  // --- L2 ---
  { id: "arbitrum",    label: "Arbitrum",               category: "L2",    keywords: ["arbitrum","arb "] },
  { id: "katana",      label: "Katana",                 category: "L2",    keywords: ["katana"] },
  { id: "mantle",      label: "Mantle",                 category: "L2",    keywords: ["mantle"] },
  { id: "megaeth",     label: "MegaETH",                category: "L2",    keywords: ["megaeth"] },
  { id: "polygon",     label: "Polygon",                category: "L2",    keywords: ["polygon","matic"] },
  { id: "soon",        label: "SOON",                   category: "L2",    keywords: ["soon network","soon chain"] },

  // --- DeFi / Infra ---
  { id: "falcon",      label: "Falcon Finance",         category: "DeFi",  keywords: ["falcon finance","falconfi"] },
  { id: "frax",        label: "Frax",                   category: "DeFi",  keywords: ["frax"] },
  { id: "huma",        label: "Huma",                   category: "DeFi",  keywords: ["huma"] },
  { id: "moremarkets", label: "MoreMarkets",            category: "DeFi",  keywords: ["moremarkets","more markets"] },
  { id: "multipli",    label: "Multipli",               category: "DeFi",  keywords: ["multipli"] },
  { id: "noble",       label: "Noble",                  category: "DeFi",  keywords: ["noble chain","noble network"] },
  { id: "orderly",     label: "Orderly",                category: "DeFi",  keywords: ["orderly","orderly network","orderly omni"] },
  { id: "pyth",        label: "Pyth",                   category: "DeFi",  keywords: ["pyth oracle","pyth network"] },
  { id: "soul",        label: "Soul Protocol",          category: "DeFi",  keywords: ["soul protocol"] },
  { id: "stbl",        label: "STBL",                   category: "DeFi",  keywords: ["stbl","usst","yld","stablecoin 2.0"] },
  { id: "turtle",      label: "Turtle Club",            category: "DeFi",  keywords: ["turtle club"] },
  { id: "walrus",      label: "Walrus",                 category: "DeFi",  keywords: ["walrus"] },

  // --- AI Agents / Agent Infra ---
  { id: "creatorbid",  label: "CreatorBid",             category: "AI Agents", keywords: ["creatorbid"] },
  { id: "infinit",     label: "INFINIT",                category: "AI Agents", keywords: ["infinit"] },
  { id: "newton",      label: "Newton",                 category: "AI Agents", keywords: ["newton ai"] },
  { id: "surf",        label: "Surf",                   category: "AI Agents", keywords: ["surf ai","surf agent"] },
  { id: "symphony",    label: "Symphony",               category: "AI Agents", keywords: ["symphony","symphony finance","symphony router"] },
  { id: "talus",       label: "Talus",                  category: "AI Agents", keywords: ["talus"] },
  { id: "theoriq",     label: "Theoriq",                category: "AI Agents", keywords: ["theoriq"] },
  { id: "virtuals",    label: "Virtuals Protocol",      category: "AI Agents", keywords: ["virtuals","virtuals protocol"] },
  { id: "warden",      label: "Warden Protocol",        category: "AI Agents", keywords: ["warden protocol"] },
  { id: "wayfinder",   label: "Wayfinder",              category: "AI Agents", keywords: ["wayfinder"] },

  // --- Culture / NFT ---
  { id: "anime",       label: "ANIME",                  category: "Culture", keywords: ["anime token","anime protocol"] },
  { id: "boop",        label: "Boop",                   category: "Culture", keywords: ["boop"] },
  { id: "doodles",     label: "Doodles",                category: "Culture", keywords: ["doodles"] },
  { id: "memex",       label: "MemeX",                  category: "Culture", keywords: ["memex"] },
  { id: "moonbirds",   label: "Moonbirds",              category: "Culture", keywords: ["moonbirds"] },
  { id: "pengu",       label: "PENGU",                  category: "Culture", keywords: ["pengu"] },

  // --- BTCFi ---
  { id: "corn",        label: "Corn",                   category: "BTCFi",  keywords: ["corn"] },
  { id: "goat",        label: "GOAT Network",           category: "BTCFi",  keywords: ["goat network"] },
  { id: "lombard",     label: "Lombard",                category: "BTCFi",  keywords: ["lombard"] },
  { id: "portalbtc",   label: "Portal to BTC",          category: "BTCFi",  keywords: ["portal to btc","portal btc"] },
  { id: "satlayer",    label: "SatLayer",               category: "BTCFi",  keywords: ["satlayer"] },

  // --- Robotics ---
  { id: "openmind",    label: "Openmind",               category: "Robotics", keywords: ["openmind"] },

  // --- ZK ---
  { id: "boundless",   label: "Boundless",              category: "ZK", keywords: ["boundless"] },
  { id: "brevis",      label: "Brevis",                 category: "ZK", keywords: ["brevis"] },
  { id: "cysic",       label: "Cysic",                  category: "ZK", keywords: ["cysic"] },
  { id: "miden",       label: "Miden",                  category: "ZK", keywords: ["miden"] },
  { id: "starknet",    label: "Starknet",               category: "ZK", keywords: ["starknet"] },
  { id: "succinct",    label: "Succinct",               category: "ZK", keywords: ["succinct"] },
  { id: "zcash",       label: "Zcash",                  category: "ZK", keywords: ["zcash"] },
  { id: "zkpass",      label: "zkPass",                 category: "ZK", keywords: ["zkpass"] },

  // --- Others ---
  { id: "anoma",       label: "Anoma",                  category: "Others", keywords: ["anoma"] },
  { id: "bless",       label: "Bless",                  category: "Others", keywords: ["bless protocol"] },
  { id: "bybittradfi", label: "Bybit TradFi",           category: "Others", keywords: ["bybit tradfi"] },
  { id: "humanity",    label: "Humanity Protocol",      category: "Others", keywords: ["humanity protocol"] },
  { id: "integra",     label: "Integra",                category: "Others", keywords: ["integra"] },
  { id: "multibank",   label: "Multibank",              category: "Others", keywords: ["multibank"] },
  { id: "thrive",      label: "Thrive Protocol",        category: "Others", keywords: ["thrive protocol"] },

  // --- Exchange / Perp ---
  { id: "apex",        label: "ApeX",                   category: "Exchange", keywords: ["apex pro","apex dex"] },
  { id: "bluefin",     label: "Bluefin",                category: "Exchange", keywords: ["bluefin"] },
  { id: "dydx",        label: "dYdX",                   category: "Exchange", keywords: ["dydx"] },
  { id: "flipster",    label: "Flipster",               category: "Exchange", keywords: ["flipster"] },
  { id: "mememax",     label: "MemeMax",                category: "Exchange", keywords: ["mememax","mememax_fi","@mememax_fi","memax"] },
  { id: "momentum",    label: "Momentum",               category: "Exchange", keywords: ["momentum"] },
  { id: "paradex",     label: "PARADEX",                category: "Exchange", keywords: ["paradex"] },

  // --- AI / InfoFi ---
  { id: "kaito",       label: "Kaito / Yapper",         category: "AI", keywords: ["kaito","kaito ai","yapper","yap points","infofi"] },
  { id: "og",          label: "OG",                     category: "AI", keywords: ["og protocol"] },
  { id: "allora",      label: "Allora",                 category: "AI", keywords: ["allora"] },
  { id: "billions",    label: "Billions Network",       category: "AI", keywords: ["billions network"] },
  { id: "edgen",       label: "Edgen",                  category: "AI", keywords: ["edgen"] },
  { id: "everlynai",   label: "EverlynAI",              category: "AI", keywords: ["everlynai"] },
  { id: "iq",          label: "IQ",                     category: "AI", keywords: ["iq ai","iq token"] },
  { id: "kindred",     label: "Kindred",                category: "AI", keywords: ["kindred"] },
  { id: "mira",        label: "Mira Network",           category: "AI", keywords: ["mira network"] },
  { id: "novastro",    label: "Novastro",               category: "AI", keywords: ["novastro"] },
  { id: "noya",        label: "Noya.ai",                category: "AI", keywords: ["noya.ai","noya ai"] },
  { id: "openledger",  label: "OpenLedger",             category: "AI", keywords: ["openledger"] },
  { id: "pipworld",    label: "PiP World",              category: "AI", keywords: ["pip world","pipworld"] },
  { id: "playai",      label: "PlayAI",                 category: "AI", keywords: ["playai","play ai"] },
  { id: "sapien",      label: "Sapien",                 category: "AI", keywords: ["sapien"] },
  { id: "sentient",    label: "Sentient",               category: "AI", keywords: ["sentient"] },
  { id: "uxlink",      label: "UXLINK",                 category: "AI", keywords: ["uxlink"] },

  // --- Consumer / Apps ---
  { id: "tria",        label: "Tria",                   category: "Consumer", keywords: ["tria","use tria","@useTria"] },
  { id: "anichess",    label: "Anichess",               category: "Consumer", keywords: ["anichess"] },
  { id: "bitdealer",   label: "Bitdealer",              category: "Consumer", keywords: ["bitdealer"] },
  { id: "defiapp",     label: "Defi App",               category: "Consumer", keywords: ["defi app"] },
  { id: "hana",        label: "Hana",                   category: "Consumer", keywords: ["hana app"] },
  { id: "infinex",     label: "Infinex",                category: "Consumer", keywords: ["infinex"] },
  { id: "lumiterra",   label: "Lumiterra",              category: "Consumer", keywords: ["lumiterra"] },
  { id: "maplestory",  label: "MapleStory Universe",    category: "Consumer", keywords: ["maplestory universe","msu"] },
  { id: "metawin",     label: "Metawin",                category: "Consumer", keywords: ["metawin"] },
  { id: "parti",       label: "Parti",                  category: "Consumer", keywords: ["parti"] },
  { id: "puffpaw",     label: "Puffpaw",                category: "Consumer", keywords: ["puffpaw"] },
  { id: "rainbow",     label: "Rainbow",                category: "Consumer", keywords: ["rainbow wallet","rainbow app"] },
  { id: "sidekick",    label: "Sidekick",               category: "Consumer", keywords: ["sidekick"] },
  { id: "sixr",        label: "SIXR Cricket",           category: "Consumer", keywords: ["sixr cricket","sixr"] },
  { id: "sophon",      label: "Sophon",                 category: "Consumer", keywords: ["sophon"] },
  { id: "vultisig",    label: "Vultisig",               category: "Consumer", keywords: ["vultisig"] },
  { id: "yeet",        label: "YEET",                   category: "Consumer", keywords: ["yeet"] },

  // --- Interop ---
  { id: "caldera",     label: "Caldera",                category: "Interop", keywords: ["caldera"] },
  { id: "initia",      label: "Initia",                 category: "Interop", keywords: ["initia"] },
  { id: "skate",       label: "Skate",                  category: "Interop", keywords: ["skate"] },
  { id: "union",       label: "Union",                  category: "Interop", keywords: ["union"] },

  // --- RWA ---
  { id: "kaio",        label: "KAIO",                   category: "RWA", keywords: ["kaio","kaio network"] },
  { id: "theo",        label: "Theo Network",           category: "RWA", keywords: ["theo","theo network","thbill","tultra"] },

  // --- Snapper / Campaign style(ë§ˆì¸ë“œì‰ì–´ìš©) ---
  { id: "superform",   label: "Superform",              category: "Campaign", keywords: ["superform","superformxyz","@superformxyz"] },
  { id: "glint",       label: "Glint Analytics",        category: "Campaign", keywords: ["glint analytics","@glintanalytics"] },
  { id: "solv",        label: "Solv Protocol",          category: "Campaign", keywords: ["solv protocol","@solvprotocol"] },
  { id: "pacifica",    label: "Pacifica",               category: "Campaign", keywords: ["pacifica_fi","@pacifica_fi","pacifica fi"] },
  { id: "layerbank",   label: "LayerBank",              category: "Campaign", keywords: ["layerbank","layerbankfi","@layerbankfi"] },
  { id: "rayls",       label: "Rayls",                  category: "Campaign", keywords: ["rayls","@RaylsLabs","raylslabs"] },
  { id: "velora",      label: "Velora",                 category: "Campaign", keywords: ["velora","veloradex","@veloradex"] },
  { id: "antix",       label: "Antix",                  category: "Campaign", keywords: ["antix","@antix_in"] },
  { id: "almanak",     label: "Almanak",                category: "Campaign", keywords: ["almanak","@Almanak"] },
  { id: "bob",         label: "BOB",                    category: "Campaign", keywords: ["bob","build on bitcoin","@build_on_bob"] },
  { id: "ten",         label: "TEN Protocol",           category: "Campaign", keywords: ["ten protocol","@tenprotocol","ten app"] },
  { id: "vooi",        label: "Vooi",                   category: "Campaign", keywords: ["vooi","@vooi_io","vooi io"] },

  // --- ë„ˆ ì „ìš©(ì´ë¯¸ CSVì—ì„œ ìì£¼ ì“°ëŠ” ê²ƒë“¤) ---
  { id: "river",       label: "River / satUSD",         category: "Stable", keywords: ["river","satusd","sat usd","river4fun","river4 fun","@riverhq"] },
  { id: "cookie",      label: "Cookie.fun",             category: "InfoFi", keywords: ["cookie.fun","cookie fun","cookie leaderboard","@cookie_fun"] },
  { id: "bnkr",        label: "BNKR / BANKR",           category: "Social", keywords: ["bnkr","bankr","bankr leaderboard","@bnkr_network"] }
];


let ANALYSIS = null;
let ALL_BASE = [];
let CURRENT_LIST = [];
let buckets = { S:[], A:[], B:[], C:[], D:[] };
let CURRENT_RANGE = "ALL";
let CURRENT_GRADE = "ALL";
let SORT_KEY = "score";

/* í”„ë¡œì íŠ¸ í†µê³„/ì°¨íŠ¸ìš© */
let PROJECT_STATS = [];
let projectChart = null;
let globalGradeChart = null;
let projectGradeChart = null;

/* ========== CSV í—¤ë” ë§¤í•‘/ìˆ«ì ========== */
function autoMap(row) {
  const map = {
    "ê²Œì‹œë¬¼ ë³¸ë¬¸": "text", "Post text": "text", "Tweet text": "text",
    "ãƒ„ã‚¤ãƒ¼ãƒˆãƒ†ã‚­ã‚¹ãƒˆ": "text", "ãƒ„ã‚¤ãƒ¼ãƒˆæœ¬æ–‡": "text", "æ¨æ–‡æ–‡æœ¬": "text", "å¸–å­æ–‡æœ¬": "text",
    "ë‚ ì§œ": "date", "Date": "date", "æ—¥ä»˜": "date", "æ—¥æœŸ": "date",
    "ê²Œì‹œë¬¼ ë§í¬": "link", "Tweet permalink": "link","URL":"link","Link":"link",
    "ãƒ„ã‚¤ãƒ¼ãƒˆãƒªãƒ³ã‚¯": "link", "æ¨æ–‡é“¾æ¥": "link",
    "ê²Œì‹œë¬¼ ID":"id","Tweet ID":"id",
    "ë…¸ì¶œìˆ˜":"impressions","Impressions":"impressions","ã‚¤ãƒ³ãƒ—ãƒ¬ãƒƒã‚·ãƒ§ãƒ³æ•°":"impressions","å±•ç¤ºæ¬¡æ•°":"impressions","æ›å…‰æ¬¡æ•°":"impressions",
    "ì°¸ì—¬ìˆ˜":"engagements","Engagements":"engagements","ã‚¨ãƒ³ã‚²ãƒ¼ã‚¸ãƒ¡ãƒ³ãƒˆæ•°":"engagements","äº’åŠ¨æ¬¡æ•°":"engagements",
    "ë§ˆìŒì— ë“¤ì–´ìš”":"likes","Likes":"likes","ã„ã„ã­":"likes","ç‚¹èµæ•°":"likes",
    "ë¶ë§ˆí¬":"bookmarks","Bookmarks":"bookmarks","ãƒ–ãƒƒã‚¯ãƒãƒ¼ã‚¯":"bookmarks","ä¹¦ç­¾":"bookmarks",
    "ì¬ê²Œì‹œ":"retweets","Retweets":"retweets","Reposts":"retweets","ãƒªãƒ„ã‚¤ãƒ¼ãƒˆ":"retweets","è½¬æ¨":"retweets","è½‰æ¨":"retweets","è½¬å‘":"retweets",
    "ë‹µê¸€":"replies","Replies":"replies","è¿”ä¿¡":"replies","å›å¤":"replies",
    "ê³µìœ  ìˆ˜":"shares","Shares":"shares","ã‚·ã‚§ã‚¢":"shares","åˆ†äº«":"shares",
    "ìƒˆë¡œìš´ íŒ”ë¡œìš°":"newFollows","New follows":"newFollows","æ–°ã—ã„ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼":"newFollows","æ–°å…³æ³¨è€…":"newFollows",
    "í”„ë¡œí•„ ì¡°íšŒìˆ˜":"profileClicks","Profile clicks":"profileClicks","ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã‚¯ãƒªãƒƒã‚¯æ•°":"profileClicks","ä¸ªäººèµ„æ–™ç‚¹å‡»æ¬¡æ•°":"profileClicks",
    "URL í´ë¦­ìˆ˜":"urlClicks","URL clicks":"urlClicks","URL ã‚¯ãƒªãƒƒã‚¯æ•°":"urlClicks","URL ç‚¹å‡»æ¬¡æ•°":"urlClicks",
    "ê³ ìœ  ë§í¬ í´ë¦­ìˆ˜":"uniqueClicks","Unique link clicks":"uniqueClicks","ãƒ¦ãƒ‹ãƒ¼ã‚¯ãƒªãƒ³ã‚¯ã‚¯ãƒªãƒƒã‚¯æ•°":"uniqueClicks","å”¯ä¸€é“¾æ¥ç‚¹å‡»æ¬¡æ•°":"uniqueClicks",
  };
  const result = {};
  for (const key in row) {
    const clean = key.trim();
    if (map[clean]) result[map[clean]] = row[key];
  }

  // ë‚ ì§œ & ë§í¬ & ë³¸ë¬¸ì„ ì¢€ ë” ìœ ì—°í•˜ê²Œ ì°¾ê¸°
  if (!result.date) {
    for (const key in row) {
      const l = key.trim().toLowerCase();
      if (l.includes("ë‚ ì§œ") || l === "date" || l.startsWith("date ")) {
        result.date = row[key];
        break;
      }
    }
  }
  if (!result.link) {
    for (const key in row) {
      const l = key.trim().toLowerCase();
      if (l.includes("ë§í¬") || l.includes("permalink") || l === "url" || l.includes("url")) {
        result.link = row[key];
        break;
      }
    }
  }
  if (!result.text) {
    for (const key in row) {
      const l = key.trim().toLowerCase();
      if (l.includes("text") || l.includes("ë³¸ë¬¸")) {
        result.text = row[key];
        break;
      }
    }
  }
  return result;
}
function num(v){
  if(!v) return 0;
  v = String(v).replace(/,/g,"").trim();
  const n = parseFloat(v);
  return isNaN(n)?0:n;
}

/* ========== ë‚ ì§œ/ê¸°ê°„ ì²˜ë¦¬ (í•œêµ­ì‹ ë‚ ì§œ í¬í•¨) ========== */
function parseDateValue(v){
  if(!v) return null;
  let s = String(v).trim();

  // 1) YYYY-MM-DD, YYYY/MM/DD, etc.
  let m = s.match(/(\d{4})[^\d]?(\d{1,2})[^\d]?(\d{1,2})/);
  if(m){
    const year = parseInt(m[1],10);
    const month = parseInt(m[2],10)-1;
    const day = parseInt(m[3],10);
    const d = new Date(year, month, day);
    if(!isNaN(d.getTime())) return d;
  }

  // 2) MM-DD-YYYY or DD-MM-YYYY í˜•íƒœ ë³´ì™„
  m = s.match(/(\d{1,2})[^\d]?(\d{1,2})[^\d]?(\d{4})/);
  if(m){
    const a = parseInt(m[1],10);
    const b = parseInt(m[2],10);
    const year = parseInt(m[3],10);
    // ì›”/ì¼ ì¶”ì • (a>12ë©´ a=day, b=month ë¡œ ê°€ì •)
    let month, day;
    if(a > 12){
      day = a;
      month = b - 1;
    }else{
      month = a - 1;
      day = b;
    }
    const d = new Date(year, month, day);
    if(!isNaN(d.getTime())) return d;
  }

  // 3) Date.parseê°€ ê°€ëŠ¥í•œ ë¬¸ìì—´ì´ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
  const parsed = Date.parse(s);
  if(!isNaN(parsed)){
    const d = new Date(parsed);
    if(!isNaN(d.getTime())) return d;
  }
  return null;
}

function applyDateFilter(list, range){
  if(range === "ALL") return list.slice();
  const days = Number(range);
  if(!days || !list.length) return list.slice();

  // ë‚ ì§œê°€ ìˆëŠ” ë°ì´í„°ë§Œ ìš°ì„  ì‚¬ìš©
  const withDates = list.filter(p => p.dateObj);
  if(!withDates.length){
    // ë‚ ì§œ íŒŒì‹±ì´ ì•ˆ ëœ ê²½ìš°: ë‹¨ìˆœíˆ ë’¤ì—ì„œ Nê°œë§Œ ë³´ì—¬ì£¼ëŠ” fallback
    const count = Math.min(list.length, days);
    return list.slice(list.length - count);
  }

  const dates = withDates.map(p=>p.dateObj);
  const latestTime = Math.max.apply(null, dates.map(d=>d.getTime()));
  const latest = new Date(latestTime);
  const ms = 24*60*60*1000;
  const threshold = new Date(latest.getTime() - (days-1)*ms);

  // ê¸°ê°„ í•„í„°ì—ì„œëŠ” ë‚ ì§œ ì—†ëŠ” ê¸€ì€ ì œì™¸ (ALLì—ì„œë§Œ í¬í•¨)
  return list.filter(p => p.dateObj && p.dateObj >= threshold);
}

/* ========== ìŠ¤ì½”ì–´/ë“±ê¸‰ ========== */
function computeScore(p){
  const impres = p.impressions || 0;
  const raw =
      p.engagements +
      p.bookmarks * 3 +
      p.newFollows * 10 +
      p.profileClicks * 0.7 +
      p.urlClicks * 0.8 +
      p.uniqueClicks * 1.2 +
      p.likes * 1.2 +
      p.retweets * 2 +
      p.replies * 1.5 +
      p.shares * 1.8;
  return raw / Math.log10(impres + 10);
}
function assignGrades(list){
  list.sort((a,b)=>b.score-a.score);
  const N = list.length || 1;
  list.forEach((p,i)=>{
    const pct = N>1 ? 1 - i/(N-1) : 1;
    p.percentile = Math.round(pct*100);
    p.grade =
      pct>=0.95?"S":
      pct>=0.80?"A":
      pct>=0.60?"B":
      pct>=0.40?"C":"D";
  });
}
function computeTrimmedAverage(list, ratio){
  if(!list.length) return 0;
  const scores = list.map(p=>p.score).sort((a,b)=>a-b);
  const n = scores.length;
  let k = Math.floor(n*ratio);
  if(k*2>=n) k = 0;
  const trimmed = scores.slice(k, n-k);
  const sum = trimmed.reduce((s,v)=>s+v,0);
  return sum / trimmed.length;
}
function sortForView(list){
  const key = SORT_KEY || "score";
  list.sort((a,b)=>{
    let va, vb;
    switch(key){
      case "impressions": va = a.impressions; vb = b.impressions; break;
      case "engagements": va = a.engagements; vb = b.engagements; break;
      case "bookmarks":  va = a.bookmarks;  vb = b.bookmarks;  break;
      case "newFollows": va = a.newFollows; vb = b.newFollows; break;
      case "score":
      default:
        va = a.score; vb = b.score; break;
    }
    if(va < vb) return 1;
    if(va > vb) return -1;
    return 0;
  });
  return list;
}

/* ========== í”„ë¡œì íŠ¸ íƒœê¹…/ì§‘ê³„ ========== */
function tagProjectsForPost(p){
  const text = (p.text || "").toLowerCase();
  const tags = [];
  PROJECTS.forEach(proj=>{
    const hit = proj.keywords.some(kw => text.includes(kw.toLowerCase()));
    if(hit) tags.push(proj.id);
  });
  p.projects = tags;
}

function computeProjectStats(list){
  const stats = {};
  PROJECTS.forEach(proj=>{
    stats[proj.id] = {
      id: proj.id,
      label: proj.label,
      count: 0,
      avgScore: 0,
      trimmedAvg: 0,
      bestScore: 0,
      bestDate: "",
      bestLink: "",
      posts: []
    };
  });

  list.forEach(post=>{
    (post.projects || []).forEach(pid=>{
      const s = stats[pid];
      if(!s) return;
      s.count++;
      s.posts.push(post);
      if(!s.bestScore || post.score > s.bestScore){
        s.bestScore = post.score;
        s.bestDate = post.date;
        s.bestLink = post.link;
      }
    });
  });

  const result = [];
  Object.values(stats).forEach(s=>{
    if(!s.posts.length) return;
    const total = s.posts.length;
    s.avgScore = s.posts.reduce((sum,p)=>sum+p.score,0)/total;
    s.trimmedAvg = computeTrimmedAverage(s.posts, TRIM_RATIO);
    result.push(s);
  });
  return result;
}

/* í”„ë¡œì íŠ¸ ìš”ì•½ í…Œì´ë¸” */
function renderProjectSummary(list){
  const wrap = document.getElementById("project-summary-wrap");
  if(!wrap) return;
  if(!list.length){
    wrap.innerHTML = "<div class='empty'>í”„ë¡œì íŠ¸ í‚¤ì›Œë“œì— ë§¤ì¹­ëœ ê¸€ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</div>";
    return;
  }
  list.sort((a,b)=>(b.trimmedAvg||0)-(a.trimmedAvg||0));
  const rows = list.map((s,idx)=>`
    <tr>
      <td>#${idx+1}</td>
      <td>${s.label}</td>
      <td>${s.count}</td>
      <td>${s.avgScore ? s.avgScore.toFixed(1) : "-"}</td>
      <td>${s.trimmedAvg ? s.trimmedAvg.toFixed(1) : "-"}</td>
      <td>${s.bestLink ? `<a href="${s.bestLink}" class="link-pill" target="_blank">ëŒ€í‘œ íŠ¸ìœ— â†—</a>` : ""}</td>
    </tr>
  `).join("");
  wrap.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>ìˆœìœ„</th>
          <th>í”„ë¡œì íŠ¸</th>
          <th>ê²Œì‹œê¸€ ìˆ˜</th>
          <th>í‰ê·  ìŠ¤ì½”ì–´</th>
          <th>íŠ¸ë¦¼ë“œ í‰ê· </th>
          <th>ëŒ€í‘œ íŠ¸ìœ—</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

/* í”„ë¡œì íŠ¸ë³„ ìƒì„¸ ì…€ë ‰íŠ¸ & í…Œì´ë¸” */
function buildProjectSelect(list){
  const select = document.getElementById("project-select");
  const detailWrap = document.getElementById("project-detail-wrap");
  if(!select || !detailWrap) return;

  if(!list.length){
    select.innerHTML = `<option value="">ë§¤ì¹­ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</option>`;
    detailWrap.innerHTML = `<div class="empty">í”„ë¡œì íŠ¸ í‚¤ì›Œë“œì— ë§¤ì¹­ëœ ê¸€ì´ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.</div>`;
    renderProjectGradePie(null);
    return;
  }

  select.innerHTML = list.map(p=>`<option value="${p.id}">${p.label} (${p.count})</option>`).join("");
  select.onchange = () => {
    const stat = PROJECT_STATS.find(p=>p.id===select.value);
    if(stat) renderProjectGradePie(stat);
    renderProjectDetail(select.value);
  };
  const first = list[0];
  select.value = first.id;
  renderProjectDetail(first.id);
  renderProjectGradePie(first);
}

function renderProjectDetail(projectId){
  const wrap = document.getElementById("project-detail-wrap");
  if(!wrap) return;
  const proj = PROJECT_STATS.find(p=>p.id===projectId);
  if(!proj || !proj.posts.length){
    wrap.innerHTML = `<div class="empty">ì„ íƒí•œ í”„ë¡œì íŠ¸ì— í•´ë‹¹í•˜ëŠ” ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>`;
    return;
  }
  const posts = proj.posts.slice().sort((a,b)=>b.score-a.score);
  const rows = posts.map((p,idx)=>`
    <tr>
      <td>#${idx+1}</td>
      <td><div class="grade-badge ${p.grade.toLowerCase()}">${p.grade}</div></td>
      <td>
        <div class="text-main">${p.text}</div>
        <div class="text-meta">${p.date} Â· ìŠ¤ì½”ì–´ <strong>${p.score.toFixed(1)}</strong></div>
      </td>
      <td>
        <div class="stat-chip">ì°¸ì—¬ <strong>${p.engagements}</strong></div>
        <div class="stat-chip">ë…¸ì¶œ <strong>${p.impressions}</strong></div>
      </td>
      <td>
        <div class="stat-chip">íŒ”ë¡œìš° <strong>${p.newFollows}</strong></div>
        <div class="stat-chip">ë¶ë§ˆí¬ <strong>${p.bookmarks}</strong></div>
      </td>
      <td>${p.link ? `<a href="${p.link}" class="link-pill" target="_blank">íŠ¸ìœ— ë³´ê¸° â†—</a>` : ""}</td>
    </tr>
  `).join("");

  wrap.innerHTML = `
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>ë“±ê¸‰</th>
          <th>ë³¸ë¬¸</th>
          <th>ì°¸ì—¬/ë…¸ì¶œ</th>
          <th>íŒ”ë¡œìš°/ë¶ë§ˆí¬</th>
          <th>ë§í¬</th>
        </tr>
      </thead>
      <tbody>${rows}</tbody>
    </table>
  `;
}

/* í”„ë¡œì íŠ¸ ë„ë„› ì°¨íŠ¸ */
function renderProjectPieChart(list){
  const canvas = document.getElementById("project-pie");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");

  if(projectChart){
    projectChart.destroy();
    projectChart = null;
  }
  if(!list.length) return;

  const labels = list.map(p=>p.label);
  const data = list.map(p=>p.count);

  projectChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: [
          "rgba(59,130,246,0.9)",
          "rgba(45,212,191,0.9)",
          "rgba(251,191,36,0.9)",
          "rgba(244,114,182,0.9)",
          "rgba(129,140,248,0.9)",
          "rgba(16,185,129,0.9)",
          "rgba(249,115,22,0.9)",
          "rgba(236,72,153,0.9)"
        ]
      }]
    },
    options: {
      responsive:false,
      maintainAspectRatio:false,
      plugins: {
        legend: { position: "bottom" }
      },
      cutout:"55%",
      onClick(evt, elements){
        if(!elements.length) return;
        const idx = elements[0].index;
        const proj = list[idx];
        if(!proj) return;
        const select = document.getElementById("project-select");
        if(select){
          select.value = proj.id;
        }
        renderProjectDetail(proj.id);
        const stat = PROJECT_STATS.find(p=>p.id===proj.id);
        if(stat){
          renderProjectGradePie(stat);
        }
      }
    }
  });
}

function renderGlobalGradePie(stats){
  const canvas = document.getElementById("grade-distribution-pie");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");

  if(globalGradeChart){
    globalGradeChart.destroy();
    globalGradeChart = null;
  }

  if(!stats || !stats.length){
    canvas.style.display = "none";
    return;
  }
  canvas.style.display = "block";

  const labels = stats.map(p=>p.label);
  const data = stats.map(p=> (p.trimmedAvg || p.avgScore || 0));

  globalGradeChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: [
          "rgba(59,130,246,0.9)",
          "rgba(45,212,191,0.9)",
          "rgba(251,191,36,0.9)",
          "rgba(244,114,182,0.9)",
          "rgba(129,140,248,0.9)",
          "rgba(16,185,129,0.9)",
          "rgba(249,115,22,0.9)",
          "rgba(236,72,153,0.9)"
        ]
      }]
    },
    options: {
      responsive:false,
      maintainAspectRatio:false,
      plugins: {
        legend: { position: "bottom" }
      },
      cutout:"55%"
    }
  });
}

function renderProjectGradePie(stat){
  const canvas = document.getElementById("project-grade-pie");
  if(!canvas) return;
  const ctx = canvas.getContext("2d");

  if(projectGradeChart){
    projectGradeChart.destroy();
    projectGradeChart = null;
  }

  if(!stat || !stat.posts || !stat.posts.length){
    canvas.style.display = "none";
    return;
  }
  canvas.style.display = "block";

  const counts = { S:0, A:0, B:0, C:0, D:0 };
  stat.posts.forEach(p=>{
    if(counts[p.grade] !== undefined){
      counts[p.grade]++;
    }
  });

  const labels = ["S","A","B","C","D"];
  const data = labels.map(g=>counts[g]);

  projectGradeChart = new Chart(ctx, {
    type: "doughnut",
    data: {
      labels,
      datasets: [{
        data,
        backgroundColor: [
          "rgba(245,158,11,0.9)",  // S
          "rgba(56,189,248,0.9)",  // A
          "rgba(34,197,94,0.9)",   // B
          "rgba(168,85,247,0.9)",  // C
          "rgba(148,163,184,0.9)"  // D
        ]
      }]
    },
    options: {
      responsive:false,
      maintainAspectRatio:false,
      plugins: {
        legend: { position: "bottom" }
      },
      cutout:"55%"
    }
  });
}

/* ========== Top10 / ë“±ê¸‰ë³„ ë Œë”ë§ ========== */
function renderTop10(posts){
  const wrap=document.getElementById("top10-table-wrap");
  const countSpan = document.getElementById("top10-count");
  if(!posts.length){
    wrap.innerHTML="<div class='empty'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    if(countSpan) countSpan.textContent = "";
    return;
  }
  const base = sortForView(posts.slice());
  const top = base.slice(0,10);
  if(countSpan) countSpan.textContent = `(${top.length} / ${posts.length})`;
  const rows=top.map((p,i)=>`
    <tr>
      <td>#${i+1}</td>
      <td><div class="grade-badge ${p.grade.toLowerCase()}">${p.grade}</div></td>
      <td>
        <div class="text-main">${p.text}</div>
        <div class="text-meta">${p.date} Â· ìŠ¤ì½”ì–´ <strong>${p.score.toFixed(1)}</strong></div>
      </td>
      <td>
        <div class="stat-chip">ì°¸ì—¬ <strong>${p.engagements}</strong></div>
        <div class="stat-chip">ë…¸ì¶œ <strong>${p.impressions}</strong></div>
      </td>
      <td>
        <div class="stat-chip">íŒ”ë¡œìš° <strong>${p.newFollows}</strong></div>
        <div class="stat-chip">ë¶ë§ˆí¬ <strong>${p.bookmarks}</strong></div>
      </td>
      <td>${p.link ? `<a href="${p.link}" class="link-pill" target="_blank">íŠ¸ìœ— ë³´ê¸° â†—</a>` : ""}</td>
    </tr>`).join("");
  wrap.innerHTML=`
    <table>
      <thead><tr>
        <th>#</th><th>ë“±ê¸‰</th><th>ë³¸ë¬¸</th><th>ì°¸ì—¬/ë…¸ì¶œ</th><th>íŒ”ë¡œìš°/ë¶ë§ˆí¬</th><th>ë§í¬</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}
function renderGrade(list){
  const wrap=document.getElementById("grade-table-wrap");
  if(!list.length){
    wrap.innerHTML="<div class='empty'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    return;
  }
  const base = sortForView(list.slice());
  const rows=base.map((p,i)=>`
    <tr>
      <td>#${i+1}</td>
      <td><div class="grade-badge ${p.grade.toLowerCase()}">${p.grade}</div></td>
      <td>
        <div class="text-main">${p.text}</div>
        <div class="text-meta">${p.date} Â· ìŠ¤ì½”ì–´ <strong>${p.score.toFixed(1)}</strong></div>
      </td>
      <td>
        <div class="stat-chip">ì°¸ì—¬ <strong>${p.engagements}</strong></div>
        <div class="stat-chip">ë…¸ì¶œ <strong>${p.impressions}</strong></div>
      </td>
      <td>
        <div class="stat-chip">íŒ”ë¡œìš° <strong>${p.newFollows}</strong></div>
        <div class="stat-chip">ë¶ë§ˆí¬ <strong>${p.bookmarks}</strong></div>
      </td>
      <td>${p.link ? `<a href="${p.link}" class="link-pill" target="_blank">íŠ¸ìœ— ë³´ê¸° â†—</a>` : ""}</td>
    </tr>`).join("");
  wrap.innerHTML=`
    <table>
      <thead><tr>
        <th>#</th><th>ë“±ê¸‰</th><th>ë³¸ë¬¸</th><th>ì°¸ì—¬/ë…¸ì¶œ</th><th>íŒ”ë¡œìš°/ë¶ë§ˆí¬</th><th>ë§í¬</th>
      </tr></thead>
      <tbody>${rows}</tbody>
    </table>`;
}

/* ========== ì½”ì¹˜ ë´‡ ì¶œë ¥ ========== */
function updateCoach(){
  const el = document.getElementById("coach-output");
  if(!el) return;

  if(!ALL_BASE.length){
    if(CURRENT_LANG === "en"){
      el.textContent =
        "No CSV has been uploaded yet.\n" +
        "Download your X Analytics CSV and upload it above,\n" +
        "then the coach bot will summarize your mindshare status for this period.";
    }else{
      el.textContent =
        "ì•„ì§ CSVë¥¼ ì˜¬ë¦¬ì§€ ì•Šì•˜ì–´.\n" +
        "ìƒë‹¨ì—ì„œ ì• ë„ë¦¬í‹±ìŠ¤ CSVë¥¼ ì—…ë¡œë“œí•˜ë©´\n" +
        "ì´ êµ¬ê°„ì˜ ë§ˆì¸ë“œì‰ì–´ ìƒíƒœë¥¼ ì½”ì¹˜ ë´‡ì´ ìš”ì•½í•´ ì¤„ ê±°ì•¼.";
    }
    return;
  }
  if(!CURRENT_LIST.length || !ANALYSIS){
    el.textContent = (CURRENT_LANG === "en")
      ? "There is no data for the selected period, so I can't analyze it."
      : "ì„ íƒí•œ ê¸°ê°„ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ì–´ì„œ ë¶„ì„í•  ìˆ˜ ì—†ì–´.";
    return;
  }

  const gradeCounts = { S:0, A:0, B:0, C:0, D:0 };
  CURRENT_LIST.forEach(p=>{
    if(gradeCounts[p.grade] !== undefined){
      gradeCounts[p.grade]++;
    }
  });

  const tAvg = ANALYSIS.trimmedAvg || 0;
  let overallGrade, moodKo, moodEn;
  if(tAvg >= 80){
    overallGrade = "S";
    moodKo = "ì´ë²ˆ êµ¬ê°„ì€ ì‚¬ì‹¤ìƒ í­ë°œ êµ¬ê°„ì´ì•¼. ì§€ê¸ˆ í˜ì´ìŠ¤ ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë©´ì„œ, í„°ì¡Œë˜ íŒ¨í„´ì„ ë°˜ë³µí•˜ë©´ ë¼.";
    moodEn = "This period is basically an explosion zone. Keep this pace and repeat the patterns that already worked.";
  }else if(tAvg >= 60){
    overallGrade = "A";
    moodKo = "ìƒìœ„ê¶Œì—ì„œ ì˜ ë²„í‹°ê³  ìˆì–´. ì¡°ê¸ˆë§Œ ë” ì •êµí•˜ê²Œ ì‹¤í—˜í•˜ë©´ ì–¸ì œë“  Së¡œ ì˜¬ë¼ê°ˆ ìˆ˜ ìˆëŠ” ìœ„ì¹˜ì•¼.";
    moodEn = "You are holding solid in the upper tier. With a bit more fineâ€‘tuned experimentation, you can jump into S range.";
  }else if(tAvg >= 45){
    overallGrade = "B";
    moodKo = "ë¬´ë‚œí•˜ê²Œ ìš°ìƒí–¥ ì¤€ë¹„ ì¤‘ì¸ êµ¬ê°„ì´ì•¼. ëª‡ ê°œ ê°•í•œ ì‹œê·¸ë„ì„ ë” ë§Œë“¤ë©´ í•œ ë‹¨ê³„ ìœ„ë¡œ ì˜¬ë¼ê°ˆ ìˆ˜ ìˆì–´.";
    moodEn = "This is a steady preparation phase for an uptrend. A few stronger signals could push you to the next tier.";
  }else if(tAvg >= 30){
    overallGrade = "C";
    moodKo = "ì‹¤í—˜ì€ ë§ì´ í–ˆì§€ë§Œ ì•„ì§ ë¹µ í„°ì¹˜ëŠ” íŒ¨í„´ì´ ë¶€ì¡±í•œ êµ¬ê°„ì´ì•¼. ì˜ í„°ì§„ ê¸€ ê¸°ì¤€ìœ¼ë¡œ ê³µí†µ íŒ¨í„´ì„ ë½‘ì•„ë³´ì.";
    moodEn = "Youâ€™re experimenting a lot, but lack a consistently explosive pattern. Try extracting common traits from your bestâ€‘performing posts.";
  }else{
    overallGrade = "D";
    moodKo = "ë°ì´í„°ê°€ ìŒ“ì´ëŠ” ë‹¨ê³„ë¼ì„œ, ì§€ê¸ˆì€ â€˜í…ŒìŠ¤íŠ¸ ê¸°ê°„â€™ì´ë¼ ë³´ë©´ ë¼. ë‹¤ì–‘í•œ í˜•ì‹ì„ ë¶€ë‹´ ì—†ì´ ë˜ì§€ëŠ” ê²Œ ì¢‹ì•„.";
    moodEn = "This is still a dataâ€‘gathering phase. Treat it as a test period and throw out various formats without overthinking.";
  }

  const bestPost = CURRENT_LIST.slice().sort((a,b)=>b.score-a.score)[0];

  let accountStyleKo = "";
  let accountStyleEn = "";
  const totalPosts = ANALYSIS.totalPosts || CURRENT_LIST.length || 0;
  const highPosts = gradeCounts.S + gradeCounts.A;
  const highRate = totalPosts > 0 ? highPosts / totalPosts : 0;

  if (totalPosts <= 40 && highRate >= 0.3) {
    // ì§ˆë¡œ ìŠ¹ë¶€í˜•
    accountStyleKo = "ì´ ê³„ì •ì€ ì „í˜•ì ì¸ â€˜ì§ˆë¡œ ìŠ¹ë¶€â€™ íƒ€ì…ì´ì•¼. ê¸€ ìˆ˜ëŠ” ìƒëŒ€ì ìœ¼ë¡œ ë§ì§€ ì•Šì€ë° S/Aê¸‰ ë¹„ìœ¨ì´ ë†’ì•„ì„œ, í•œ í¸ í•œ í¸ì„ ê½¤ ê³µë“¤ì—¬ ì“°ëŠ” íŒ¨í„´ì´ ë³´ì—¬.";
    accountStyleEn = "This account is a classic â€œqualityâ€‘firstâ€ type. You donâ€™t post huge volume, but the S/Aâ€‘tier ratio is high, so each post seems carefully crafted.";
  } else if (totalPosts >= 80 && highRate < 0.2) {
    // ì–‘ìœ¼ë¡œ ì••ë°•í˜•
    accountStyleKo = "ì´ ê³„ì •ì€ â€˜ì–‘ìœ¼ë¡œ ì••ë°•â€™í•˜ëŠ” íƒ€ì…ì— ê°€ê¹Œì›Œ. ì „ì²´ ê¸€ ìˆ˜ê°€ ë§ê³  S/A ë¹„ìœ¨ì€ ë‚®ì€ í¸ì´ë¼, ë‹¤ì–‘í•œ ì‹œë„ë¥¼ ë§ì´ ë˜ì§€ë©´ì„œ ì„±ê³µ íŒ¨í„´ì„ ì°¾ëŠ” ìŠ¤íƒ€ì¼ì´ì•¼.";
    accountStyleEn = "This account leans toward a â€œvolumeâ€‘drivenâ€ style. You post a lot, with a relatively lower S/A ratio, using sheer volume and experimentation to find what works.";
  } else {
    // ë°¸ëŸ°ìŠ¤í˜•
    accountStyleKo = "ì´ ê³„ì •ì€ ì§ˆê³¼ ì–‘ì´ ì ë‹¹íˆ ì„ì¸ ë°¸ëŸ°ìŠ¤í˜•ì´ì•¼. ê¸€ ìˆ˜ë„, S/A ë¹„ìœ¨ë„ ëª¨ë‘ ì¤‘ê°„ ì´ìƒì´ë¼, ê¾¸ì¤€í•œ ë³¼ë¥¨ì„ ìœ ì§€í•˜ë©´ì„œ ì‹¤í—˜ë„ ë³‘í–‰í•˜ëŠ” íŒ¨í„´ì´ ë³´ì—¬.";
    accountStyleEn = "This account is a balanced mix of quality and volume. Both your post count and S/A ratio are in a healthy middle range, keeping steady volume while continuing to experiment.";
  }

  let text;
  if(CURRENT_LANG === "en"){
    text =
`â— Oneâ€‘line summary for this period
- Trimmed average score: about ${tAvg.toFixed(1)} â†’ roughly in the ${overallGrade} band
- Grade distribution: S ${gradeCounts.S} / A ${gradeCounts.A} / B ${gradeCounts.B} / C ${gradeCounts.C} / D ${gradeCounts.D}

â— Coach comment
- ${moodEn}

â— Bestâ€‘performing post
- Date: ${bestPost.date || "-"}
- Score: ${bestPost.score.toFixed(1)}
${bestPost.link ? "- Link: " + bestPost.link : ""}

â— Account style (quality vs volume)
- ${accountStyleEn}

â€» Tip: Collect your S/Aâ€‘tier posts and compare length, tone, meme usage, time of posting, hashtags, and innerâ€‘circle tags.
Thatâ€™s the fastest way to reverseâ€‘engineer your own â€œmindshare patternâ€.`;
  }else{
    text =
`â— ì´ë²ˆ ê¸°ê°„ í•œ ì¤„ ìš”ì•½
- ì „ì²´ íŠ¸ë¦¼ë“œ í‰ê· : ì•½ ${tAvg.toFixed(1)}ì  â†’ ì²´ê° ë“±ê¸‰ìœ¼ë¡œëŠ” ${overallGrade} êµ¬ê°„ì´ì•¼.
- ë“±ê¸‰ ë¶„í¬: S ${gradeCounts.S} / A ${gradeCounts.A} / B ${gradeCounts.B} / C ${gradeCounts.C} / D ${gradeCounts.D}

â— ì½”ì¹˜ ì½”ë©˜íŠ¸
- ${moodKo}

â— ê°€ì¥ ì˜ í„°ì§„ ê¸€
- ë‚ ì§œ: ${bestPost.date || "-"}
- ìŠ¤ì½”ì–´: ${bestPost.score.toFixed(1)}
${bestPost.link ? "- ë§í¬: " + bestPost.link : ""}

â— ê³„ì • ìŠ¤íƒ€ì¼ (ì§ˆ vs ì–‘)
- ${accountStyleKo}

â€» íŒ: ìƒìœ„ S/A ê¸€ë“¤ë§Œ ëª¨ì•„ì„œ â€œê¸¸ì´, í†¤, ë°ˆ ì‚¬ìš© ì—¬ë¶€, ì‹œê°„ëŒ€, í•´ì‹œíƒœê·¸, ì´ë„ˆì„œí´ íƒœê·¸ ì—¬ë¶€â€ë¥¼ ë¹„êµí•´ ë³´ë©´,
ì§€ê¸ˆ ê³„ì •ë§Œì˜ ë§ˆì‰ íŒ¨í„´ì„ ë” ë¹¨ë¦¬ ì°¾ì„ ìˆ˜ ìˆì–´.`;
  }

  el.textContent = text;
}

function setupRangeTabs(){
  const rangeTabs = document.getElementById("range-tabs");
  if(!rangeTabs) return;
  if(rangeTabs.dataset.bound === "1") return;
  rangeTabs.dataset.bound = "1";

  const buttons = rangeTabs.querySelectorAll(".range-tab");
  buttons.forEach(btn=>{
    btn.addEventListener("click", ()=>{
      buttons.forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      const range = btn.dataset.range || "ALL";
      CURRENT_RANGE = range;
      updateView();
    });
  });
}

/* ========== ì „ì²´ ë·° ì—…ë°ì´íŠ¸ (ê¸°ê°„ í•„í„° ì ìš©) ========== */
function updateView(){
  if(!ALL_BASE.length) return;
  const summaryEl = document.getElementById("summary");
  const errorEl = document.getElementById("error");
  const filtered = applyDateFilter(ALL_BASE, CURRENT_RANGE);
  CURRENT_LIST = filtered;

  if(!filtered.length){
    ANALYSIS = null;
    summaryEl.innerHTML = "";
    summaryEl.style.display = "none";
    errorEl.textContent = "ì„ íƒí•œ ê¸°ê°„ì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
    document.getElementById("top10-table-wrap").innerHTML = "<div class='empty'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    document.getElementById("grade-table-wrap").innerHTML = "<div class='empty'>ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    PROJECT_STATS = [];
    renderProjectSummary([]);
    buildProjectSelect([]);
    renderProjectPieChart([]);
    const countSpan = document.getElementById("top10-count");
    if(countSpan) countSpan.textContent = "";
    updateCoach();
    return;
  }

  errorEl.textContent = "";
  assignGrades(filtered);

  buckets = { S:[], A:[], B:[], C:[], D:[] };
  filtered.forEach(p=>{
    const g = p.grade;
    if(buckets[g] && buckets[g].length < 10){
      buckets[g].push(p);
    }
  });

  const total = filtered.length;
  const avgScore = filtered.reduce((s,p)=>s+p.score,0)/total;
  const trimmedAvg = computeTrimmedAverage(filtered, TRIM_RATIO);
  const best = filtered[0];

  ANALYSIS = {
    trimmedAvg,
    avgScore,
    bestScore: best.score,
    bestDate: best.date,
    bestLink: best.link,
    totalPosts: total
  };

    
  updateYapCard(ANALYSIS);

summaryEl.innerHTML = `
    <div class="summary-card summary-card--posts">
      <div class="summary-ring"><span>ğŸ“</span></div>
      <div class="summary-text">
        <div class="summary-label">ì›ê¸€ ê°œìˆ˜</div>
        <div class="summary-value">${total}</div>
        <div class="summary-sub">ë‹µê¸€ ì œì™¸ Â· ê¸°ê°„ í•„í„° ì ìš©</div>
      </div>
    </div>

    <div class="summary-card summary-card--avg">
      <div class="summary-ring"><span>ğŸ“ˆ</span></div>
      <div class="summary-text">
        <div class="summary-label">í‰ê·  ìŠ¤ì½”ì–´</div>
        <div class="summary-value">${avgScore.toFixed(1)}</div>
        <div class="summary-sub">í˜„ì¬ ì„ íƒëœ ê¸°ê°„ì˜ ì „ì²´ ì›ê¸€ ê¸°ì¤€</div>
      </div>
    </div>

    <div class="summary-card summary-card--trimmed">
      <div class="summary-ring"><spanâš–ï¸</span></div>
      <div class="summary-text">
        <div class="summary-label">íŠ¸ë¦¼ë“œ í‰ê· </div>
        <div class="summary-value">${trimmedAvg.toFixed(1)}</div>
        <div class="summary-sub">ìƒÂ·í•˜ìœ„ 10% ì œê±° í›„ í‰ê· </div>
      </div>
    </div>

    <div class="summary-card summary-card--best">
      <div class="summary-ring"><span>ğŸ’¥</span></div>
      <div class="summary-text">
        <div class="summary-label">ê°€ì¥ í„°ì§„ ê¸€</div>
        <div class="summary-value">${best.score.toFixed(1)}</div>
        <div class="summary-sub">${best.date || ""}</div>
      </div>
    </div>
  `;

  summaryEl.style.display="grid";

  renderGrowthChart(filtered);
  renderYapHeatmap(filtered);
  renderTop10(filtered);
  if(CURRENT_GRADE === "ALL"){
    renderGrade(filtered.slice(0,30));
  }else{
    renderGrade(buckets[CURRENT_GRADE] || []);
  }

  PROJECT_STATS = computeProjectStats(filtered);
  renderProjectSummary(PROJECT_STATS);
  buildProjectSelect(PROJECT_STATS);
  renderProjectPieChart(PROJECT_STATS);
  renderGlobalGradePie(PROJECT_STATS);

  updateCoach();
}
/* ========== ë¡œì»¬ ë¶„ì„ íˆìŠ¤í† ë¦¬ ì €ì¥ ========== */
function getHistoryList(){
  try{
    const raw = localStorage.getItem("ms_history");
    if(!raw) return [];
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [];
  }catch(e){
    console.warn("íˆìŠ¤í† ë¦¬ ë¶ˆëŸ¬ì˜¤ê¸° ì¤‘ ì˜¤ë¥˜", e);
    return [];
  }
}

function saveHistoryEntry(){
  try{
    if(!ANALYSIS || !ALL_BASE.length) return;
    const entry = {
      timestamp: new Date().toISOString(),
      range: CURRENT_RANGE || "ALL",
      trimmedAvg: ANALYSIS.trimmedAvg,
      avgScore: ANALYSIS.avgScore,
      bestScore: ANALYSIS.bestScore,
      bestDate: ANALYSIS.bestDate,
      totalPosts: ANALYSIS.totalPosts
    };
    const list = getHistoryList();
    list.push(entry);
    const trimmed = list.slice(-50); // ìµœê·¼ 50ê°œë§Œ ìœ ì§€
    localStorage.setItem("ms_history", JSON.stringify(trimmed));
  }catch(e){
    console.warn("íˆìŠ¤í† ë¦¬ ì €ì¥ ì‹¤íŒ¨", e);
  }
}



/* ========== ë§ˆì§€ë§‰ CSV ë¶„ì„ ìŠ¤ëƒ…ìƒ· (ë‹‰ë„¤ì„ë³„) ========== */
const LAST_SNAPSHOT_PREFIX = "ms_last_analysis_v1_";

function getCurrentProfileKey(){

function updateLastSnapshotUI(){
  try{
    const infoEl = document.getElementById("last-snapshot-info");
    if (!infoEl) return;
    if (typeof localStorage === "undefined") {
      infoEl.textContent = "ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ë§ˆì§€ë§‰ CSV ì €ì¥ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }
    const raw = localStorage.getItem(getCurrentProfileKey());
    if (!raw) {
      infoEl.textContent = "ì €ì¥ëœ ë§ˆì§€ë§‰ CSV ë¶„ì„ì´ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }
    const parsed = JSON.parse(raw);
    if (!parsed || !parsed.timestamp) {
      infoEl.textContent = "ì €ì¥ëœ ë§ˆì§€ë§‰ CSV ë¶„ì„ì´ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }
    const d = new Date(parsed.timestamp);
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,"0");
    const day = String(d.getDate()).padStart(2,"0");
    const hh = String(d.getHours()).padStart(2,"0");
    const mm = String(d.getMinutes()).padStart(2,"0");
    infoEl.textContent = `ë§ˆì§€ë§‰ ë¶„ì„: ${y}-${m}-${day} ${hh}:${mm} ê¸°ì¤€`;
  }catch(e){
    console.warn("ë§ˆì§€ë§‰ ë¶„ì„ UI ì—…ë°ì´íŠ¸ ì‹¤íŒ¨", e);
  }
}

  let nick = "";
  try{
    if (typeof localStorage !== "undefined") {
      nick = localStorage.getItem(NICKNAME_KEY) || "";
    }
  }catch(e){}
  if(!nick) nick = "guest";
  return LAST_SNAPSHOT_PREFIX + encodeURIComponent(nick);
}

function saveLastSnapshot(){
  try{
    if (typeof localStorage === "undefined") return;
    if (!ANALYSIS || !ALL_BASE.length) return;
    const payload = {
      timestamp: new Date().toISOString(),
      range: CURRENT_RANGE || "ALL",
      posts: ALL_BASE
    };
    localStorage.setItem(getCurrentProfileKey(), JSON.stringify(payload));
    updateLastSnapshotUI();
  }catch(e){
    console.warn("ë§ˆì§€ë§‰ ë¶„ì„ ì €ì¥ ì‹¤íŒ¨", e);
  }
}

function loadLastSnapshot(){
  try{
    if (typeof localStorage === "undefined") return null;
    const raw = localStorage.getItem(getCurrentProfileKey());
    if (!raw) return null;
    const parsed = JSON.parse(raw);
    if (!parsed || !Array.isArray(parsed.posts)) return null;
    return parsed;
  }catch(e){
    console.warn("ë§ˆì§€ë§‰ ë¶„ì„ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨", e);
    return null;
  }
}

function restoreLastAnalysis(){
  const snap = loadLastSnapshot();
  updateLastSnapshotUI();
  if (!snap || !Array.isArray(snap.posts) || !snap.posts.length){
    alert("ì´ ë¸Œë¼ìš°ì €ì— ì €ì¥ëœ ë§ˆì§€ë§‰ CSV ë¶„ì„ì´ ì—†ìŠµë‹ˆë‹¤.\në¨¼ì € CSVë¥¼ ì—…ë¡œë“œí•´ì„œ í•œ ë²ˆ ë¶„ì„í•´ì¤˜.");
    return;
  }

  ALL_BASE = snap.posts;
  CURRENT_RANGE = snap.range || "ALL";
  CURRENT_GRADE = "ALL";

  const errorEl = document.getElementById("error");
  if (errorEl) errorEl.textContent = "";

  const rangeTabs = document.getElementById("range-tabs");
  if (rangeTabs) rangeTabs.style.display = "flex";

  setupRangeTabs();
  updateView();
}
function renderHistoryList(){
  const wrap = document.getElementById("history-wrap");
  if(!wrap) return;
  const list = getHistoryList();
  if(!list.length){
    wrap.innerHTML = "<div class='empty'>ì•„ì§ ì €ì¥ëœ ë¶„ì„ íˆìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤. CSVë¥¼ ì—…ë¡œë“œí•˜ë©´ ì—¬ê¸° ê¸°ë¡ì´ ìŒ“ì…ë‹ˆë‹¤.</div>";
    return;
  }

  const rows = list
    .slice()
    .sort((a,b)=> new Date(b.timestamp) - new Date(a.timestamp))
    .map((item, idx)=>{
      const d = new Date(item.timestamp);
      const dateStr = isNaN(d.getTime())
        ? (item.timestamp || "")
        : [
            d.getFullYear(),
            String(d.getMonth()+1).padStart(2,"0"),
            String(d.getDate()).padStart(2,"0")
          ].join("-") + " " +
          String(d.getHours()).padStart(2,"0") + ":" +
          String(d.getMinutes()).padStart(2,"0");

      const avg = Number(item.avgScore || 0);
      const trimmed = Number(item.trimmedAvg || 0);
      const best = Number(item.bestScore || 0);

      return `
        <tr>
          <td>${idx+1}</td>
          <td>${dateStr}</td>
          <td>${item.range || "ALL"}</td>
          <td>${item.totalPosts || 0}</td>
          <td>${avg.toFixed(1)}</td>
          <td>${trimmed.toFixed(1)}</td>
          <td>${best.toFixed(1)}</td>
          <td>${item.bestDate || ""}</td>
        </tr>
      `;
    }).join("");

  wrap.innerHTML = `
    <table class="data-table">
      <thead>
        <tr>
          <th>#</th>
          <th>ì—…ë¡œë“œ ì‹œê°</th>
          <th>ê¸°ê°„ í•„í„°</th>
          <th>ì›ê¸€ ìˆ˜</th>
          <th>í‰ê·  ìŠ¤ì½”ì–´</th>
          <th>íŠ¸ë¦¼ë“œ í‰ê· </th>
          <th>ê°€ì¥ í„°ì§„ ê¸€</th>
          <th>ë² ìŠ¤íŠ¸ ë‚ ì§œ</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>
  `;
}


/* ========= Dashboard ì‹¤ì‹œê°„ ìœ„ì ¯ (BTC/ETH/FX/ë‰´ìŠ¤/í”„ë¡œì íŠ¸/ë¦¬ë”ë³´ë“œ) ========== */

let DASHBOARD_STARTED = false;
const DASH_CHARTS = {};
const DASH_WORKER_BASE = "https://btceth.wnehdrla8382.workers.dev"; // â† ë„ˆì˜ Cloudflare Worker ì£¼ì†Œ

const DASH_CACHE_KEY_BTC = "mudDHA_dash_cache_btc_v1";
const DASH_CACHE_KEY_ETH = "mudDHA_dash_cache_eth_v1";


// candlestick í”ŒëŸ¬ê·¸ì¸ì´ ìˆìœ¼ë©´ candlestick, ì—†ìœ¼ë©´ line ì°¨íŠ¸ë¡œ í´ë°±
function getDashChartType(){
  try{
    if (Chart && Chart.registry && Chart.registry.getController("candlestick")) {
      return "candlestick";
    }
  }catch(e){}
  return "line";
}

// close ê°’ë§Œ ìˆëŠ” ì‹œê³„ì—´ì„ OHLC ë¹„ìŠ·í•œ í˜•íƒœë¡œ ë³€í™˜
function closeSeriesToOhlc(series){
  const out = [];
  if (!Array.isArray(series) || !series.length) return out;
  let prevClose = series[0].c;
  for (let i = 0; i < series.length; i++){
    const item = series[i];
    const c = Number(item.c);
    const ts = item.t;
    const open = prevClose != null ? prevClose : c;
    const close = c;
    const highBase = Math.max(open, close);
    const lowBase  = Math.min(open, close);
    const high = highBase * 1.001;
    const low  = lowBase  * 0.999;
    out.push({ x: i, o: open, h: high, l: low, c: close, t: ts });
    prevClose = close;
  }
  return out;
}

function createDashCandleChart(ctx){
  const t = getDashChartType();

  const commonOpts = {
    responsive: true,
    maintainAspectRatio: false,
    animation: false,
    plugins: {
      legend: { display: false },
      tooltip: {
        enabled: true,
        intersect: false,
        mode: "index",
        displayColors: false,
        callbacks: {
          label: (context) => {
            const v = context.parsed.y;
            if (v == null) return "";
            const prefix = ctx.canvas.id === "btc-chart" || ctx.canvas.id === "eth-chart" ? "$ " : "";
            return prefix + v.toLocaleString();
          }
        }
      }
    },
    scales: {
      x: { display: false },
      y: { display: false }
    }
  };

  if (t === "candlestick"){
    return new Chart(ctx, {
      type: "candlestick",
      data: {
        datasets: [{
          data: [],
          borderWidth: 1
        }]
      },
      options: commonOpts
    });
  } else {
    return new Chart(ctx, {
      type: "line",
      data: {
        labels: [],
        datasets: [{
          data: [],
          tension: 0.25,
          borderWidth: 2,
          pointRadius: 0,
          fill: true,
          borderColor: "#22c55e",
          backgroundColor: (context) => {
            const chart = context.chart;
            const {ctx} = chart;
            const gradient = ctx.createLinearGradient(0, 0, 0, chart.height);
            gradient.addColorStop(0, "rgba(34, 197, 94, 0.35)");
            gradient.addColorStop(1, "rgba(34, 197, 94, 0)");
            return gradient;
          }
        }]
      },
      options: commonOpts
    });
  }
}

function updateDashChartFromSeries(chart, series){
  if (!chart || !Array.isArray(series) || !series.length) return;
  const t = chart.config.type;
  if (t === "candlestick"){
    const ohlc = closeSeriesToOhlc(series);
    chart.data.datasets[0].data = ohlc;
  } else {
    const labels = series.map(c => {
      if (!c || !c.t) return "";
      const d = new Date(c.t);
      const m = d.getMonth() + 1;
      const day = d.getDate();
      return `${m}/${day}`;
    });
    const values = series.map(c => Number(c.c));
    chart.data.labels = labels;
    chart.data.datasets[0].data = values;
  }
  chart.update("none");
}

function updateDashChartFromSeries(chart, series){
  if (!chart || !Array.isArray(series) || !series.length) return;
  const t = chart.config.type;
  if (t === "candlestick"){
    const ohlc = closeSeriesToOhlc(series);
    chart.data.datasets[0].data = ohlc;
  } else {
    const labels = series.map((_, idx) => idx.toString());
    const values = series.map(c => Number(c.c));
    chart.data.labels = labels;
    chart.data.datasets[0].data = values;
  }
  chart.update("none");
}

// Workerì—ì„œ ì½”ì¸ ì‹œê³„ì—´ ê°€ì ¸ì˜¤ê¸° (CoinGecko í”„ë¡ì‹œ)
async function fetchDashCoinSeries(asset, days){
  const url = `${DASH_WORKER_BASE}/api/candle?asset=${encodeURIComponent(asset)}&days=${encodeURIComponent(days)}`;
  const res = await fetch(url);
  const json = await res.json();
  return Array.isArray(json.candles) ? json.candles : [];
}

// ëŒ€ì‹œë³´ë“œ 2ê°œ ìì‚° ì—…ë°ì´íŠ¸ (BTC / ETH ì „ìš©)
async function refreshDashboardRealtime(){
  try {
    const [btc, eth] = await Promise.all([
      fetchDashCoinSeries("bitcoin", 1),
      fetchDashCoinSeries("ethereum", 1),
    ]);

    // BTC ê°±ì‹  + ìºì‹œ ì €ì¥
    if (btc && btc.length && DASH_CHARTS.btc){
      updateDashChartFromSeries(DASH_CHARTS.btc, btc);
      const last = btc[btc.length - 1].c;
      const el = document.getElementById("btc-price-text");
      if (el) el.textContent = `$ ${Number(last).toLocaleString()}`;
      try {
        localStorage.setItem(DASH_CACHE_KEY_BTC, JSON.stringify(btc));
      } catch(e){}
    }

    // ETH ê°±ì‹  + ìºì‹œ ì €ì¥
    if (eth && eth.length && DASH_CHARTS.eth){
      updateDashChartFromSeries(DASH_CHARTS.eth, eth);
      const last = eth[eth.length - 1].c;
      const el = document.getElementById("eth-price-text");
      if (el) el.textContent = `$ ${Number(last).toLocaleString()}`;
      try {
        localStorage.setItem(DASH_CACHE_KEY_ETH, JSON.stringify(eth));
      } catch(e){}
    }
  } catch (e) {
    console.error("refreshDashboardRealtime error:", e);
  }
}

function startDashboardRealtime(){
  if (DASHBOARD_STARTED) return;
  DASHBOARD_STARTED = true;

  const btcCanvas = document.getElementById("btc-chart");
  const ethCanvas = document.getElementById("eth-chart");

  if (btcCanvas) DASH_CHARTS.btc = createDashCandleChart(btcCanvas.getContext("2d"));
  if (ethCanvas) DASH_CHARTS.eth = createDashCandleChart(ethCanvas.getContext("2d"));

  // ğŸ” ìºì‹œëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë¨¼ì € ê·¸ë ¤ì£¼ê¸° (ë¹ ë¥¸ ì²« í™”ë©´ìš©)
  try {
    if (DASH_CHARTS.btc) {
      const rawBtc = localStorage.getItem(DASH_CACHE_KEY_BTC);
      if (rawBtc) {
        const cachedBtc = JSON.parse(rawBtc);
        if (Array.isArray(cachedBtc) && cachedBtc.length){
          updateDashChartFromSeries(DASH_CHARTS.btc, cachedBtc);
          const last = cachedBtc[cachedBtc.length - 1].c;
          const el = document.getElementById("btc-price-text");
          if (el) el.textContent = `$ ${Number(last).toLocaleString()}`;
        }
      }
    }
    if (DASH_CHARTS.eth) {
      const rawEth = localStorage.getItem(DASH_CACHE_KEY_ETH);
      if (rawEth) {
        const cachedEth = JSON.parse(rawEth);
        if (Array.isArray(cachedEth) && cachedEth.length){
          updateDashChartFromSeries(DASH_CHARTS.eth, cachedEth);
          const el = document.getElementById("eth-price-text");
          const last = cachedEth[cachedEth.length - 1].c;
          if (el) el.textContent = `$ ${Number(last).toLocaleString()}`;
        }
      }
    }
  } catch(e){}

  // ì²« ë¡œë“œ: ìµœì‹  ë°ì´í„°ë¡œ ê°±ì‹ 
  refreshDashboardRealtime();
  // 60ì´ˆë§ˆë‹¤ ê°±ì‹  (ì‹¤ì‹œê°„ ëŠë‚Œ)
  setInterval(refreshDashboardRealtime, 60000);
}

/* ì˜¤ëŠ˜ì˜ ì´ìŠˆ: Worker í”„ë¡ì‹œë¥¼ í†µí•œ ë‰´ìŠ¤ 3ê°œ */
async function loadDashboardNews(){
  const listEl = document.getElementById("dash-news-list");
  if (!listEl) return;
  try {
    listEl.innerHTML = "<li class='dash-news-placeholder'>ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</li>";
    const res = await fetch(`${DASH_WORKER_BASE}/api/news`);
    const json = await res.json();
    const items = Array.isArray(json.articles) ? json.articles : (json.Data || json.data || []);
    if (!items || !items.length){
      listEl.innerHTML = "<li class='dash-news-placeholder'>í‘œì‹œí•  ë‰´ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</li>";
      return;
    }
    const top = items.slice(0,3);
    listEl.innerHTML = top.map(n => {
      const title = n.title || "";
      const url = n.url || "#";
      return `<li><a href="${url}" target="_blank" rel="noopener noreferrer">${title}</a></li>`;
    }).join("");
  } catch(e) {
    console.error(e);
    listEl.innerHTML = "<li class='dash-news-placeholder'>ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</li>";
  }
}

/* í”„ë¡œì íŠ¸ ì¹´ë“œ: INFOFI_SNAPSHOTS ê¸°ì¤€ ìƒìœ„ í”„ë¡œì íŠ¸ */
function renderDashboardProjects(){
  const wrap = document.getElementById("dash-projects-wrap");
  if(!wrap || !Array.isArray(INFOFI_SNAPSHOTS)) return;

  const byProject = {};
  INFOFI_SNAPSHOTS.forEach(row=>{
    const p = row.project || "ê¸°íƒ€";
    if(!byProject[p] || (row.mindshare || 0) > (byProject[p].mindshare || 0)){
      byProject[p] = row;
    }
  });

  const arr = Object.values(byProject).sort((a,b)=>(b.mindshare||0)-(a.mindshare||0)).slice(0,6);
  if(!arr.length){
    wrap.innerHTML = "<div class='empty'>ì•„ì§ InfoFi í”„ë¡œì íŠ¸ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
    return;
  }
  wrap.innerHTML = arr.map((r)=>`
    <div class="dash-project-item">
      <div>
        <div class="dash-project-name">${r.project}</div>
        <div class="dash-project-rank">${r.window} Â· rank #${r.rank}</div>
      </div>
      <div style="font-size:11px;">MS ${Number(r.mindshare || 0).toFixed(2)}</div>
    </div>
  `).join("");
}

/* ëŒ€ì‹œë³´ë“œìš© ë¦¬ë”ë³´ë“œ TOP10 */

async function loadDashboardLeaderboardTop10(){
  const wrap = document.getElementById("dashboard-leaderboard-wrap");
  if(!wrap) return;
  try{
    wrap.innerHTML = "<div class='empty'>ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>";
    const res = await fetch(SCRIPT_URL);
    const data = await res.json();
    const list = Array.isArray(data) ? data : (data.top || []);
    if(!list || !list.length){
      wrap.innerHTML = "<div class='empty'>ì•„ì§ ë¦¬ë”ë³´ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
      return;
    }

    // ğŸ”¹ ì›ê¸€ ìˆ˜ë¥¼ ë°˜ì˜í•œ ê°€ì¤‘ì¹˜ ì ìˆ˜ ê³„ì‚° (ëŒ€ì‹œë³´ë“œìš© TOP10)
    const scoredList = list.slice().map(item => {
      const totalPosts = item.totalPosts || 0;
      const trimmed    = Number(item.trimmedAvg || 0);
      const reliability = Math.min(totalPosts, 60) / 60;       // 0 ~ 1
      const factor      = 0.4 + 0.6 * reliability;            // 0.4 ~ 1.0
      const score       = trimmed * factor;                   // ê°€ì¤‘ì¹˜ ì ìˆ˜
      return { ...item, _score: score, _factor: factor };
    }).sort((a,b) => (b._score || 0) - (a._score || 0));

    const top = scoredList.slice(0,10);

    const rows = top.map((item,idx)=>{
      const handle = item.handle || "";
      const handleClean = handle.replace("@","").trim();
      const trimmedAvg = Number(item.trimmedAvg || 0).toFixed(1);
      const avgScore  = Number(item.avgScore   || 0).toFixed(1);
      const totalPosts = item.totalPosts || 0;
      const bestLink  = item.bestLink || (handleClean ? `https://twitter.com/${handleClean}` : "#");
      return `
        <tr>
          <td>#${idx+1}</td>
          <td>
            <a href="${bestLink}" target="_blank" style="display:inline-flex;align-items:center;gap:6px;text-decoration:none;color:inherit;">
              <img src="https://unavatar.io/twitter/${handleClean}" style="width:20px;height:20px;border-radius:999px;border:1px solid rgba(209,213,219,1);" />
              <span>${handle}</span>
            </a>
          </td>
          <td>${trimmedAvg}</td>
          <td>${avgScore}</td>
          <td>${totalPosts}</td>
        </tr>`;
    }).join("");
    wrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>ìˆœìœ„</th>
            <th>í•¸ë“¤</th>
            <th>íŠ¸ë¦¼ë“œ í‰ê· </th>
            <th>í‰ê·  ìŠ¤ì½”ì–´</th>
            <th>ì›ê¸€ ìˆ˜</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  }catch(e){
    console.error(e);
    wrap.innerHTML = "<div class='empty'>ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>";
  }
}



function ensureDashboardInitialized(){
  startDashboardRealtime();
  loadDashboardNews();
  renderDashboardProjects();
  loadDashboardLeaderboardTop10();
}

/* ========= YAP í™•ë¥  ê³„ì‚° ê³µìš© í•¨ìˆ˜ ========= */
function calcYapProbability(trimmed, avg, posts){
  const t = Math.max(0, Number(trimmed||0));
  const a = Math.max(0, Number(avg||0));
  const p = Math.max(0, Number(posts||0));
  const qualNorm = Math.min(t / 100, 1);
  const avgNorm  = Math.min(a / 100, 1);
  const volNorm  = Math.min(p / 200, 1);
  const yapBase = 0.6 * qualNorm + 0.3 * avgNorm + 0.1 * volNorm;
  const prob = Math.max(5,
    Math.min(95, Math.round(5 + 60 * Math.pow(yapBase, 2)))
  );
  return prob;
}

/* YAP ì´ë„ˆì„œí´ / ê³ ë“ì  ê°€ì¤‘ì¹˜ í† ê¸€ */
function getYapBoostFactor(){
  let factor = 1;
  const inner = document.getElementById("yap-inner-toggle");
  const top100 = document.getElementById("yap-100-toggle");
  if(inner && inner.checked) factor *= 1.30;   // ì´ë„ˆì„œí´ +30%
  if(top100 && top100.checked) factor *= 1.15; // YAP 100ì  ê²½í—˜ +15%
  return factor;
}

/* ========= ê³„ì • ì„±ì¥ ê·¸ë˜í”„ ========== */

let growthChart = null;



function updateYapCard(analysis){
  const levelEl = document.getElementById("yap-level-text");
  const subEl   = document.getElementById("yap-level-sub");
  const tEl     = document.getElementById("yap-trimmed");
  const aEl     = document.getElementById("yap-avg");
  const pEl     = document.getElementById("yap-posts");
  const probEl  = document.getElementById("yap-prob");
  if(!levelEl || !subEl || !tEl || !aEl || !pEl || !probEl) return;

  // CSVê°€ ì•„ì§ ì—†ê±°ë‚˜ ë¶„ì„ ë°ì´í„°ê°€ ì—†ì„ ë•Œ
  if(!analysis){
    levelEl.textContent = "-";
    subEl.textContent   = "CSVë¥¼ ì—…ë¡œë“œí•˜ë©´ ìµœê·¼ íŒ¨í„´ì„ ê¸°ë°˜ìœ¼ë¡œ YAP ìƒìŠ¹ ì‹ í˜¸ë¥¼ ê°„ë‹¨íˆ ë³´ì—¬ì¤„ê²Œ.";
    tEl.textContent = "-";
    aEl.textContent = "-";
    pEl.textContent = "-";
    probEl.textContent = "-";
    return;
  }

  const trimmed = Number(analysis.trimmedAvg || 0);
  const avg     = Number(analysis.avgScore   || 0);
  const posts   = Number(analysis.totalPosts || 0);

  let prob = calcYapProbability(trimmed, avg, posts);
  // ì´ë„ˆì„œí´ / YAP 100ì  ê²½í—˜ ê°€ì¤‘ì¹˜ ì ìš©
  prob = Math.round(prob * getYapBoostFactor());
  if (prob > 100) prob = 100;
  if (prob < 0)   prob = 0;

  let level = "";
  let desc  = "";
  if(prob < 30){
    level = "ğŸ§Š Low";
    desc = "ìµœê·¼ íŒ¨í„´ ê¸°ì¤€ìœ¼ë¡œ YAPì´ ì˜¤ë¥¼ ê°€ëŠ¥ì„±ì´ ë‚®ì€ êµ¬ê°„ì´ì•¼.";
  }else if(prob < 60){
    level = "ğŸŒŠ Mid";
    desc = "ì§ˆ/ì–‘ ì¤‘ ì¼ë¶€ëŠ” ì˜¬ë¼ì™€ ìˆì–´ì„œ, ì¡°ê¸ˆë§Œ ë” ë°€ë©´ YAPì´ ë°˜ì‘í•  ìˆ˜ ìˆëŠ” ì¤‘ê°„ êµ¬ê°„ì´ì•¼.";
  }else{
    level = "ğŸ”¥ High";
    desc = "íŠ¸ë¦¼ë“œ/í‰ê· /í™œë™ëŸ‰ì´ ëª¨ë‘ ë†’ì€ í¸ì´ë¼ YAPì´ ì˜¤ë¥¼ í™•ë¥ ì´ ê½¤ ë†’ì€ ìƒíƒœì•¼.";
  }

  levelEl.textContent = level;
  subEl.textContent   = desc;
  tEl.textContent     = trimmed ? trimmed.toFixed(1) : "-";
  aEl.textContent     = avg ? avg.toFixed(1) : "-";
  pEl.textContent     = posts ? posts.toString() : "-";
  probEl.textContent  = prob + "%";
}

function renderYapHeatmap(list){
  const wrap = document.getElementById("yap-heatmap");
  if(!wrap) return;
  if(!list || !list.length){
    wrap.innerHTML = "<div class='empty'>CSVë¥¼ ì—…ë¡œë“œí•˜ê³  ê¸°ê°„ì„ ì„ íƒí•˜ë©´ ë‚ ì§œë³„ YAP ì‹ í˜¸ë¥¼ ìƒ‰ìœ¼ë¡œ ë³´ì—¬ì¤„ê²Œ.</div>";
    return;
  }
  wrap.innerHTML = "";
  const byDate = {};
  list.forEach(p=>{
    if(!p.dateObj) return;
    const d = p.dateObj.toISOString().slice(0,10);
    if(!byDate[d]) byDate[d] = [];
    byDate[d].push(p);
  });
  const dates = Object.keys(byDate).sort();
  dates.forEach(d=>{
    const arr = byDate[d];
    const scores = arr.map(p=>p.score||0).filter(v=>!isNaN(v));
    if(!scores.length) return;
    const posts = scores.length;
    const sum = scores.reduce((s,v)=>s+v,0);
    const avg = sum / posts;
    const trimmed = computeTrimmedAverage(arr, TRIM_RATIO);
    let prob = calcYapProbability(trimmed, avg, posts);
    // YAP ê°€ì¤‘ì¹˜ í† ê¸€ ë°˜ì˜
    prob = Math.round(prob * getYapBoostFactor());
    if (prob > 100) prob = 100;
    if (prob < 0)   prob = 0;
    let lvl = 1;
    if(prob >= 80) lvl = 5;
    else if(prob >= 60) lvl = 4;
    else if(prob >= 40) lvl = 3;
    else if(prob >= 20) lvl = 2;
    const box = document.createElement("div");
    box.className = "yap-heatbox level-" + lvl;
    box.title = d + "\níŠ¸ë¦¼ë“œ " + trimmed.toFixed(1) +
      " Â· í‰ê·  " + avg.toFixed(1) +
      " Â· ì›ê¸€ " + posts +
      " Â· YAP " + prob + "%";
    wrap.appendChild(box);
  });
}


function renderGrowthChart(list) {
  const canvas = document.getElementById("growth-chart");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");

  // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
  if (growthChart) {
    growthChart.destroy();
    growthChart = null;
  }

  // ë°ì´í„° ì—†ìœ¼ë©´ ìˆ¨ê¹€
  if (!list || list.length < 4) {
    canvas.style.display = "none";
    return;
  }
  canvas.style.display = "block";

  // ë‚ ì§œ ê¸°ì¤€ ì •ë ¬
  const arr = list.slice().sort((a, b) => {
    if (a.dateObj && b.dateObj) return a.dateObj - b.dateObj;
    return 0;
  });

  // xì¶•: ë‚ ì§œ
  const labels = arr.map(p =>
    p.dateObj
      ? `${p.dateObj.getMonth() + 1}/${p.dateObj.getDate()}`
      : ""
  );

  // yì¶•: ì ìˆ˜(ìŠ¤ì½”ì–´)
  const scores = arr.map(p => p.score);

  // ë‚ ì§œë³„ ìµœê³  ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ "ì¤‘ìš”í•œ ë‚ " ì„ ì •
  // ê° ë‚ ì§œë§ˆë‹¤ ìµœê³  ì ìˆ˜ë¥¼ ê°€ì§„ ì¸ë±ìŠ¤ë¥¼ ì €ì¥
  const byDateMax = {};
  arr.forEach((p, idx) => {
    if (!p.dateObj) return;
    const d = p.dateObj.toISOString().slice(0,10);
    const s = Number(p.score || 0);
    if (!byDateMax[d] || s > byDateMax[d].score) {
      byDateMax[d] = { score: s, index: idx };
    }
  });

  // ìµœê³  ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬ í›„ ìƒìœ„ Nê°œ ë‚ ì§œë§Œ ì„ íƒ
  const maxEntries = Object.values(byDateMax)
    .sort((a, b) => b.score - a.score);

  const MAX_DOTS = 7; // í•œ ëˆˆì— ë³´ê¸° ìœ„í•œ ìµœëŒ€ ì  ê°œìˆ˜
  const topEntries = maxEntries.slice(0, MAX_DOTS);

  // ì„ íƒëœ ì¸ë±ìŠ¤ë§Œ ë¹¨ê°„ ì ìœ¼ë¡œ í‘œì‹œ
  const highlightIndexSet = new Set(topEntries.map(e => e.index));
  const yapPoints = arr.map((p, idx) => {
    return highlightIndexSet.has(idx) ? p.score : null;
  });

  // ë‚ ì§œë³„ ì ìˆ˜ ë°°ì—´ ëª¨ìœ¼ê¸°
  const byDateScores = {};
  arr.forEach(p => {
    if (!p.dateObj) return;
    const d = p.dateObj.toISOString().slice(0,10);
    if (!byDateScores[d]) byDateScores[d] = [];
    byDateScores[d].push(Number(p.score || 0));
  });

  // ë‚ ì§œ ì •ë ¬ í›„, ì¹´ë“œì™€ ìœ ì‚¬í•œ ìŠ¤ì¼€ì¼ì˜ YAP í™•ë¥  + ì „ê³ ì /í•˜ë½ ê°€ì¤‘ì¹˜ ê³„ì‚°
  const sortedDates = Object.keys(byDateScores).sort();
  const yapProbByDate = {};
  let prevTrim = -Infinity;
  let prevAvg  = -Infinity;

  sortedDates.forEach(d => {
    const scoresArr = byDateScores[d];
    if (!scoresArr.length) {
      yapProbByDate[d] = 0;
      return;
    }
    const posts = scoresArr.length;
    const sum = scoresArr.reduce((s, v) => s + v, 0);
    const avg = sum / posts;
    const trimmed = computeTrimmedAverage(scoresArr, TRIM_RATIO);

    // 1) ê¸°ë³¸ YAP í™•ë¥  (ì¹´ë“œ ìŠ¤ì¼€ì¼ì— ë§ì¶”ê¸° ìœ„í•´ ì‚´ì§ ìƒí–¥)
    let baseProb = calcYapProbability(trimmed, avg, posts);
    baseProb = baseProb * 1.2 + 10; // ì „ë°˜ì ìœ¼ë¡œ ìœ í•¨ ì œê±° + ì¹´ë“œì™€ ë¹„ìŠ·í•œ ë°¸ë¥˜
    if (baseProb > 100) baseProb = 100;
    if (baseProb < 0) baseProb = 0;

    // 2) ì „ê³ ì /í•˜ë½ ê°€ì¤‘ì¹˜
    let boost = 1.0;
    const isAbovePrevTrim = trimmed > prevTrim;
    const isAbovePrevAvg  = avg > prevAvg;
    const isBelowPrevTrim = trimmed < prevTrim;
    const isBelowPrevAvg  = avg < prevAvg;

    // ê°•í•œ ì „ê³ ì  ëŒíŒŒ (íŠ¸ë¦¼ë“œ & í‰ê·  ë‘˜ ë‹¤ ì´ì „ ìµœê³  ê°±ì‹ ) â†’ í™•í™• ì˜¬ë¼ê°€ê²Œ
    if (isAbovePrevTrim && isAbovePrevAvg) {
      boost *= 2.2;
    }
    // ì•½í•œ ëŒíŒŒ (ë‘˜ ì¤‘ í•˜ë‚˜ë§Œ ê°±ì‹ )
    else if (isAbovePrevTrim || isAbovePrevAvg) {
      boost *= 1.45;
    }

    // í•˜ë½ì¼ íŒ¨ë„í‹°ëŠ” ì•½í•˜ê²Œë§Œ ì ìš© (ë„ˆë¬´ ëˆŒë¦¬ì§€ ì•Šê²Œ)
    if (isBelowPrevTrim && isBelowPrevAvg) {
      boost *= 0.9;
    }
    else if (isBelowPrevTrim || isBelowPrevAvg) {
      boost *= 0.95;
    }

    let adjProb = baseProb * boost * getYapBoostFactor();
    if (adjProb > 100) adjProb = 100;
    if (adjProb < 0) adjProb = 0;

    yapProbByDate[d] = adjProb;

    // ë‹¤ìŒ ë‚  ë¹„êµë¥¼ ìœ„í•œ ê¸°ì¤€ ì—…ë°ì´íŠ¸
    if (trimmed > prevTrim) prevTrim = trimmed;
    if (avg > prevAvg) prevAvg = avg;
  });

  // xì¶• ì¸ë±ìŠ¤ ê¸°ì¤€ìœ¼ë¡œ ë§¤í•‘í•œ í™•ë¥  (íˆ´íŒì—ì„œ ì‚¬ìš©)
  const yapProbByIndex = arr.map(p => {
    if (!p.dateObj) return 0;
    const d = p.dateObj.toISOString().slice(0,10);
    return yapProbByDate[d] || 0;
  });

  // ê·¸ë˜ë””ì–¸íŠ¸ ìƒì„±
  const gradient = ctx.createLinearGradient(0, 0, 0, 200);
  gradient.addColorStop(0, "rgba(59,130,246,0.4)");
  gradient.addColorStop(1, "rgba(59,130,246,0.05)");

  const pointShadow = {
    id: "pointShadow",
    afterDraw(chart, args, options) {
      const ctx = chart.ctx;
      ctx.save();
      ctx.shadowColor = "rgba(59,130,246,0.6)";
      ctx.shadowBlur = 12;
      ctx.shadowOffsetX = 0;
      ctx.shadowOffsetY = 0;
    }
  };

  growthChart = new Chart(ctx, {
    type: "line",
    data: {
      labels,
      datasets: [
        {
          label: "ê³„ì • ì„±ì¥ ìŠ¤ì½”ì–´",
          data: scores,
          fill: true,
          backgroundColor: gradient,
          borderColor: "rgba(59,130,246,1)",
          borderWidth: 3,
          tension: 0.35,
          pointRadius: 0,
          pointBackgroundColor: "rgba(59,130,246,1)",
          pointBorderColor: "rgba(59,130,246,1)",
          pointHoverRadius: 6,
          pointHitRadius: 18
        },
        {
          label: "YAP ì‹ í˜¸",
          data: yapPoints,
          fill: false,
          borderColor: "rgba(239,68,68,1)",
          borderWidth: 0,
          tension: 0.3,
          pointRadius: 4,
          pointBackgroundColor: "rgba(239,68,68,1)",
          pointBorderColor: "rgba(248,250,252,1)",
          pointHoverRadius: 7,
          pointHitRadius: 18,
          showLine: false
        }
      ]
    },
    options: {
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function(context) {
              const value = context.parsed.y;
              if (context.datasetIndex === 0) {
                return "ê³„ì • ì„±ì¥ ìŠ¤ì½”ì–´: " + value.toFixed(3);
              } else {
                return "ì‚ë½€ì‚ë½€ yaps ì‹ í˜¸ ë°œìƒ";
              }
            }
          }
        }
      },
      scales: {
        x: {
          ticks: { color: "#9ca3af" },
          grid: { display: false }
        },
        y: {
          ticks: { color: "#9ca3af" },
          grid: { color: "rgba(148,163,184,0.1)" }
        }
      }
    },
    plugins: [pointShadow]
  });
}
/* ========== CSV ì—…ë¡œë“œ ========== */
document.getElementById("csvInput").addEventListener("change", e=>{
  const file=e.target.files[0]; if(!file) return;
  Papa.parse(file,{
    header:true,skipEmptyLines:true,
    complete:res=>{
      ALL_BASE=[];
      res.data.forEach(row=>{
        const r=autoMap(row);
        const t=(r.text||"").trim();
        if(!t || t.startsWith("@")) return;
        const dateObj = parseDateValue(r.date);

        // ë§í¬ê°€ ì—†ê³  íŠ¸ìœ— IDë§Œ ìˆëŠ” ê²½ìš° ë³´ì™„
        let link = r.link;
        if((!link || !String(link).trim()) && r.id){
          const id = String(r.id).trim();
          if(id){
            link = `https://twitter.com/i/web/status/${id}`;
          }
        }

        const p={
          text:t,
          date:r.date || "",
          dateObj,
          link,
          impressions:num(r.impressions),
          engagements:num(r.engagements),
          likes:num(r.likes),
          bookmarks:num(r.bookmarks),
          newFollows:num(r.newFollows),
          replies:num(r.replies),
          retweets:num(r.retweets),
          shares:num(r.shares),
          profileClicks:num(r.profileClicks),
          urlClicks:num(r.urlClicks),
          uniqueClicks:num(r.uniqueClicks),
        };
        p.score=computeScore(p);
        tagProjectsForPost(p);
        ALL_BASE.push(p);
      });

      if(!ALL_BASE.length){
        document.getElementById("error").textContent="CSVì—ì„œ ë¶„ì„ ê°€ëŠ¥í•œ ì›ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.";
      }else{
        document.getElementById("error").textContent="";
        CURRENT_RANGE = "ALL";
        CURRENT_GRADE = "ALL";
        const rangeTabs = document.getElementById("range-tabs");
        if(rangeTabs){
          rangeTabs.style.display = "flex";
        }
        setupRangeTabs();
        updateView();
        saveHistoryEntry();
        saveLastSnapshot();
      }
    }
  });
      if(ALL_BASE.length){
        // CSV ì—…ë¡œë“œ í›„ ìë™ìœ¼ë¡œ ë¦¬ë”ë³´ë“œì™€ ì—°ê²°
        try{
          const handleInput = document.getElementById("leader-handle");
          if(handleInput && !handleInput.value.trim()){
            const sideHandle = document.getElementById("side-handle-link");
            if(sideHandle){
              const txt = (sideHandle.textContent || "").trim();
              if(txt && txt !== "@ìµëª…"){
                handleInput.value = txt;
              }
            }
          }
          const finalHandleInput = document.getElementById("leader-handle");
          if(finalHandleInput){
            const hv = (finalHandleInput.value || "").trim();
            if(hv && hv !== "@ìµëª…" && typeof saveToLeaderboard === "function"){
              saveToLeaderboard();
            }
          }
        }catch(err){
          console.error("ìë™ ë¦¬ë”ë³´ë“œ ì—°ë™ ì¤‘ ì˜¤ë¥˜:", err);
        }
      }
});

/* ========== ë¦¬ë”ë³´ë“œ ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ========== */
async function saveToLeaderboard(){
  if(!ANALYSIS){
    alert("ë¨¼ì € CSVë¥¼ ì—…ë¡œë“œí•´ì„œ ë¶„ì„ì„ ëŒë ¤ì¤˜.");
    return;
  }
  const handleInput = document.getElementById("leader-handle");
  const handle = (handleInput.value || "").trim();
  if(!handle){
    alert("X í•¸ë“¤ì„ ì…ë ¥í•´ì¤˜. (ì˜ˆ: @bud_dha__)");
    handleInput.focus();
    return;
  }
  if(ANALYSIS.totalPosts < MIN_POSTS_FOR_LEADERBOARD){
    if(!confirm(`ì›ê¸€ì´ ${ANALYSIS.totalPosts}ê°œì…ë‹ˆë‹¤. ìµœì†Œ ${MIN_POSTS_FOR_LEADERBOARD}ê°œ ì´ìƒì¼ ë•Œ ì¶”ì²œí•´.\nê·¸ë˜ë„ ì €ì¥í• ë˜?`)) return;
  }

  const bestPost = CURRENT_LIST.slice().sort((a,b)=>b.score-a.score)[0];

  const payload = {
    handle,
    trimmedAvg: ANALYSIS.trimmedAvg,
    avgScore: ANALYSIS.avgScore,
    bestScore: ANALYSIS.bestScore,
    bestDate: ANALYSIS.bestDate,
    bestLink: ANALYSIS.bestLink,
    bestText: bestPost?.text || "",
    bestGrade: bestPost?.grade || "",
    totalPosts: ANALYSIS.totalPosts
  };

  try{
    await fetch(SCRIPT_URL, {
      method: "POST",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: JSON.stringify(payload)
    });
    alert("ë¦¬ë”ë³´ë“œì— ê¸°ë¡ ì €ì¥ ì™„ë£Œ! ğŸ”¥");
    loadLeaderboard(handle);
  }catch(err){
    console.error(err);
    alert("ë¦¬ë”ë³´ë“œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆë‹¤.");
  }
}

async function loadLeaderboard(handle){
  const tableWrap = document.getElementById("leaderboard-wrap");
  const myRankWrap = document.getElementById("my-rank-wrap");
  if(!tableWrap) return;
  try{
    const url = handle
      ? `${SCRIPT_URL}?handle=${encodeURIComponent(handle)}`
      : SCRIPT_URL;
    const res  = await fetch(url);
    const data = await res.json();
    const list   = Array.isArray(data) ? data : (data.top || []);
    const myRank = !Array.isArray(data) ? data.myRank : null;
    if(myRankWrap) myRankWrap.innerHTML = "";

    if(!list || !list.length){
      tableWrap.innerHTML = "<div class='empty'>ì•„ì§ ë¦¬ë”ë³´ë“œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>";
      return;
    }

    // ğŸ”¹ ì›ê¸€ ìˆ˜ë¥¼ ë°˜ì˜í•œ ê°€ì¤‘ì¹˜ ì ìˆ˜ ê³„ì‚° (ë¦¬ë”ë³´ë“œ ì „ìš©)
    const scoredList = list.slice().map(item => {
      const totalPosts = item.totalPosts || 0;
      const trimmed    = Number(item.trimmedAvg || 0);
      // ì›ê¸€ 60ê°œ ì´ìƒì´ë©´ ì‹ ë¢°ë„ 1, ê·¸ ì´í•˜ëŠ” ì„ í˜• ê°ì†Œ
      const reliability = Math.min(totalPosts, 60) / 60;       // 0 ~ 1
      const factor      = 0.4 + 0.6 * reliability;            // 0.4 ~ 1.0
      const score       = trimmed * factor;                   // ê°€ì¤‘ì¹˜ ì ìˆ˜
      return { ...item, _score: score, _factor: factor };
    }).sort((a,b) => (b._score || 0) - (a._score || 0));

    // ğŸ”¹ ë‚´ ìˆœìœ„ë„ ê°€ì¤‘ì¹˜ ê¸°ì¤€ìœ¼ë¡œ ì¬ê³„ì‚°
    if(myRank && myRankWrap){
      const trimmedAvg = Number(myRank.trimmedAvg || 0).toFixed(1);
      const avgScore   = Number(myRank.avgScore   || 0).toFixed(1);
      const totalPosts = myRank.totalPosts || 0;

      let displayRank = myRank.rank;
      try{
        const targetHandle = (myRank.handle || "").trim();
        if(targetHandle){
          const foundIndex = scoredList.findIndex(it => (it.handle || "").trim() === targetHandle);
          if(foundIndex >= 0){
            displayRank = foundIndex + 1;
          }
        }
      }catch(e){}

      myRankWrap.innerHTML = `
        <div style="padding:10px 12px;margin-bottom:8px;border-radius:12px;border:1px solid rgba(209,213,219,1);background:#f9fafb;font-size:12px;">
          <div style="font-size:13px;font-weight:700;margin-bottom:4px;">ë‚´ í˜„ì¬ ìˆœìœ„</div>
          <div style="display:flex;flex-wrap:wrap;gap:8px;align-items:center;">
            <span style="font-weight:700;color:#f97316;">#${displayRank}ìœ„</span>
            <span>Â· íŠ¸ë¦¼ë“œ í‰ê·  <strong>${trimmedAvg}</strong></span>
            <span>Â· í‰ê·  ìŠ¤ì½”ì–´ <strong>${avgScore}</strong></span>
            <span>Â· ì›ê¸€ ìˆ˜ <strong>${totalPosts}</strong></span>
          </div>
        </div>
      `;
    }

    const rows = scoredList.map((item, idx) => {
      const handle      = item.handle || "";
      const handleClean = handle.replace("@","").trim();
      const trimmedAvg  = Number(item.trimmedAvg || 0).toFixed(1);
      const avgScore    = Number(item.avgScore   || 0).toFixed(1);
      const totalPosts  = item.totalPosts || 0;
      const bestLink    = item.bestLink || (handleClean ? `https://twitter.com/${handleClean}` : "#");
      return `
        <tr>
          <td>#${idx+1}</td>
          <td>
            <a href="${bestLink}" target="_blank" style="display:inline-flex;align-items:center;gap:6px;text-decoration:none;color:#111827">
              <img src="https://unavatar.io/twitter/${handleClean}" style="width:20px;height:20px;border-radius:999px;border:1px solid rgba(209,213,219,1)"/>
              <span>${handle}</span>
            </a>
          </td>
          <td>${trimmedAvg}</td>
          <td>${avgScore}</td>
          <td>${totalPosts}</td>
          <td>${item.bestLink ? `<a href="${item.bestLink}" class="link-pill" target="_blank">ëŒ€í‘œ íŠ¸ìœ— ë³´ê¸° â†—</a>` : ""}</td>
        </tr>`;
    }).join("");
    tableWrap.innerHTML = `
      <table>
        <thead>
          <tr>
            <th>ìˆœìœ„</th>
            <th>í•¸ë“¤</th>
            <th>íŠ¸ë¦¼ë“œ í‰ê· </th>
            <th>í‰ê·  ìŠ¤ì½”ì–´</th>
            <th>ì›ê¸€ ìˆ˜</th>
            <th>ëŒ€í‘œ íŠ¸ìœ—</th>
          </tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>`;
  }catch(err){
    console.error(err);
    tableWrap.innerHTML = "<div class='empty'>ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆë‹¤.</div>";
  }
}


/* ========== ë‹¤êµ­ì–´ UI (KO/EN/JA/ZH) ========== */
const MS_I18N = {
  ko: {
    "#view-dashboard .top-title": "X í¬ë¦¬ì—ì´í„° ë§ˆì¸ë“œì‰ì–´ ë¶„ì„ê¸°",
    "#view-dashboard .top-sub": "ì• ë„ë¦¬í‹±ìŠ¤ CSVë¡œ ë‚´ ê³„ì •ì˜ ì§„ì§œ ì„íŒ©íŠ¸ë¥¼ ë³´ëŠ” ëŒ€ì‹œë³´ë“œ",
    ".hero-main-title": "ë§ˆì¸ë“œì‰ì–´ ìŠ¤ì½”ì–´ Â· S~D ë“±ê¸‰ Â· ë¦¬ë”ë³´ë“œê¹Œì§€ í•œ ë²ˆì—",
    ".hero-desc": "X ì• ë„ë¦¬í‹±ìŠ¤ì—ì„œ CSVë¥¼ ë‚´ë ¤ë°›ê³  ì´ê³³ì— ì—…ë¡œë“œí•˜ë©´,<br>ì›ê¸€ ê¸°ì¤€ìœ¼ë¡œ ë§ˆì¸ë“œì‰ì–´ ì ìˆ˜ì™€ ìƒìœ„ ê¸€, ë¦¬ë”ë³´ë“œê¹Œì§€ í•œ ë²ˆì— ë¶„ì„í•  ìˆ˜ ìˆì–´.",
    ".hero-pill": "<span class='hero-dot'></span> CSV í•œ ë²ˆ â†’ ê³„ì • ë¶„ì„ ë",
    ".file-input-fake": "ğŸ“ CSV íŒŒì¼ ì„ íƒí•˜ê¸°",
    ".file-hint": "account_analytics_content_YYYY-MM-DD_YYYY-MM-DD.csv ê·¸ëŒ€ë¡œ ì—…ë¡œë“œ",
    ".badge": "<span class='badge-dot'></span>í•œêµ­ì–´Â·ì˜ì–´ CSV ìë™ ì¸ì‹ Â· ë‹µê¸€ ì œì™¸ í›„ ì›ê¸€ë§Œ ë¶„ì„",
    "#range-tabs button[data-range='ALL']": "ì „ì²´ ê¸°ê°„",
    "#range-tabs button[data-range='7']": "ìµœê·¼ 7ì¼",
    "#range-tabs button[data-range='30']": "ìµœê·¼ 30ì¼",
    "#range-tabs button[data-range='90']": "ìµœê·¼ 90ì¼",
    "#view-leaderboard .top-title": "í¬ë¦¬ì—ì´í„° ë§ˆì¸ë“œì‰ì–´ ë¦¬ë”ë³´ë“œ",
    "#view-leaderboard .top-sub": "ë‚´ ìˆœìœ„ Â· íŠ¸ë¦¼ë“œ í‰ê·  Â· ëŒ€í‘œ íŠ¸ìœ—ì„ í•œ ëˆˆì— ë³´ëŠ” ë­í‚¹ ë³´ë“œ",
    "#view-projects .top-title": "í”„ë¡œì íŠ¸ë³„ ë§ˆì¸ë“œì‰ì–´",
    "#view-projects .top-sub": "íŠ¸ìœ— ë³¸ë¬¸ í‚¤ì›Œë“œ ê¸°ì¤€ìœ¼ë¡œ í”„ë¡œì íŠ¸ë³„ ì„íŒ©íŠ¸ì™€ ê²Œì‹œê¸€/ë“±ê¸‰ì„ ë¶„ì„í•©ë‹ˆë‹¤.",
    ".side-badge": "ì˜¤ëŠ˜ë„ í•œ ë²ˆ<br>ë§ˆì‰ í„°íŠ¸ë ¤ë³¼ê¹Œ? ğŸ’¥",
    "#leaderboard-section .section-title": "ğŸ† í¬ë¦¬ì—ì´í„° ë§ˆì¸ë“œì‰ì–´ ë¦¬ë”ë³´ë“œ (Beta)",
    "#leader-handle::placeholder": "X í•¸ë“¤ ì…ë ¥ (ì˜ˆ: @bud_dha__)",
    "#nav-dashboard-label": "Dashboard",
    "#nav-leaderboard-label": "ë¦¬ë”ë³´ë“œ",
    "#nav-projects-label": "í”„ë¡œì íŠ¸ë³„ ë§ˆì¸ë“œì‰ì–´",
    "#nav-course-label": "í¬ë¦½í†  í’€ì½”ìŠ¤",
    "#growth-title": "ğŸ“ˆ ê³„ì • ì„±ì¥ ê·¸ë˜í”„",
    "#growth-sub": "ìµœê·¼ ê¸°ê°„ ë™ì•ˆ ì›ê¸€ ê°œìˆ˜ / í‰ê·  ìŠ¤ì½”ì–´ ì¶”ì´ë¥¼ ê·¸ë˜í”„ë¡œ ë³´ì—¬ì¤ë‹ˆë‹¤.",
    "#top10-title": "ğŸ’¥ ë§ˆì¸ë“œì‰ì–´ í­ë°œ Top 10 <span id='top10-count'></span>",
    "#grade-section-title": "ğŸš ë“±ê¸‰ë³„ ìƒìœ„ ê²Œì‹œê¸€ <span>(S~D)</span>",
    "#coach-title": "ğŸ¤– ë§ˆì¸ë“œì‰ì–´ ì½”ì¹˜ ë´‡ <span style='font-size:11px;color:var(--text-muted);'>(Beta)</span>",
    "#coach-chip-text": "í˜„ì¬ ì„ íƒí•œ ê¸°ê°„ ê¸°ì¤€ Â· YAP ì‹ í˜¸ëŠ” ìµœê·¼ 7ì¼ ì •í™•ë„â†‘ í•œ ì¤„ ìš”ì•½ + í”¼ë“œë°±",
    ".yap-label": "í˜„ì¬ ì„ íƒí•œ ê¸°ê°„ ê¸°ì¤€ Â· YAP ì‹ í˜¸ëŠ” ìµœê·¼ 7ì¼ ì •í™•ë„â†‘",
    "#leader-note": "â€» ìµœì†Œ ì›ê¸€ ìˆ˜ 20ê°œ ì´ìƒì¼ ë•Œ ë¦¬ë”ë³´ë“œ ì ìˆ˜ê°€ ë” ì •í™•í•©ë‹ˆë‹¤.",
    "#project-summary-title": "ğŸ“š í”„ë¡œì íŠ¸ ìš”ì•½ + ì›í˜• ê·¸ë˜í”„",
    "#project-summary-sub": "ì½”ë“œ ìƒë‹¨ <code>PROJECTS</code> ë°°ì—´ì˜ í‚¤ì›Œë“œë¥¼ ë„¤ê°€ íŠ¸ëŠ” í”„ë¡œì íŠ¸ì— ë§ê²Œ ë°”ê¿”ì¤˜.",
    "#proj-chart-title-1": "í”„ë¡œì íŠ¸ë³„ ê²Œì‹œê¸€ ë¹„ìœ¨",
    "#proj-chart-title-2": "í”„ë¡œì íŠ¸ë³„ í‰ê·  ì ìˆ˜ (íŠ¸ë¦¼ë“œ ê¸°ì¤€)",
    "#proj-chart-title-3": "ì„ íƒ í”„ë¡œì íŠ¸ S~D ë“±ê¸‰ ë¶„í¬"
  },
  en: {
    "#view-dashboard .top-title": "X Creator Mindshare Analyzer",
    "#view-dashboard .top-sub": "Dashboard to see your real impact using X Analytics CSV",
    ".hero-main-title": "Mindshare score Â· S~D grades Â· Leaderboard in one place",
    ".hero-desc": "Download CSV from X Analytics and upload here.<br>You can analyze mindshare scores, top posts, and leaderboard based on original posts only.",
    ".hero-pill": "<span class='hero-dot'></span> One CSV â†’ Full account analysis",
    ".file-input-fake": "ğŸ“ Choose CSV file",
    ".file-hint": "Upload account_analytics_content_YYYY-MM-DD_YYYY-MM-DD.csv as is",
    ".badge": "<span class='badge-dot'></span>KO/EN CSV auto-detect Â· replies excluded, originals only",
    "#range-tabs button[data-range='ALL']": "All time",
    "#range-tabs button[data-range='7']": "Last 7 days",
    "#range-tabs button[data-range='30']": "Last 30 days",
    "#range-tabs button[data-range='90']": "Last 90 days",
    "#view-leaderboard .top-title": "Creator Mindshare Leaderboard",
    "#view-leaderboard .top-sub": "Check your rank, trimmed average score, and key tweet at a glance",
    "#view-projects .top-title": "Project-wise Mindshare",
    "#view-projects .top-sub": "Analyze impact and grades per project based on tweet text keywords.",
    ".side-badge": "Shall we blow up<br>mindshare again today? ğŸ’¥",
    "#leaderboard-section .section-title": "ğŸ† Creator Mindshare Leaderboard (Beta)",
    "#leader-handle::placeholder": "Enter X handle (e.g., @bud_dha__)",
    "#nav-dashboard-label": "Dashboard",
    "#nav-leaderboard-label": "Leaderboard",
    "#nav-projects-label": "Project Mindshare",
    "#nav-course-label": "Crypto Fullcourse",
    "#growth-title": "ğŸ“ˆ Account Growth Chart",
    "#growth-sub": "Shows the trend of original post count and average score over time.",
    "#top10-title": "ğŸ’¥ Top 10 Mindshare Posts <span id='top10-count'></span>",
    "#grade-section-title": "ğŸš Top Posts by Grade <span>(S~D)</span>",
    "#coach-title": "ğŸ¤– Mindshare Coach Bot <span style='font-size:11px;color:var(--text-muted);'>(Beta)</span>",
    "#coach-chip-text": "One-line summary & feedback for the selected period",
    ".yap-label": "Based on the currently selected period Â· YAP signal is most accurate over the last 7 days",
    "#leader-note": "â€» For best accuracy, use at least 20 original posts before saving to the leaderboard.",
    "#project-summary-title": "ğŸ“š Project Summary + Donut Chart",
    "#project-summary-sub": "Edit the <code>PROJECTS</code> array at the top of the code to match the projects you tweet about."
  },
};

function applyLang(lang) {
  CURRENT_LANG = lang;
  const dict = MS_I18N[lang] || MS_I18N.ko;
  Object.keys(dict).forEach(sel => {
    // placeholder ì²˜ë¦¬
    if (sel.endsWith("::placeholder")) {
      const realSel = sel.replace("::placeholder", "");
      const el = document.querySelector(realSel);
      if (el) el.setAttribute("placeholder", dict[sel]);
    } else {
      const el = document.querySelector(sel);
      if (el) el.innerHTML = dict[sel];
    }
  });
  document.documentElement.setAttribute("lang", lang);
  localStorage.setItem("ms_lang", lang);
  document.querySelectorAll(".lang-btn").forEach(btn => {
    btn.classList.toggle("active", btn.dataset.lang === lang);
  });
  // ì–¸ì–´ê°€ ë°”ë€” ë•Œ ì½”ì¹˜ë´‡ í…ìŠ¤íŠ¸ë„ ë°”ë¡œ ì–¸ì–´ì— ë§ê²Œ ë‹¤ì‹œ ë Œë”ë§
  if (typeof updateCoach === "function") {
    try { updateCoach(); } catch(e) {}
  }
}

function initLangToggle() {
  const saved = localStorage.getItem("ms_lang") || "ko";
  applyLang(saved);
  document.querySelectorAll(".lang-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      applyLang(btn.dataset.lang);
    });
  });
}

initLangToggle();

/* ========== íƒ­ & ì´ë²¤íŠ¸ ========== */
document.querySelectorAll(".grade-tab").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".grade-tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    const g=btn.dataset.grade;
    CURRENT_GRADE = g;
    if(g==="ALL") renderGrade(CURRENT_LIST.slice(0,30));
    else renderGrade(buckets[g] || []);
  });
});

document.querySelectorAll(".range-tab").forEach(btn=>{
  btn.addEventListener("click",()=>{
    document.querySelectorAll(".range-tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    CURRENT_RANGE = btn.dataset.range || "ALL";
    updateView();
  });
});

const sortSelect = document.getElementById("sort-key");
if(sortSelect){
  sortSelect.addEventListener("change", e=>{
    SORT_KEY = e.target.value || "score";
    if(!CURRENT_LIST.length) return;
    renderTop10(CURRENT_LIST);
    if(CURRENT_GRADE === "ALL") renderGrade(CURRENT_LIST.slice(0,30));
    else renderGrade(buckets[CURRENT_GRADE] || []);
  });
}

document.getElementById("leader-save-btn").addEventListener("click", saveToLeaderboard);
loadLeaderboard();

/* ========== ì‚¬ì´ë“œë°” ë·° í† ê¸€ ========== */


// ===== ì‚¬ì´ë“œë°” íƒ­ ì „í™˜ ë¡œì§ (ìµœì í™” ë²„ì „) =====
document.addEventListener("DOMContentLoaded", () => {
  
const viewNavItems = document.querySelectorAll(".side-nav-item[data-view]");
  const viewDashboard = document.getElementById("view-dashboard");
  const viewCsv = document.getElementById("view-csv");
  const viewLeaderboard = document.getElementById("view-leaderboard");
  const viewProjects = document.getElementById("view-projects");
  const viewHistory = document.getElementById("view-history");
  const viewYapping = document.getElementById("view-yapping");
  const viewInfofi = document.getElementById("view-infofi");


  function showView(target){
    if (!viewDashboard || !viewLeaderboard || !viewProjects) return;

    // ê¸°ë³¸ê°’: ì „ë¶€ ìˆ¨ê¸°ê¸°
    viewDashboard.style.display = "none";
    if (viewCsv) viewCsv.style.display = "none";
    viewLeaderboard.style.display = "none";
    viewProjects.style.display = "none";
    if (viewHistory) viewHistory.style.display = "none";
    if (viewYapping) viewYapping.style.display = "none";
    if (viewInfofi) viewInfofi.style.display = "none";
    const viewCommunity = document.getElementById("view-community");
    if (viewCommunity) viewCommunity.style.display = "none";

    switch(target){
      case "leaderboard":
        viewLeaderboard.style.display = "block";
        if (typeof loadLeaderboard === "function") {
          loadLeaderboard();
        }
        break;
      case "projects":
        viewProjects.style.display = "block";
        break;
      case "history":
        if (viewHistory) {
          viewHistory.style.display = "block";
          if (typeof renderHistoryList === "function") {
            renderHistoryList();
          }
        }
        break;
      case "yapping":
        if (viewYapping) {
          viewYapping.style.display = "block";
        }
        break;
      case "infofi":
        if (viewInfofi) {
          viewInfofi.style.display = "block";
        }
        break;
      case "community":
        if (viewCommunity) {
          viewCommunity.style.display = "block";
          if (typeof initCommunity === "function") {
            initCommunity();
          }
        }
        break;
      case "csv":
        if (viewCsv) {
          viewCsv.style.display = "block";
        }
        break;
      case "dashboard":
      default:
        viewDashboard.style.display = "block";
        if (typeof ensureDashboardInitialized === "function") {
          ensureDashboardInitialized();
        }
        break;
    }
  }

  // ì²˜ìŒ ë¡œë“œì‹œ ëŒ€ì‹œë³´ë“œ ë³´ì´ë„ë¡
  showView("dashboard");
  viewNavItems.forEach(item => {
    item.addEventListener("click", () => {
      const view = item.dataset.view || "dashboard";

      // active í´ë˜ìŠ¤ í† ê¸€
      viewNavItems.forEach(i => i.classList.remove("active"));
      item.classList.add("active");

      // ë·° ì „í™˜
      showView(view);

      // ğŸ” InfoFi íƒ­ì„ í´ë¦­í•˜ë©´ ë‚´ í•¸ë“¤ë¡œ InfoFi + Kaito ë¦¬ë”ë³´ë“œë¥¼ ìë™ ì¡°íšŒ
      if (view === "infofi") {
        try {
          let handle = "";
          const infofiInput = document.getElementById("infofi-handle-input");
          const leaderInput = document.getElementById("leader-handle");
          // kaito ì „ìš© ì…ë ¥ì€ ì œê±°ë¨

          if (infofiInput && infofiInput.value.trim()) {
            handle = infofiInput.value.trim();
          } else if (leaderInput && leaderInput.value.trim()) {
            handle = leaderInput.value.trim();
          }

          if (handle) {
            if (infofiInput) infofiInput.value = handle;
            if (kaitoInput) kaitoInput.value = handle;

            if (typeof handleInfofiSearch === "function") {
              handleInfofiSearch();
            }
            if (typeof fetchKaitoLeaderboard === "function") {
              fetchKaitoLeaderboard();
            }
          }
        } catch (err) {
          console.error("InfoFi auto search error:", err);
        }
      }
    });
  });
});


/* ===== ì•¼í•‘ í”Œë˜ë„ˆ ë¡œì»¬ ì €ì¥ / ë Œë”ë§ ===== */
const YAP_STORAGE_KEY = "mindshare_yapping_planner_v1";
let YAPS = [];

function loadYaps(){
  try{
    const raw = localStorage.getItem(YAP_STORAGE_KEY);
    if(!raw) return;
    const parsed = JSON.parse(raw);
    if(Array.isArray(parsed)) YAPS = parsed;
  }catch(e){
    console.warn("ì•¼í•‘ í”Œë˜ë„ˆ ë¡œë“œ ì˜¤ë¥˜", e);
  }
}

function saveYaps(){
  try{
    localStorage.setItem(YAP_STORAGE_KEY, JSON.stringify(YAPS));
  }catch(e){
    console.warn("ì•¼í•‘ í”Œë˜ë„ˆ ì €ì¥ ì˜¤ë¥˜", e);
  }
}

function renderYaps(){
  const wrap = document.getElementById("yap-list");
  if(!wrap) return;
  if(!YAPS.length){
    wrap.innerHTML = '<div class="yap-list-empty">ë“±ë¡ëœ ì•¼í•‘ ê³„íšì´ ì—†ìŠµë‹ˆë‹¤. ì™¼ìª½ì—ì„œ ìƒˆ ê³„íšì„ ì¶”ê°€í•´ì¤˜.</div>';
    return;
  }
  wrap.innerHTML = "";
  YAPS.forEach((yap, idx)=>{
    const div = document.createElement("div");
    div.className = "yap-item" + (yap.done ? " done" : "");
    div.innerHTML = `
      <input type="checkbox" data-idx="${idx}" ${yap.done ? "checked" : ""}>
      <div>
        <div style="font-weight:600;font-size:12px;">
          [${yap.type}] ${yap.kor || ""}${yap.kor && yap.project ? " / " : ""}${yap.project || ""}
        </div>
        <div class="yap-tags">
          ${yap.segment ? `<span class="yap-tag">ê³„ì—´: ${yap.segment}</span>` : ""}
          ${yap.frequency ? `<span class="yap-tag">ì£¼ê¸°: ${yap.frequency}</span>` : ""}
          ${yap.reward ? `<span class="yap-tag">ë³´ìƒ: ${yap.reward}</span>` : ""}
          ${yap.start ? `<span class="yap-tag">ì‹œì‘: ${yap.start}</span>` : ""}
          ${yap.end ? `<span class="yap-tag">ì¢…ë£Œ: ${yap.end}</span>` : ""}
        </div>
        ${yap.memo ? `<div style="margin-top:4px;font-size:11px;">ë©”ëª¨: ${yap.memo}</div>` : ""}
      </div>
      <button class="yap-delete" data-del="${idx}">âœ•</button>
    `;
    wrap.appendChild(div);
  });

  wrap.querySelectorAll("input[type=checkbox]").forEach(chk=>{
    chk.addEventListener("change", e=>{
      const i = Number(e.target.dataset.idx);
      if(isNaN(i)) return;
      YAPS[i].done = !!e.target.checked;
      saveYaps();
      renderYaps();
    });
  });
  wrap.querySelectorAll(".yap-delete").forEach(btn=>{
    btn.addEventListener("click", e=>{
      const i = Number(e.target.dataset.del);
      if(isNaN(i)) return;
      YAPS.splice(i,1);
      saveYaps();
      renderYaps();
    });
  });
}

function setupYapForm(){
  const form = document.getElementById("yap-form");
  if(!form) return;
  form.addEventListener("submit", e=>{
    e.preventDefault();
    const kor   = document.getElementById("yap-kor").value.trim();
    const proj  = document.getElementById("yap-project").value.trim();
    const segment  = document.getElementById("yap-segment").value.trim();
    const type     = document.getElementById("yap-type").value;
    const freq     = document.getElementById("yap-frequency").value.trim();
    const reward   = document.getElementById("yap-reward").value.trim();
    const start    = document.getElementById("yap-start").value;
    const end      = document.getElementById("yap-end").value;
    const memo     = document.getElementById("yap-memo").value.trim();

    if(!kor && !proj){
      alert("ìµœì†Œí•œ í•œêµ­ëª… ë˜ëŠ” í”„ë¡œì íŠ¸ëª…ì€ ì…ë ¥í•´ì¤˜.");
      return;
    }

    YAPS.push({
      kor: kor,
      project: proj,
      segment,
      type,
      frequency: freq,
      reward,
      start,
      end,
      memo,
      done:false
    });
    saveYaps();
    renderYaps();
    form.reset();
  });
}

// ì´ˆê¸°í™”
loadYaps();
setupYapForm();
renderYaps();

/* ì‚¬ì´ë“œë°” ì ‘ê¸° / í¼ì¹˜ê¸° */
const layout = document.querySelector(".layout");
const sidebarToggle = document.getElementById("sidebar-toggle");
sidebarToggle.addEventListener("click", () => {
  layout.classList.toggle("collapsed");
});
</script>

<script>

// í”„ë¡œì íŠ¸ë³„ ë¡œê³  URL ë§¤í•‘ (ì›í•˜ë©´ ì—¬ê¸° URL ì±„ì›Œ ë„£ê¸°)

// í”„ë¡œì íŠ¸ë³„ X í•¸ë“¤ ë§¤í•‘ (X ì•„ë°”íƒ€ë¥¼ ë¡œê³ ë¡œ ìë™ ì‚¬ìš©)
const INFOFI_PROJECT_X_HANDLES = {
  "MemeMax": "MemeMax_Fi",
  "Symphony": "symphonyio",
  "Kaito / Yapper": "KaitoAI_Labs",
  "Orderly": "OrderlyNetwork",
  "STBL": "stbldefi",
  "Theo": "TheoNetwork",
  "Sonic (L1)": "Sonic_onSui",
  "Tria": "useTria",
  "Superform": "superformxyz",
  "Glint Analytics": "GlintAnalytics",
  "Solv Protocol": "SolvProtocol",
  "Pacifica": "pacifica_fi",
  "LayerBank": "LayerBankFi",
  "Rayls": "RaylsLabs",
  "Velora": "VeloraDEX",
  "Antix": "antix_in",
  "Almanak": "AlmanakFi",
  "BOB (Build on Bitâ€¦)": "build_on_bob",
  "TEN": "tenprotocol",
  "vooi": "vooi_io"
};

const INFOFI_PROJECT_LOGOS = {
  // ì˜ˆì‹œ) "MemeMax": "https://.../mememax-logo.png",
  //       "Symphony": "https://.../symphony-logo.png"
};

// ===== InfoFi ë¦¬ë”ë³´ë“œ ìŠ¤ëƒ…ìƒ· DB =====
const INFOFI_SNAPSHOTS = [
  {
    handle: "bud_dha__",
    project: "MemeMax",
    segment: "Creator",
    eco: "MemeMax",
    window: "7D",
    rank: 93,
    mindshare: 0.2800,
    last: 0.2700,
    firstPercent: 2.03
  },
  {
    handle: "bud_dha__",
    project: "Symphony",
    segment: "Community",
    eco: "Symphony",
    window: "30D",
    rank: 7,
    mindshare: 8.20,
    last: 0.01,
    firstPercent: 8.20
  },
  {
    handle: "bud_dha__",
    project: "Symphony",
    segment: "Community",
    eco: "Symphony",
    window: "3M",
    rank: 7,
    mindshare: 2.90,
    last: 0.06,
    firstPercent: 2.90
  },
  {
    handle: "bud_dha__",
    project: "Symphony",
    segment: "Community",
    eco: "Symphony",
    window: "6M",
    rank: 10,
    mindshare: 1.40,
    last: 0.01,
    firstPercent: 1.40
  }
  // TODO: ì—¬ê¸° ì•„ë˜ë¡œ ë‹¤ë¥¸ í•¸ë“¤/í”„ë¡œì íŠ¸ë“¤ ê³„ì† ì¶”ê°€í•˜ë©´ ë¨
];

// ===== InfoFi ë¦¬ë”ë³´ë“œ ê²€ìƒ‰ =====
function normalizeHandle(raw){
  if(!raw) return "";
  return raw.trim().replace(/^@/, "").toLowerCase();
}

function handleInfofiSearch(){
  const input = document.getElementById("infofi-handle-input");
  const label = document.getElementById("infofi-handle-label");
  const wrap  = document.getElementById("infofi-result-wrap");
  if(!input || !wrap) return;

  const h = normalizeHandle(input.value);
  if(!h){
    label.textContent = "";
    wrap.innerHTML = '<div class="infofi-empty">ë¨¼ì € @í•¸ë“¤ì„ ì…ë ¥í•´ ì¤˜.</div>';
    return;
  }

  // ê°™ì€ í•¸ë“¤ë¡œ Kaito ë¦¬ë”ë³´ë“œë„ í•¨ê»˜ ì¡°íšŒ
  if (typeof fetchKaitoLeaderboard === "function") {
    fetchKaitoLeaderboard();
  }

  const rows = INFOFI_SNAPSHOTS.filter(r => normalizeHandle(r.handle) === h);
  label.innerHTML = `ê²€ìƒ‰ í•¸ë“¤: <b>@${h}</b>`;

  // Kaito ë¦¬ë”ë³´ë“œë„ í•¨ê»˜ ì¡°íšŒ
  try {
    // kaito ì „ìš© ì…ë ¥ì€ ì œê±°ë¨
    if (kaitoInput) {
      kaitoInput.value = "@" + h;
    }
    if (typeof fetchKaitoLeaderboard === "function") {
      fetchKaitoLeaderboard();
    }
  } catch (e) {
    console.error("Kaito auto fetch error:", e);
  }


  if(!rows.length){
    wrap.innerHTML = '';
    return;
  }

  // í”„ë¡œì íŠ¸/ì—ì½” ê¸°ì¤€ìœ¼ë¡œ ê·¸ë£¹í•‘
  const groups = {};
  rows.forEach(r => {
    const key = (r.eco || r.project) + "|" + r.segment;
    if(!groups[key]){
      groups[key] = {
        project: r.project,
        eco: r.eco || "",
        segment: r.segment || "",
        rows: []
      };
    }
    groups[key].rows.push(r);
  });

  
  
  let html = "";
  Object.values(groups).forEach(g => {
    // ê¸°ê°„ ì •ë ¬
    g.rows.sort((a,b)=>{
      const order = ["24H","7D","30D","90D","3M","6M","1Y"];
      const ia = order.indexOf(a.window);
      const ib = order.indexOf(b.window);
      return (ia === -1 ? 999 : ia) - (ib === -1 ? 999 : ib);
    });

    // ê° ê¸°ê°„ë³„ í–‰ HTML
    let rowsHtml = "";
    g.rows.forEach(r => {
      const win = r.window || "";
      const rank = r.rank != null ? r.rank : "";
      const ms = (r.mindshare ?? 0).toFixed(4);
      const last = (r.last ?? 0).toFixed(4);
      const firstP = (r.firstPercent ?? 0).toFixed(4);

      rowsHtml += '<tr>'
        + '<td>' + win + '</td>'
        + '<td>#' + rank + '</td>'
        + '<td>' + ms + '%</td>'
        + '<td>' + last + '%</td>'
        + '<td>' + firstP + '%</td>'
        + '</tr>';
    });

    const eco = g.eco || "";
    const seg = g.segment || "";
    const metaText = eco + (eco && seg ? " Â· " : "") + seg;

    // ë¡œê³ : ìš°ì„  ìˆœìœ„
    // 1) INFOFI_PROJECT_LOGOSì— ì§ì ‘ ì§€ì •ëœ URL
    // 2) INFOFI_PROJECT_X_HANDLESì— ë“±ë¡ëœ X í•¸ë“¤ì˜ ì•„ë°”íƒ€ (unavatar.io)
    // 3) ë‘˜ ë‹¤ ì—†ìœ¼ë©´ í”„ë¡œì íŠ¸ ì´ë¦„ ì´ë‹ˆì…œ ì›í˜• ë±ƒì§€
    const xHandles = (typeof INFOFI_PROJECT_X_HANDLES === "object") ? INFOFI_PROJECT_X_HANDLES : {};
    const logos = (typeof INFOFI_PROJECT_LOGOS === "object") ? INFOFI_PROJECT_LOGOS : {};
    const xHandle = xHandles[g.project] || "";
    let logoUrl = logos[g.project] || "";
    if (!logoUrl && xHandle) {
      logoUrl = "https://unavatar.io/twitter/" + encodeURIComponent(xHandle);
    }
    const initial = (g.project || "?").charAt(0).toUpperCase();
    let logoHtml = "";
    if (logoUrl) {
      logoHtml = '<div class="infofi-logo"><img src="' + logoUrl + '" alt="' + g.project + ' logo"></div>';
    } else {
      logoHtml = '<div class="infofi-logo">' + initial + '</div>';
    }

    html += ''
      + '<div class="infofi-project-card">'
        + '<div class="infofi-project-header">'
          + '<div class="infofi-header-left">'
            + logoHtml
            + '<div class="infofi-project-main">'
              + '<div class="infofi-project-name">' + g.project + '</div>'
              + '<div class="infofi-project-meta">' + metaText + '</div>'
            + '</div>'
          + '</div>'
          + '<div class="infofi-badge">í”„ë¡œì íŠ¸ ë¦¬ë”ë³´ë“œ ìŠ¤ëƒ…ìƒ·</div>'
        + '</div>'
        + '<div class="infofi-table-wrap">'
          + '<table class="infofi-table">'
            + '<thead>'
              + '<tr>'
                + '<th>ê¸°ê°„</th>'
                + '<th>Rank</th>'
                + '<th>Mindshare</th>'
                + '<th>ë§ˆì§€ë§‰ ìŠ¤ëƒ…ìƒ·</th>'
                + '<th>1ìœ„ ëŒ€ë¹„</th>'
              + '</tr>'
            + '</thead>'
            + '<tbody>'
              + rowsHtml +
            '</tbody>'
          + '</table>'
        + '</div>'
      + '</div>';
  });

  wrap.innerHTML = html;


}

// Enter í‚¤ë¡œ ê²€ìƒ‰
document.addEventListener("DOMContentLoaded", ()=>{
  const input = document.getElementById("infofi-handle-input");
  if(input){
    input.addEventListener("keydown", e=>{
      if(e.key === "Enter"){
        e.preventDefault();
        handleInfofiSearch();
      }
    });
  }
});
</script>

  

  <script>
    const KAITOPROXY_URL = "https://ejqrnapdwblbqvnperid.supabase.co/functions/v1/kaito-proxy";

    const KAITO_TOPIC_TWITTER_HANDLES = {
  "Aptos": "Aptos",
  "Beldex": "BeldexCoin",
  "Berachain": "berachain",
  "Camp Network": "campnetworkxyz",
  "Ethereum": "ethereum",
  "Fogo": "fogo",
  "Injective": "injective",
  "Irys": "irys_xyz",
  "Kaia": "KaiaChain",
  "MANTRA": "MANTRA_Chain",
  "Mavryk": "MavrykNetwork",
  "Mitosis": "MitosisOrg",
  "Monad": "monad",
  "Movement": "movementlabsxyz",
  "Near": "NEARProtocol",
  "PEAQ": "peaq",
  "Polkadot": "Polkadot",
  "Sei": "SeiNetwork",
  "Somnia": "Somnia_Network",
  "Sonic": "SonicLabs",
  "S": "SonicLabs",
  "Story": "StoryProtocol",
  "XION": "burnt_xion",
  "CreatorBid": "CreatorBid",
  "INFINIT": "Infinit_Labs",
  "Newton": "MagicNewton",
  "Surf": "SurfAI",
  "Symphony": "symphonyio",
  "Talus": "Talus_Labs",
  "Theoriq": "TheoriqAI",
  "Virtuals Protocol": "virtuals_io",
  "Warden Protocol": "wardenprotocol",
  "Wayfinder": "AIWayfinder",
  "ANIME": "animecoin",
  "Boop": "boopdotfun",
  "Doodles": "doodles",
  "MemeX": "MemeX_MRC20",
  "Moonbirds": "moonbirds",
  "PENGU": "pudgypenguins",
  "Corn": "use_corn",
  "GOAT Network": "GOATRollup",
  "Lombard": "Lombard_Finance",
  "Portal to BTC": "PortaltoBitcoin",
  "SatLayer": "satlayer",
  "Openmind": "openmind_agi",
  "Arbitrum": "arbitrum",
  "Katana": "katana",
  "Mantle": "0xMantle",
  "MegaETH": "megaeth",
  "Polygon": "0xPolygon",
  "SOON": "soon_svm",
  "Falcon Finance": "FalconStable",
  "Frax": "fraxfinance",
  "Huma": "humafinance",
  "MoreMarkets": "moremarketsxyz",
  "Multipli": "multiplifi",
  "Noble": "noble_xyz",
  "Orderly": "OrderlyNetwork",
  "Pyth": "PythNetwork",
  "Soul Protocol": "0xSoulProtocol",
  "STBL": "stbl_official",
  "Turtle Club": "turtleclubhouse",
  "Walrus": "WalrusProtocol",
  "Boundless": "boundless_xyz",
  "Brevis": "brevis_zk",
  "Cysic": "cysic_xyz",
  "Miden": "0xMiden",
  "Starknet": "Starknet",
  "Succinct": "SuccinctLabs",
  "Zcash": "Zcash",
  "zkPass": "zkPass",
  "Anoma": "anoma",
  "Bless": "theblessnetwork",
  "Bybit TradFi": "Bybit_Official",
  "Humanity Protocol": "Humanityprot",
  "Integra": "integra_layer",
  "Multibank": "multibank_io",
  "Thrive Protocol": "thriveprotocol",
  "ApeX": "OfficialApeXdex",
  "Bluefin": "bluefinapp",
  "dYdX": "dYdX",
  "Flipster": "flipster_io",
  "MemeMax": "MemeMax_Fi",
  "Momentum": "MMTFinance",
  "PARADEX": "paradex",
  "Kaito": "KaitoAI",
  "OG": "0G_labs",
  "Allora": "AlloraNetwork",
  "Billions Network": "billions_ntwk",
  "Edgen": "EdgenTech",
  "EverlynAI": "everlyn_ai",
  "IQ": "IQAIcom",
  "Kindred": "Kindred_AI",
  "Mira Network": "miranetwork",
  "Novastro": "Novastro_xyz",
  "NYT": "Novastro_xyz",
  "Noya.ai": "NetworkNoya",
  "OpenLedger": "OpenledgerHQ",
  "PiP World": "pip_world",
  "PlayAI": "playAInetwork",
  "Sapien": "JoinSapien",
  "Sentient": "SentientAGI",
  "UXLINK": "UXLINKofficial",
  "Tria": "useTria",
  "Anichess": "AnichessGame",
  "Bitdealer": "bitdealernet",
  "Defi App": "defiapp",
  "Hana": "HanaNetwork",
  "InfineX": "infinex",
  "Lumiterra": "LumiterraGame",
  "MapleStory Universe": "MaplestoryU",
  "Metawin": "MetaWin",
  "Parti": "jointheparti",
  "Puffpaw": "puffpaw",
  "Rainbow": "rainbowdotme",
  "Sidekick": "Sidekick_Labs",
  "SIXR Cricket": "SIXR_cricket",
  "Sophon": "Sophon",
  "Vultisig": "vultisig",
  "YEET": "yeet",
  "Caldera": "Calderaxyz",
  "Initia": "initia",
  "Skate": "skate_chain",
  "Union": "union_build",
  "KAIO": "KAIO_xyz",
  "Theo": "Theo_Network",
  "THEOTHEO": "Theo_Network"
};


async function fetchKaitoLeaderboard() {
  const input = document.getElementById("infofi-handle-input");
  const resultDiv = document.getElementById("kaito-result");

  if (!input || !resultDiv) {
    alert("ì…ë ¥ ì¹¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  let handle = (input.value || "").trim();
  if (!handle) {
    if (resultDiv) resultDiv.textContent = "";
    return;
  }
  if (handle.startsWith("@")) {
    handle = handle.slice(1);
  }

  resultDiv.textContent = "ê³°íˆ¬(Kaito)ì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";

  try {
    const resp = await fetch(
      KAITOPROXY_URL + "?username=" + encodeURIComponent(handle),
      { method: "GET" }
    );

    if (!resp.ok) {
      resultDiv.textContent = "í”„ë¡ì‹œ ì‘ë‹µ ì˜¤ë¥˜: " + resp.status;
      return;
    }

    const json = await resp.json();
    console.log("Kaito proxy raw:", json);

    if (!json || !Array.isArray(json.data) || json.data.length === 0) {
      resultDiv.textContent = "ë¦¬ë”ë³´ë“œ ë°ì´í„°ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
      return;
    }

    // 7D / 30D / 3M ë§Œ ì‚¬ìš©, topic_id ë³„ë¡œ ê·¸ë£¹í•‘
    const allowed = ["7D", "30D", "3M"];
    const byTopic = {};
    json.data.forEach(item => {
      const dur = item.duration;
      if (!allowed.includes(dur)) return;
      const topic = item.topic_id || "UNKNOWN";
      if (!byTopic[topic]) byTopic[topic] = [];
      byTopic[topic].push(item);
    });

    const topicNames = Object.keys(byTopic);
    if (!topicNames.length) {
      resultDiv.textContent = "7D / 30D / 3M ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
      return;
    }

    // topic ì´ë¦„ ëŒ€ì†Œë¬¸ì ë¬´ì‹œí•˜ê³  ë§¤í•‘ ì°¾ê¸°
    function findHandleForTopic(topic) {
      const t = (topic || "").toLowerCase();
      for (const key in KAITO_TOPIC_TWITTER_HANDLES) {
        if (key.toLowerCase() === t) return KAITO_TOPIC_TWITTER_HANDLES[key];
      }
      return "";
    }

    const durationOrder = ["7D", "30D", "3M"];
    function durationIndex(d) {
      const i = durationOrder.indexOf(d);
      return i === -1 ? 999 : i;
    }
    function rankValue(r) {
      if (typeof r === "number") return r;
      const n = parseInt(r, 10);
      return isNaN(n) ? 999999 : n;
    }

    
  const PROJECT_DISPLAY_NAME_OVERRIDES = {
  "S": "Sonic",
  "THEOTHEO": "Theo",
  "NYT": "Novastro"
};

const cardsHtml = topicNames.map(topic => {
      const displayTopic = PROJECT_DISPLAY_NAME_OVERRIDES[topic] || topic;
      const rows = byTopic[topic].slice().sort((a, b) => {
        const d = durationIndex(a.duration) - durationIndex(b.duration);
        if (d !== 0) return d;
        return rankValue(a.rank) - rankValue(b.rank);
      });

      const topicHandle = findHandleForTopic(topic);
      let logoUrl = "";
      if (topicHandle) {
        logoUrl = "https://unavatar.io/twitter/" + encodeURIComponent(topicHandle);
      }

      const initial = (topic || "?").charAt(0).toUpperCase();
      const logoHtml = logoUrl
        ? '<div style="width:32px;height:32px;border-radius:50%;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#111827;margin-right:10px;"><img src="'
          + logoUrl
          + '" alt="' + topic + ' logo" style="width:100%;height:100%;object-fit:cover;"></div>'
        : '<div style="width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#0f172a;color:#e5e7eb;font-size:14px;font-weight:700;margin-right:10px;">'
          + initial
          + '</div>';

      const rowsHtml = rows.map(item => {
        const dur = item.duration || "-";
        const rank = item.rank ?? "-";
        const rawTier = item.tier || "-";
        const tier = (rawTier.toLowerCase() === "tier2") ? "Wider Community"
                    : (rawTier.toLowerCase() === "tier1") ? "Creator"
                    : rawTier;
        const mindshare = item.mindshare ?? "-";
        return `
          <tr>
            <td style="padding:6px 8px;border-bottom:1px solid rgba(55,65,81,0.7);text-align:center;">${dur}</td>
            <td style="padding:6px 8px;border-bottom:1px solid rgba(55,65,81,0.7);text-align:center;">#${rank}</td>
            <td style="padding:6px 8px;border-bottom:1px solid rgba(55,65,81,0.7);text-align:center;">${tier}</td>
            <td style="padding:6px 8px;border-bottom:1px solid rgba(55,65,81,0.7);text-align:right;">${mindshare}</td>
          </tr>
        `;
      }).join("");

      return `
        <div style="
          margin-top:10px;
          padding:14px 16px;
          border-radius:16px;
          background:rgba(15,23,42,0.9);
          border:1px solid rgba(148,163,184,0.45);
          font-size:13px;
          line-height:1.6;
          color:#e5e7eb;
        ">
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
            <div style="display:flex;align-items:center;">
              ${logoHtml}
              <div>
                <div style="font-weight:700;font-size:13px;">${displayTopic}</div>
                <div style="font-size:12px;opacity:0.8;">@${handle}</div>
              </div>
            </div>
          </div>
          <div style="border-radius:12px;overflow:hidden;border:1px solid rgba(55,65,81,0.9);">
            <table style="width:100%;border-collapse:collapse;font-size:12px;">
              <thead>
                <tr style="background:rgba(31,41,55,0.95);">
                  <th style="padding:6px 8px;border-bottom:1px solid rgba(55,65,81,1);text-align:center;">ê¸°ê°„</th>
                  <th style="padding:6px 8px;border-bottom:1px solid rgba(55,65,81,1);text-align:center;">Rank</th>
                  <th style="padding:6px 8px;border-bottom:1px solid rgba(55,65,81,1);text-align:center;">Tier</th>
                  <th style="padding:6px 8px;border-bottom:1px solid rgba(55,65,81,1);text-align:right;">Mindshare</th>
                </tr>
              </thead>
              <tbody>
                ${rowsHtml}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }).join("");

    resultDiv.innerHTML = cardsHtml;
  } catch (err) {
    console.error(err);
    resultDiv.textContent = "ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
  }
}


// ì—”í„°ë¡œë„ ì¡°íšŒ
    window.addEventListener("DOMContentLoaded", function () {
      const input = document.getElementById("kaito-handle-input");
      if (input) {
        input.addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            fetchKaitoLeaderboard();
          }
        });
      }
    });
  

/* ========== "ë§ˆì§€ë§‰ CSVë¡œ ì¡°íšŒí•˜ê¸°" ë²„íŠ¼ ========== */
document.addEventListener("DOMContentLoaded", () => {
  const btn = document.getElementById("btn-last-csv");
  updateLastSnapshotUI();
  if (!btn) return;
  btn.addEventListener("click", (e) => {
    e.preventDefault();
    restoreLastAnalysis();
  });
});
</script>

<script>
(function(){
  const PROFILE_KEY = "mindshare_profile_v1";

  function loadProfile(){
    try{
      const raw = localStorage.getItem(PROFILE_KEY);
      if(!raw) return { nickname: "ê²ŒìŠ¤íŠ¸", handle: "" };
      const obj = JSON.parse(raw);
      if(!obj || typeof obj !== "object") return { nickname: "ê²ŒìŠ¤íŠ¸", handle: "" };
      return {
        nickname: obj.nickname || "ê²ŒìŠ¤íŠ¸",
        handle: (obj.handle || "").replace(/^@/,"")
      };
    }catch(e){
      return { nickname: "ê²ŒìŠ¤íŠ¸", handle: "" };
    }
  }

  function saveProfile(p){
    try{
      localStorage.setItem(PROFILE_KEY, JSON.stringify({
        nickname: p.nickname || "ê²ŒìŠ¤íŠ¸",
        handle: (p.handle || "").replace(/^@/,"")
      }));
    }catch(e){
      console.warn("Failed to save profile", e);
    }
  }

  function applyProfile(){
    const p = loadProfile();
    const nameEl   = document.getElementById("side-username");
    const linkEl   = document.getElementById("side-handle-link");
    const avatarEl = document.getElementById("side-avatar-img");

    if(nameEl){
      nameEl.textContent = p.nickname || "ê²ŒìŠ¤íŠ¸";
    }

    if(linkEl){
      const handle = (p.handle || "").replace(/^@/,"");
      if(handle){
        linkEl.textContent = "@" + handle;
        linkEl.href = "https://twitter.com/" + handle;
      }else{
        linkEl.textContent = "@ìµëª…";
        linkEl.href = "https://twitter.com";
      }
    }

    if(avatarEl){
      const handle = (p.handle || "").replace(/^@/,"");
      if(handle){
        avatarEl.src = "https://unavatar.io/twitter/" + encodeURIComponent(handle);
      }else{
        avatarEl.src = "https://unavatar.io/twitter/bud_dha__";
      }
    }
  }

  function openProfilePrompt(){
    const current = loadProfile();
    const nick = window.prompt("ëŒ€ì‹œë³´ë“œì— í‘œì‹œí•  ë‹‰ë„¤ì„ì„ ì ì–´ì¤˜ (ì˜ˆ: MUDDHA, buddha ë“±)", current.nickname || "");
    if(nick === null) return; // ì·¨ì†Œ
    const trimmedNick = nick.trim();

    const handle = window.prompt("ë¶„ì„í•  X í•¸ë“¤ì„ ì ì–´ì¤˜ (@ ì—†ì´, ì˜ˆ: bud_dha__ )\nê±´ë„ˆë›°ê³  ì‹¶ìœ¼ë©´ ê·¸ëƒ¥ ë¹ˆì¹¸ìœ¼ë¡œ ë‘ê³  í™•ì¸ ëˆŒëŸ¬.", current.handle || "");
    if(handle === null) return; // ì·¨ì†Œ ìœ ì§€
    const cleanHandle = (handle || "").trim().replace(/^@/,"");

    const profile = {
      nickname: trimmedNick || "ê²ŒìŠ¤íŠ¸",
      handle: cleanHandle
    };
    saveProfile(profile);
    applyProfile();
  }

  function ensureNickname(){
    const p = loadProfile();
    if(p.nickname && p.nickname !== "ê²ŒìŠ¤íŠ¸"){
      return p;
    }
    const ok = window.confirm("ìµëª… ë‹‰ë„¤ì„ì„ ë¨¼ì € ì„¤ì •í• ë˜? (íˆìŠ¤í† ë¦¬/ë¦¬ë”ë³´ë“œ ì €ì¥ì— ì‚¬ìš©ë¼)");
    if(!ok) return p;
    openProfilePrompt();
    return loadProfile();
  }

  // ì „ì—­ì—ì„œ ì“¸ ìˆ˜ ìˆê²Œ ë…¸ì¶œ (í•„ìš”í•˜ë©´ ë‹¤ë¥¸ í•¨ìˆ˜ì—ì„œ ì‚¬ìš©)
  window.mindshareProfile = {
    load: loadProfile,
    save: saveProfile,
    apply: applyProfile,
    ensure: ensureNickname,
    openPrompt: openProfilePrompt
  };

  document.addEventListener("DOMContentLoaded", function(){
    applyProfile();

    const btn = document.getElementById("nickname-btn");
    if(btn){
      btn.addEventListener("click", function(e){
        e.preventDefault();
        openProfilePrompt();
      });
    }

    // ë¦¬ë”ë³´ë“œ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ, ë‹‰ë„¤ì„ ë¨¼ì € ìœ ë„
    const leaderSaveBtn = document.getElementById("leader-save-btn");
    if(leaderSaveBtn){
      leaderSaveBtn.addEventListener("click", function(){
        ensureNickname();
      }, { capture: true });
    }
  });
})();
</script>

<script>
document.addEventListener("DOMContentLoaded", function(){
  const csvInput = document.getElementById("csvInput");
  if(!csvInput) return;
  csvInput.addEventListener("change", function(e){
    const file = e.target.files[0];
    if(!file) return;
    const fr = new FileReader();
    fr.onload = function(ev){
      const csvText = ev.target.result || "";
      const subEl = document.getElementById("csv-server-top5-sub");
      const bodyEl = document.getElementById("csv-server-top5-body");
      if(subEl) subEl.textContent = "ì„œë²„ë¡œ ë¶„ì„ ìš”ì²­ ì¤‘...";
      if(bodyEl) bodyEl.innerHTML = "<div class='empty'>ìš”ì²­ ì¤‘...</div>";
      // load profile
      let nickname="ê²ŒìŠ¤íŠ¸", handle="";
      try{
        if(window.mindshareProfile){
          const p=window.mindshareProfile.load();
          nickname=p.nickname||nickname;
          handle=(p.handle||"").replace(/^@/,"");
        }
      }catch(e){}
      fetch("http://localhost:4000/analyze-csv", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ csvText, nickname, handle })
      })
      .then(r=>r.json().catch(()=>({})))
      .then(data=>{
        let root=data;
        if(root && root.result) root=root.result;
        let top5=[];
        if(root){
          if(Array.isArray(root.top5)) top5=root.top5;
          if(!top5.length && root.projects){
            top5=Object.entries(root.projects)
              .sort((a,b)=>b[1]-a[1])
              .slice(0,5)
              .map(([name,count])=>({name,count}));
          }
          if(!top5.length && root.projectCounts){
            top5=Object.entries(root.projectCounts)
              .sort((a,b)=>b[1]-a[1])
              .slice(0,5)
              .map(([name,count])=>({name,count}));
          }
        }
        if(!top5.length){
          if(subEl) subEl.textContent="ì„œë²„ì—ì„œ Top5ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
          if(bodyEl) bodyEl.textContent="ì‘ë‹µ: "+JSON.stringify(data);
          return;
        }
        if(subEl) subEl.textContent="ì„œë²„ ê¸°ì¤€ Top5 ê²°ê³¼";
        if(bodyEl){
          bodyEl.innerHTML = top5.map(item=>
            "<div>"+item.name+" â€” "+item.count+"</div>"
          ).join("");
        }
      })
      .catch(err=>{
        if(subEl) subEl.textContent="ì„œë²„ í†µì‹  ì˜¤ë¥˜";
        if(bodyEl) bodyEl.textContent=err;
      });
    };
    fr.readAsText(file);
  });
});
</script>

</body>
</html>
